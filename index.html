<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>SkillTree</title>
<meta name="application-name" content="SkillTree">
<meta name="description" content="Level up your learning!">
<meta name="theme-color" content="#9060c0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SkillTree">
<link id="pwaManifest" rel="manifest" href="#">
<link id="appleTouchIcon" rel="apple-touch-icon" href="#">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {

/* Language realm colors */
--fr:#e8a87c;--fr-bg:#fff8f2;--fr-border:#f7cfa8;--fr-light:#fdecd8;--fr-dark:#c4683a;
--es:#7cc4e8;--es-bg:#f0f8ff;--es-border:#a8d8f7;--es-light:#d8eefa;--es-dark:#3a80c4;
/* Math & Science realm colors */
--m:#5bcca0;--m-bg:#f0fbf6;--m-border:#a8e6ce;--m-light:#d8f4e8;--m-dark:#3aaa80;
--sc:#b48ee8;--sc-bg:#f7f3ff;--sc-border:#d8c4f7;--sc-light:#ede4fb;--sc-dark:#9b6fd4;
  --cream:#fdf6ff;--cream2:#f8f0ff;
  --r:#f0a8c8;--r-bg:#fff0f7;--r-border:#f7cce0;--r-light:#fde4f0;--r-dark:#d4709a;
  --w:#a8c8f0;--w-bg:#f0f6ff;--w-border:#c4d8f7;--w-light:#dceafc;--w-dark:#6a9edc;
  --soft-pink:#fde8f2;--soft-blue:#e8f0fe;--soft-green:#e8f9f2;--soft-yellow:#fef9e3;--soft-purple:#f3eeff;--soft-teal:#e6faf8;
  --text-dark:#3d2d45;--text-mid:#7a6b80;--text-light:#b0a0b8;
  --dim:#b0a0b8;--muted:#c8b8d0;
  --surface:rgba(255,255,255,.8);--border:rgba(180,120,200,.1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text-dark);min-height:100vh;min-height:100dvh;overflow:hidden;}
.app{width:100%;min-height:100vh;min-height:100dvh;position:relative;overflow:hidden;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .3s,transform .35s cubic-bezier(.4,0,.2,1);transform:translateX(28px);}
.screen.active{opacity:1;pointer-events:all;transform:translateX(0);}
.screen.exit{transform:translateX(-28px);opacity:0;}

#worldMap{background:linear-gradient(180deg,#f0d8ff 0%,#d8eaff 35%,#d8f4f0 70%,#e8f8ec 100%);}
#worldMap::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background-image:radial-gradient(ellipse 70px 30px at 15% 18%,rgba(255,255,255,.55),transparent),radial-gradient(ellipse 45px 22px at 25% 15%,rgba(255,255,255,.45),transparent),radial-gradient(ellipse 80px 35px at 75% 12%,rgba(255,255,255,.5),transparent),radial-gradient(ellipse 50px 20px at 55% 8%,rgba(255,255,255,.4),transparent),radial-gradient(3px 3px at 8% 10%,rgba(255,180,220,.9),transparent),radial-gradient(3px 3px at 68% 5%,rgba(180,210,255,.9),transparent);}
#worldMap::after{content:'';position:absolute;bottom:0;left:0;right:0;height:120px;pointer-events:none;z-index:0;background:radial-gradient(ellipse 200% 110px at 10% 100%,#b8e8c8,transparent 60%),radial-gradient(ellipse 160% 100px at 55% 100%,#a8e0bc,transparent 55%),radial-gradient(ellipse 130% 90px at 90% 100%,#b0ecd0,transparent 60%);}
#worldMap .map-header{position:relative;z-index:2;display:flex;align-items:center;justify-content:space-between;padding:18px 20px 12px;}
#worldMap .map-logo{font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;color:#6a4a7a;text-shadow:0 2px 0 rgba(255,255,255,.4);}
#worldMap .map-logo span{color:#d070a0;}
#worldMap .player-chip{background:rgba(255,255,255,.7);border:2px solid rgba(220,180,240,.5);}
#worldMap .player-chip:hover{background:rgba(255,255,255,.9);}
#worldMap .p-name{color:#5a3a6a;}
#worldMap .p-level{color:#9a7aaa;}
#worldMap .xp-strip{background:rgba(255,255,255,.65);border:2px solid rgba(220,180,240,.4);}
#worldMap .xp-strip-lbl{color:#9a7aaa;}
#worldMap .xp-track{background:rgba(180,140,200,.15);border:1.5px solid rgba(220,180,240,.3);}
#worldMap .xp-fill-bar{background:linear-gradient(90deg,#f0a8c8,#c878a8);box-shadow:0 0 8px rgba(200,120,168,.4);}
#worldMap .xp-val{color:#c060a0;}
#worldMap .streak-chip{background:rgba(255,180,160,.25);border:2px solid rgba(255,160,140,.4);color:#d07060;}
#worldMap .gem-chip{background:rgba(180,140,240,.2);border:2px solid rgba(180,140,240,.4);color:#9060c0;}
#worldMap .realm-node.reading .realm-bubble{background:radial-gradient(circle at 30% 30%,#ffd8e8,#f0a8c8);box-shadow:0 0 0 5px rgba(255,255,255,.5),0 0 30px rgba(240,168,200,.4),0 8px 24px rgba(0,0,0,.12);border:3px solid rgba(255,255,255,.8);}
#worldMap .realm-node.writing .realm-bubble{background:radial-gradient(circle at 30% 30%,#c8e0ff,#a8c8f0);box-shadow:0 0 0 5px rgba(255,255,255,.5),0 0 30px rgba(168,200,240,.4),0 8px 24px rgba(0,0,0,.12);border:3px solid rgba(255,255,255,.8);}
#worldMap .realm-node.locked .realm-bubble{background:radial-gradient(circle at 30% 30%,#ede0f5,#d8c8e8);box-shadow:0 4px 14px rgba(0,0,0,.08);border:3px solid rgba(255,255,255,.5);}
#worldMap .realm-node.reading .realm-bubble::before{color:rgba(253,230,138,.7);}
#worldMap .realm-node.writing .realm-bubble::before{color:rgba(165,243,252,.7);}
#worldMap .lock-icon{background:#c8b0d8;border:2px solid #d8c8e8;}
#worldMap .realm-name{color:#5a3a6a;text-shadow:0 1px 3px rgba(255,255,255,.6);}
#worldMap .realm-node.locked .realm-name{color:#a090b0;text-shadow:none;}
#worldMap .realm-node.reading .realm-sub{color:#8a3060;background:#fde8f2;border-color:#f0a8c8;}
#worldMap .realm-node.writing .realm-sub{color:#304880;background:#dceafc;border-color:#a8c8f0;}
#worldMap .realm-node.locked .realm-sub{color:#a090b0;background:rgba(255,255,255,.4);border-color:rgba(200,180,220,.3);}

.map-header{position:relative;z-index:2;display:flex;align-items:center;justify-content:space-between;padding:18px 20px 10px;}
.map-logo{font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;color:#6a4a7a;}
.map-logo span{color:#d070a0;}
.player-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.85);border:2px solid rgba(220,180,240,.3);border-radius:30px;padding:5px 12px 5px 5px;cursor:pointer;backdrop-filter:blur(8px);transition:background .15s;box-shadow:0 2px 12px rgba(180,120,200,.1);}
.player-chip:hover{background:#fff;}
.p-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#ffd8e8,#f0a8c8);display:flex;align-items:center;justify-content:center;font-size:17px;border:2px solid rgba(255,255,255,.9);}
.p-name{font-size:12px;font-weight:800;color:#5a3a6a;}
.p-level{font-size:10px;color:#9a7aaa;font-weight:700;}

.xp-strip{position:relative;z-index:2;margin:0 16px 6px;background:rgba(255,255,255,.8);border:2px solid rgba(220,180,240,.25);border-radius:30px;padding:7px 12px;display:flex;align-items:center;gap:8px;backdrop-filter:blur(8px);box-shadow:0 2px 10px rgba(180,120,200,.08);}
.xp-strip-lbl{font-size:11px;color:#9a7aaa;font-weight:700;white-space:nowrap;}
.xp-track{flex:1;height:8px;background:rgba(200,160,220,.15);border-radius:10px;overflow:hidden;}
.xp-fill-bar{height:100%;background:linear-gradient(90deg,#f0a8c8,#c878a8);border-radius:10px;transition:width .5s;}
.xp-val{font-size:11px;font-weight:800;color:#c060a0;white-space:nowrap;}
.streak-chip{display:flex;align-items:center;gap:4px;background:#fff0f0;border:2px solid #ffd0c8;border-radius:20px;padding:3px 9px;font-size:11px;font-weight:800;color:#d07070;white-space:nowrap;cursor:pointer;}
.gem-chip{display:flex;align-items:center;gap:3px;background:#f0eaff;border:2px solid #d8c4f8;border-radius:20px;padding:3px 9px;font-size:11px;font-weight:800;color:#9060c0;white-space:nowrap;}

.map-path-area{position:relative;z-index:1;flex:1;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;align-items:center;padding:10px 20px 80px;scrollbar-width:none;}
.map-path-area::-webkit-scrollbar{display:none;}
.realm-row{position:relative;z-index:2;width:100%;display:flex;justify-content:center;margin:20px 0;}
.realm-node{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:transform .2s;user-select:none;}
.realm-node:hover{transform:scale(1.07) translateY(-3px);}
.realm-node:active{transform:scale(.97);}
.realm-node.locked{cursor:default;opacity:.45;}
.realm-node.locked:hover{transform:none;}
.realm-bubble{width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:38px;position:relative;}
.realm-node.reading .realm-bubble{background:radial-gradient(circle at 30% 30%,#ffd8ec,#f0a8c8);box-shadow:0 0 0 6px rgba(240,168,200,.2),0 8px 28px rgba(240,168,200,.3);animation:float1 3.5s ease-in-out infinite;border:3px solid rgba(255,255,255,.9);}
.realm-node.writing .realm-bubble{background:radial-gradient(circle at 30% 30%,#d8e8ff,#a8c8f0);box-shadow:0 0 0 6px rgba(168,200,240,.2),0 8px 28px rgba(168,200,240,.3);animation:float2 4s ease-in-out infinite;border:3px solid rgba(255,255,255,.9);}
.realm-node.locked .realm-bubble{background:radial-gradient(circle at 30% 30%,#ede0f5,#d8c8e8);box-shadow:0 4px 14px rgba(0,0,0,.07);border:3px solid rgba(255,255,255,.8);}
.realm-bubble::before{content:'';position:absolute;inset:-10px;border-radius:50%;border:3px solid currentColor;animation:pulseRing 2.5s ease-out infinite;opacity:0;}
.realm-node.reading .realm-bubble::before{color:rgba(240,168,200,.5);}
.realm-node.writing .realm-bubble::before{color:rgba(168,200,240,.5);}
.realm-node.locked .realm-bubble::before{display:none;}
.lock-icon{position:absolute;bottom:-4px;right:-4px;width:26px;height:26px;background:#e8d8f0;border:2px solid #d8c8e8;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;}
.new-badge{position:absolute;top:-6px;right:-6px;background:#f0a8c8;color:#fff;font-size:9px;font-weight:800;padding:3px 7px;border-radius:20px;border:2px solid white;animation:badgeBounce 1s ease infinite;}
.realm-name{font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;color:#5a3a6a;margin-bottom:2px;text-align:center;}
.realm-node.locked .realm-name{color:#b090c0;}
.realm-sub{font-size:10px;font-weight:800;border-radius:20px;padding:3px 10px;border:2px solid;}
.realm-node.reading .realm-sub{color:#8a3060;background:#fde8f2;border-color:#f0a8c8;}
.realm-node.writing .realm-sub{color:#304880;background:#dceafc;border-color:#a8c8f0;}
.realm-node.locked .realm-sub{color:#b090c0;background:rgba(255,255,255,.5);border-color:rgba(200,180,220,.3);}

.map-panel{position:fixed;top:0;bottom:0;left:0;right:0;z-index:50;overflow-y:auto;padding:20px 20px 90px;background:linear-gradient(180deg,#f0d8ff 0%,#dce8ff 100%);transform:translateX(100%);transition:transform .32s cubic-bezier(.4,0,.2,1);pointer-events:none;visibility:hidden;}
.map-panel.show{transform:translateX(0);pointer-events:all;visibility:visible;}
.map-panel-header{display:flex;align-items:center;gap:12px;margin-bottom:18px;margin-top:8px;}
.map-panel-back{width:38px;height:38px;border-radius:12px;border:none;background:rgba(255,255,255,.4);color:#6a4a7a;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s;flex-shrink:0;}
.map-panel-back:hover{background:rgba(255,255,255,.6);}
.map-panel-title{font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;color:#5a3a6a;}
.map-bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border-top:2px solid rgba(220,180,240,.25);display:flex;}
.map-nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px 14px;border:none;background:none;cursor:pointer;color:#c0a8d0;font-size:10px;font-weight:800;font-family:'Nunito',sans-serif;transition:color .15s;}
.map-nav-btn .ico{font-size:22px;}
.map-nav-btn.active{color:#c060a0;}

#readingScreen{background:linear-gradient(180deg,#fff0f7 0%,#fde8f4 100%);color:var(--text-dark);}
#writingScreen{background:linear-gradient(180deg,#f0f6ff 0%,#e4eeff 100%);color:var(--text-dark);}
.mod-header{display:flex;align-items:center;gap:12px;padding:18px 20px 14px;border-bottom:2px solid rgba(220,180,240,.12);background:rgba(255,255,255,.7);}
.back-btn{width:38px;height:38px;border-radius:12px;border:none;background:rgba(220,180,240,.15);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s;color:#9a6aaa;}
.back-btn:hover{background:rgba(220,180,240,.28);}
.mod-title-group{flex:1;}
.mod-realm-lbl{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#b090c0;margin-bottom:1px;}
.mod-title{font-family:'Fredoka',sans-serif;font-size:21px;font-weight:700;color:#5a3a6a;}
.mod-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;}
.ri{background:linear-gradient(135deg,#ffd8ec,#f0a8c8);box-shadow:0 3px 10px rgba(240,168,200,.3);}
.wi{background:linear-gradient(135deg,#d8e8ff,#a8c8f0);box-shadow:0 3px 10px rgba(168,200,240,.3);}
.mod-content{flex:1;overflow-y:auto;padding:18px 20px 90px;scrollbar-width:none;}
.mod-content::-webkit-scrollbar{display:none;}
.pill-bar{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;}
.pill-bar::-webkit-scrollbar{display:none;}
.pill-bar .pill,.pill-bar .lang-mode-btn{flex-shrink:0;white-space:nowrap;}
.pill{flex-shrink:0;padding:7px 16px;border-radius:20px;border:2px solid transparent;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;cursor:pointer;transition:all .15s;}
.mod-sub{display:none;}
.mod-sub.active{display:block;}
.mod-sub.active.lang-chat-tab{display:flex;flex-direction:column;}
.sec-lbl{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#b090c0;margin:0 0 8px 2px;}

.xp-banner{border-radius:18px;padding:18px 20px;margin-bottom:16px;color:#fff;position:relative;overflow:hidden;}
.xp-banner::after{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.1);}
.xpb-lbl{font-size:11px;opacity:.9;font-weight:800;margin-bottom:3px;letter-spacing:.5px;}
.xpb-num{font-family:'Fredoka',sans-serif;font-size:30px;font-weight:700;margin-bottom:10px;}
.xpb-num span{font-size:15px;opacity:.75;}
.xpb-track{height:10px;background:rgba(255,255,255,.25);border-radius:10px;overflow:hidden;margin-bottom:6px;}
.xpb-fill{height:100%;background:rgba(255,255,255,.9);border-radius:10px;transition:width .5s;}
.xpb-sub{font-size:11px;opacity:.9;font-weight:700;}

.gem-bar{display:flex;align-items:center;gap:8px;background:#f0eaff;border:2px solid #d8c4f8;border-radius:14px;padding:10px 14px;margin-bottom:16px;}
.gem-bar-ico{font-size:22px;}
.gem-bar-txt{flex:1;font-size:12px;font-weight:800;color:#7a50b0;}
.gem-bar-count{font-family:'Fredoka',sans-serif;font-size:22px;font-weight:700;color:#9060c0;}

.book-card{background:#fff;border-radius:18px;border:2px solid rgba(220,180,240,.2);padding:14px;margin-bottom:10px;cursor:pointer;transition:box-shadow .2s,transform .15s;position:relative;box-shadow:0 2px 12px rgba(180,120,200,.07);}
.book-card:hover{box-shadow:0 6px 20px rgba(180,120,200,.15);transform:translateY(-2px);}
.bc-top{display:flex;gap:12px;margin-bottom:12px;}
.bc-cover{width:52px;height:70px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;box-shadow:3px 3px 0 rgba(0,0,0,.08);}
.bc-meta{flex:1;min-width:0;}
.bc-genre{font-size:10px;color:#b090c0;font-weight:800;text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px;}
.bc-title{font-family:'Fredoka',sans-serif;font-size:16px;font-weight:600;color:#5a3a6a;margin-bottom:2px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bc-author{font-size:11px;color:#9a7aaa;font-weight:600;}
.prog-row{display:flex;justify-content:space-between;margin-bottom:6px;}
.prog-txt{font-size:11px;color:var(--text-mid);font-weight:700;}
.prog-pct{font-size:11px;color:var(--r-dark);font-weight:800;}
.prog-track{height:9px;background:var(--r-light);border-radius:10px;overflow:hidden;margin-bottom:10px;border:1.5px solid var(--r-border);}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--r-dark),#f8c0dc);border-radius:10px;transition:width .4s;}
.bc-chips{display:flex;gap:6px;flex-wrap:wrap;}
.bc-chip{font-size:10px;font-weight:800;background:#fde8f2;border-radius:20px;padding:3px 10px;color:#c060a0;border:1.5px solid #f0c0dc;}
.bc-chip.gem{background:#f0eaff;color:#8050b8;border-color:#d0b8f8;}
.bc-del{position:absolute;top:10px;right:10px;font-size:16px;opacity:.3;cursor:pointer;transition:opacity .15s;border:none;background:none;}
.bc-del:hover{opacity:.8;}
.bc-badge{position:absolute;top:10px;right:30px;background:#7adda8;color:#fff;font-size:9px;font-weight:800;border-radius:10px;padding:2px 7px;}

.r-btn{width:100%;padding:15px;background:linear-gradient(135deg,#e890b8,#f0a8c8);color:#fff;border:none;border-radius:16px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 5px 0 #c07098,0 5px 14px rgba(240,168,200,.3);transition:transform .1s,box-shadow .1s;margin-bottom:20px;}
.r-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #c07098;}
.w-btn{width:100%;padding:15px;background:linear-gradient(135deg,#78a8e0,#a8c8f0);color:#fff;border:none;border-radius:16px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 5px 0 #5888c0,0 5px 14px rgba(168,200,240,.28);transition:transform .1s,box-shadow .1s;margin-bottom:20px;}
.w-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #5888c0;}

.mq{display:flex;align-items:center;gap:12px;background:#fff;border-radius:16px;border:2.5px solid var(--r-border);padding:13px;margin-bottom:8px;cursor:pointer;transition:all .2s;position:relative;}
.mq:hover{border-color:var(--r-dark);transform:translateX(3px);}
.mq.done{border-color:#7adda8;background:#f0fbf6;pointer-events:none;}
.mq-ico{width:42px;height:42px;border-radius:12px;background:var(--r-light);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;border:2px solid var(--r-border);}
.mq.done .mq-ico{background:#d8f8e8;border-color:#a8e8c0;}
.mq-body{flex:1;}
.mq-name{font-size:13px;font-weight:800;color:#5a3a6a;margin-bottom:1px;}
.mq-desc{font-size:11px;color:#9a7aaa;font-weight:600;}
.mq-rewards{display:flex;flex-direction:column;align-items:flex-end;gap:1px;}
.mq-xp{font-size:12px;font-weight:800;color:var(--r-dark);white-space:nowrap;}
.mq-gem{font-size:11px;font-weight:800;color:#9060c0;white-space:nowrap;}
.mq.done .mq-rewards{display:none;}
.mq-check{display:none;font-size:22px;}
.mq.done .mq-check{display:block;}
.wmq{border-color:var(--w-border)!important;}
.wmq .mq-ico{background:var(--w-light);border-color:var(--w-border);}
.wmq .mq-name{color:#3a5080;}
.wmq .mq-xp{color:var(--w-dark);}
.wmq:hover{border-color:var(--w-dark)!important;}

.je{background:#fff;border-radius:16px;border:2.5px solid var(--w-border);padding:14px;margin-bottom:10px;position:relative;}
.je-top{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;}
.je-ico{width:40px;height:40px;border-radius:11px;background:var(--w-light);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;border:2px solid var(--w-border);}
.je-info{flex:1;min-width:0;}
.je-title{font-family:'Fredoka',sans-serif;font-size:15px;font-weight:600;color:#001a1f;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.je-meta{font-size:10px;color:#6fa8b8;font-weight:700;}
.je-words{font-size:11px;font-weight:800;color:var(--w-dark);white-space:nowrap;}
.je-preview{font-size:12px;color:#4a7a8a;line-height:1.5;font-style:italic;}
.je-del{position:absolute;top:10px;right:10px;font-size:16px;opacity:.3;cursor:pointer;transition:opacity .15s;border:none;background:none;}
.je-del:hover{opacity:.8;}

.wp-card{background:#fff;border-radius:16px;border:2.5px solid var(--w-border);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all .2s;}
.wp-card:hover{border-color:var(--w-dark);transform:translateX(3px);}
.wp-tag{font-size:10px;font-weight:800;color:var(--w-dark);text-transform:uppercase;letter-spacing:.3px;margin-bottom:5px;}
.wp-text{font-size:13px;color:#001a1f;font-weight:700;line-height:1.5;margin-bottom:6px;}
.wp-xp{font-size:11px;font-weight:800;color:var(--w-dark);}

.badges-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.badge-card{border-radius:16px;border:2.5px solid;padding:14px 10px;text-align:center;position:relative;transition:transform .2s;}
.badge-card.earned{border-color:#f0a8c8;background:linear-gradient(135deg,#fff0f7,#fde8f2);}
.badge-card.earned:hover{transform:scale(1.03);}
.badge-card.locked{border-color:rgba(0,0,0,.08);background:#fff;opacity:.4;}
.badge-ico{font-size:30px;margin-bottom:6px;display:block;}
.badge-nm{font-size:12px;font-weight:800;color:#5a3a6a;margin-bottom:2px;}
.badge-req{font-size:10px;color:#9a7aaa;font-weight:600;}
.badge-star{position:absolute;top:7px;right:9px;font-size:14px;}

.empty-state{text-align:center;padding:40px 20px;}
.empty-ico{font-size:52px;margin-bottom:12px;display:block;}
.empty-title{font-family:'Fredoka',sans-serif;font-size:20px;font-weight:600;color:#9a7aaa;margin-bottom:6px;}
.empty-sub{font-size:13px;color:#b0a0b8;font-weight:600;line-height:1.5;}

.overlay{position:fixed;inset:0;background:rgba(100,60,120,.35);z-index:200;display:none;backdrop-filter:blur(5px);}
.overlay.show{display:block;}
.sheet{position:fixed;bottom:0;left:0;right:0;transform:translateY(110%);background:#fff;border-radius:26px 26px 0 0;padding:20px 22px 50px;z-index:201;transition:transform .35s cubic-bezier(.34,1.05,.64,1);border-top:3px solid rgba(220,180,240,.2);}
.sheet.show{transform:translateY(0);}
.sheet-handle{width:40px;height:5px;background:#e8d8f0;border-radius:10px;margin:0 auto 18px;}
.sheet-title{font-family:'Fredoka',sans-serif;font-size:22px;font-weight:700;margin-bottom:4px;color:#5a3a6a;}
.sheet-sub{font-size:13px;color:#9a7aaa;font-weight:600;margin-bottom:20px;}
.form-row{margin-bottom:14px;}
.form-lbl{font-size:12px;font-weight:800;color:#7a5a8a;margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.3px;}
.form-input{width:100%;border:2px solid #e8d8f0;border-radius:12px;padding:10px 12px;font-family:'Nunito',sans-serif;font-size:13px;color:#5a3a6a;outline:none;transition:border-color .15s;}
.form-input:focus{border-color:var(--r-dark);}
.form-input.w-focus:focus{border-color:var(--w-dark);}
.form-select{width:100%;border:2px solid #e8d8f0;border-radius:12px;padding:10px 12px;font-family:'Nunito',sans-serif;font-size:13px;color:#5a3a6a;outline:none;background:#fff;cursor:pointer;}
.form-row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
textarea.form-input{min-height:90px;resize:none;line-height:1.6;}
.stepper{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:20px;}
.step-btn{width:48px;height:48px;border-radius:14px;border:2px solid var(--r-border);background:var(--r-light);color:var(--r-dark);font-size:14px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;transition:background .15s;}
.step-btn:hover{background:#fdd8ec;}
.page-num{font-family:'Fredoka',sans-serif;font-size:48px;font-weight:700;color:#5a3a6a;min-width:80px;text-align:center;}
.earn-prev{background:linear-gradient(135deg,#fde8f2,#ffd8ec);border-radius:14px;padding:12px;text-align:center;font-size:14px;font-weight:800;color:var(--r-dark);margin-bottom:18px;border:2px solid var(--r-border);}
.r-confirm{width:100%;padding:15px;background:linear-gradient(135deg,#e890b8,#f0a8c8);color:#fff;border:none;border-radius:16px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 5px 0 #c07098;transition:transform .1s,box-shadow .1s;}
.r-confirm:active{transform:translateY(3px);box-shadow:0 2px 0 #c07098;}
.w-confirm{width:100%;padding:15px;background:linear-gradient(135deg,#78a8e0,#a8c8f0);color:#fff;border:none;border-radius:16px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 5px 0 #5888c0;transition:transform .1s,box-shadow .1s;}
.w-confirm:active{transform:translateY(3px);box-shadow:0 2px 0 #5888c0;}
.streak-stepper{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:20px;}
.s-btn{width:48px;height:48px;border-radius:14px;border:2px solid #ffd8d8;background:#fff0f0;color:#d08080;font-size:20px;font-weight:800;cursor:pointer;}
.streak-num{font-family:'Fredoka',sans-serif;font-size:48px;font-weight:700;color:#5a3a6a;min-width:80px;text-align:center;}
.streak-confirm{width:100%;padding:15px;background:linear-gradient(135deg,#f0a0b0,#f5b8c8);color:#fff;border:none;border-radius:16px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 5px 0 #d08098;transition:transform .1s,box-shadow .1s;}
.streak-confirm:active{transform:translateY(3px);box-shadow:0 2px 0 #d08098;}
.wc-display{font-size:11px;color:#88a8d0;font-weight:700;margin-bottom:12px;}

/* PET */
.pet-card{border-radius:20px;padding:18px;margin-bottom:14px;position:relative;overflow:hidden;border:3px solid;}
.pet-header{display:flex;align-items:center;gap:14px;margin-bottom:12px;}
.pet-emoji-wrap{font-size:56px;filter:drop-shadow(0 4px 10px rgba(0,0,0,.15));animation:petBob 2s ease-in-out infinite;line-height:1;}
.pet-info{flex:1;}
.pet-name{font-family:'Fredoka',sans-serif;font-size:21px;font-weight:700;margin-bottom:2px;}
.pet-title-chip{font-size:10px;font-weight:800;border-radius:20px;padding:3px 10px;display:inline-block;margin-bottom:4px;border:2px solid;}
.pet-desc{font-size:11px;font-weight:700;opacity:.8;line-height:1.4;}
.trait-row{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px;}
.trait-chip{font-size:10px;font-weight:800;border-radius:20px;padding:3px 10px;border:2px solid;}

/* LEVEL UP */
.lvlup-overlay{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(100,60,120,.75);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .3s;}
.lvlup-overlay.show{opacity:1;pointer-events:all;}
.lvlup-particles{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.particle{position:absolute;font-size:22px;opacity:0;animation:particleFly var(--dur) var(--del) ease-out forwards;}
.lvlup-burst{font-size:80px;margin-bottom:16px;animation:burstIn .5s cubic-bezier(.34,1.56,.64,1) both;}
.lvlup-label{font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:rgba(255,255,255,.75);letter-spacing:5px;text-transform:uppercase;margin-bottom:6px;animation:slideUp .4s .1s ease both;}
.lvlup-num{font-family:'Fredoka',sans-serif;font-size:56px;font-weight:700;color:#ffd8ec;text-shadow:0 0 40px rgba(255,200,220,.6),0 4px 0 #c07098;margin-bottom:6px;animation:slideUp .4s .15s ease both;}
.lvlup-subtitle{font-family:'Fredoka',sans-serif;font-size:26px;font-weight:600;color:#fff;margin-bottom:10px;animation:slideUp .4s .2s ease both;}
.lvlup-unlock{font-size:14px;font-weight:800;color:#86efac;background:rgba(134,239,172,.15);border:2px solid rgba(134,239,172,.4);border-radius:20px;padding:7px 20px;margin-bottom:32px;animation:slideUp .4s .25s ease both;}
.lvlup-btn{background:linear-gradient(135deg,#ffd8ec,#f0a8c8);color:#7a3060;border:none;border-radius:18px;padding:16px 44px;font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;cursor:pointer;box-shadow:0 6px 0 #c07098,0 8px 24px rgba(240,168,200,.4);transition:transform .1s,box-shadow .1s;animation:slideUp .4s .3s ease both;}
.lvlup-btn:active{transform:translateY(4px);box-shadow:0 2px 0 #c07098;}

/* CONFIRM DIALOG */
.confirm-dialog{position:fixed;inset:0;z-index:9000;display:none;align-items:center;justify-content:center;background:rgba(100,60,120,.4);backdrop-filter:blur(6px);}
.confirm-dialog.show{display:flex;}
.confirm-box{background:#fff;border-radius:22px;padding:24px 22px 20px;max-width:320px;width:90%;box-shadow:0 20px 60px rgba(120,60,160,.2);}
.confirm-icon{font-size:38px;text-align:center;margin-bottom:10px;}
.confirm-title{font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:#5a3a6a;text-align:center;margin-bottom:6px;}
.confirm-msg{font-size:13px;color:#9a7aaa;font-weight:600;text-align:center;line-height:1.5;margin-bottom:18px;}
.confirm-btns{display:flex;gap:10px;}
.confirm-cancel{flex:1;padding:12px;background:#f5f0f8;border:2px solid #e8d8f0;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;color:#7a5a8a;cursor:pointer;}
.confirm-ok{flex:1;padding:12px;background:linear-gradient(135deg,#f0a0b0,#f5b8c8);border:none;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;color:#fff;cursor:pointer;box-shadow:0 3px 0 #d08098;}

/* NETWORK ERROR TOAST */
.net-toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);z-index:9000;background:#5a3a6a;color:#fff;border-radius:14px;padding:10px 16px;font-size:12px;font-weight:800;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center;}
.net-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

.fx{position:fixed;font-size:18px;font-weight:800;pointer-events:none;z-index:9999;animation:floatUp 1.4s ease forwards;font-family:'Fredoka',sans-serif;text-shadow:0 2px 6px rgba(0,0,0,.2);}


#mathScreen{background:linear-gradient(180deg,#f0fbf6 0%,#d8f4e8 100%);color:var(--text-dark);}
#scienceScreen{background:linear-gradient(180deg,#f5f0ff 0%,#e8d8fc 100%);color:var(--text-dark);}
.mi{background:linear-gradient(135deg,#b8ecd0,#5bcca0);box-shadow:0 3px 10px rgba(91,204,160,.25);}
.si{background:linear-gradient(135deg,#e0d0f8,#b48ee8);box-shadow:0 3px 10px rgba(180,142,232,.25);}
.realm-req{font-size:9px;font-weight:800;background:rgba(255,255,255,.5);color:#7a5a8a;border:1.5px solid rgba(200,160,220,.4);border-radius:20px;padding:2px 8px;margin-top:2px;display:inline-block;}
#worldMap .realm-node.math .realm-bubble{background:radial-gradient(circle at 30% 30%,#b8ecd0,#5bcca0);box-shadow:0 0 0 5px rgba(255,255,255,.5),0 0 30px rgba(91,204,160,.3),0 8px 24px rgba(0,0,0,.1);border:3px solid rgba(255,255,255,.8);}
#worldMap .realm-node.science .realm-bubble{background:radial-gradient(circle at 30% 30%,#e0d0f8,#b48ee8);box-shadow:0 0 0 5px rgba(255,255,255,.5),0 0 30px rgba(180,142,232,.3),0 8px 24px rgba(0,0,0,.1);border:3px solid rgba(255,255,255,.8);}
.realm-node.math .realm-bubble{background:radial-gradient(circle at 30% 30%,#b8ecd0,#5bcca0);box-shadow:0 0 0 6px rgba(91,204,160,.2),0 8px 28px rgba(91,204,160,.25);animation:float1 3.8s ease-in-out infinite;border:3px solid rgba(255,255,255,.9);}
.realm-node.science .realm-bubble{background:radial-gradient(circle at 30% 30%,#e0d0f8,#b48ee8);box-shadow:0 0 0 6px rgba(180,142,232,.2),0 8px 28px rgba(180,142,232,.25);animation:float2 4.2s ease-in-out infinite;border:3px solid rgba(255,255,255,.9);}
.realm-node.french .realm-bubble{background:radial-gradient(circle at 30% 30%,#fde8cc,#e8a87c);box-shadow:0 0 0 6px rgba(232,168,124,.2),0 8px 28px rgba(232,168,124,.25);animation:float1 3.6s ease-in-out infinite;border:3px solid rgba(255,255,255,.9);}
.realm-node.spanish .realm-bubble{background:radial-gradient(circle at 30% 30%,#cce8ff,#7cc4e8);box-shadow:0 0 0 6px rgba(124,196,232,.2),0 8px 28px rgba(124,196,232,.25);animation:float2 4s ease-in-out infinite;border:3px solid rgba(255,255,255,.9);}
#worldMap .realm-node.french .realm-bubble{background:radial-gradient(circle at 30% 30%,#fde8cc,#e8a87c);box-shadow:0 0 0 5px rgba(255,255,255,.5),0 0 30px rgba(232,168,124,.3),0 8px 24px rgba(0,0,0,.1);border:3px solid rgba(255,255,255,.8);}
#worldMap .realm-node.spanish .realm-bubble{background:radial-gradient(circle at 30% 30%,#cce8ff,#7cc4e8);box-shadow:0 0 0 5px rgba(255,255,255,.5),0 0 30px rgba(124,196,232,.3),0 8px 24px rgba(0,0,0,.1);border:3px solid rgba(255,255,255,.8);}
#worldMap .realm-node.french .realm-sub{color:#7a3010;background:#fdecd8;border-color:#e8a87c;}
#worldMap .realm-node.spanish .realm-sub{color:#103070;background:#d8eefa;border-color:#7cc4e8;}
.realm-node.french .realm-sub{color:#7a3010;background:#fdecd8;border-color:#e8a87c;}
.realm-node.spanish .realm-sub{color:#103070;background:#d8eefa;border-color:#7cc4e8;}
/* AI Chat UI */
.lang-screen{background:linear-gradient(180deg,#fff8f0 0%,#fff 100%);display:flex;flex-direction:column;}
.lang-screen .mod-content{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0;}
.lang-screen .mod-sub.active{flex:1;overflow-y:auto;min-height:0;}
.lang-screen .mod-sub.active:not(.lang-chat-tab){padding:14px 16px;}
.lang-screen .mod-sub.active.lang-chat-tab{display:flex;flex-direction:column;overflow:hidden;}
.lang-chat-wrap{display:flex;flex-direction:column;gap:10px;padding-bottom:8px;}
.chat-bubble{max-width:84%;padding:11px 14px;border-radius:18px;font-size:13px;font-weight:700;line-height:1.55;position:relative;animation:fadeIn .2s ease;}
.chat-bubble.ai{background:linear-gradient(135deg,#f0f4ff,#e8f0fe);border:1.5px solid #c8d8f8;color:#1e3060;border-bottom-left-radius:5px;align-self:flex-start;}
.chat-bubble.ai.fr{background:linear-gradient(135deg,#fff4ec,#fdecd8);border-color:#f7cfa8;color:#5a2810;}
.chat-bubble.ai.es{background:linear-gradient(135deg,#ecf6ff,#d8eefa);border-color:#a8d8f7;color:#103060;}
.chat-bubble.user{background:linear-gradient(135deg,#6a4a7a,#9060c0);color:#fff;border-bottom-right-radius:5px;align-self:flex-end;}
.chat-input-row{display:flex;gap:8px;padding:10px 16px 14px;background:#fff;border-top:1.5px solid rgba(200,180,220,.2);flex-shrink:0;}
.chat-input{flex:1;border:2px solid rgba(200,180,220,.3);border-radius:20px;padding:10px 14px;font-family:Nunito,sans-serif;font-size:13px;font-weight:700;outline:none;background:#fdf8ff;color:#3d2d45;}
.chat-input:focus{border-color:var(--r-dark);}
.chat-send{padding:10px 18px;background:linear-gradient(135deg,#6a4a7a,#9060c0);color:#fff;border:none;border-radius:20px;font-family:Fredoka,sans-serif;font-size:14px;font-weight:700;cursor:pointer;flex-shrink:0;}
.chat-send:disabled{opacity:.4;cursor:default;}
.lang-mode-bar{display:flex;gap:8px;padding:8px 16px;overflow-x:auto;flex-shrink:0;scrollbar-width:none;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;}
.lang-mode-bar::-webkit-scrollbar{display:none;}
.lang-mode-bar .lang-mode-btn{flex-shrink:0;white-space:nowrap;}
.lang-mode-btn{flex-shrink:0;padding:7px 14px;border-radius:20px;border:2px solid;font-family:Fredoka,sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;}
.lang-typing{display:flex;gap:5px;align-items:center;padding:4px 0;}
.lang-dot{width:7px;height:7px;border-radius:50%;animation:langBounce .9s ease-in-out infinite;}
.lang-dot:nth-child(2){animation-delay:.18s;}.lang-dot:nth-child(3){animation-delay:.36s;}
@keyframes langBounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-7px);}}
.vocab-card{background:#fff;border-radius:16px;border:2px solid var(--fr-border);padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);}
.vocab-card.es{border-color:var(--es-border);}
.vocab-word{font-family:Fredoka,sans-serif;font-size:18px;font-weight:700;flex:1;}
.vocab-trans{font-size:12px;color:var(--text-mid);font-weight:700;}
.vocab-play{width:36px;height:36px;border-radius:50%;border:none;font-size:18px;cursor:pointer;flex-shrink:0;}
.xp-flash{position:fixed;font-family:Fredoka,sans-serif;font-size:18px;font-weight:700;pointer-events:none;z-index:9999;text-shadow:0 2px 8px rgba(0,0,0,.2);}
#worldMap .realm-node.math .realm-sub{color:#2a6a4a;background:#d8f4e8;border-color:#5bcca0;}
#worldMap .realm-node.science .realm-sub{color:#5a3a8a;background:#e8d8fc;border-color:#b48ee8;}
.realm-node.math .realm-sub{color:#2a6a4a;background:#e8faf2;border-color:#5bcca0;}
.realm-node.science .realm-sub{color:#5a3a8a;background:#f0e8ff;border-color:#b48ee8;}
.m-btn{width:100%;padding:15px;background:linear-gradient(135deg,#3aaa80,#5bcca0);color:#fff;border:none;border-radius:16px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 5px 0 #2a8a60;transition:transform .1s,box-shadow .1s;margin-bottom:20px;}
.m-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #2a8a60;}
.mq.mmq{border-color:var(--m-border)!important;}
.mq.mmq .mq-ico{background:var(--m-light);border-color:var(--m-border);}
.mq.smq{border-color:var(--sc-border)!important;}
.mq.smq .mq-ico{background:var(--sc-light);border-color:var(--sc-border);}
.prob-card{background:#fff;border-radius:16px;border:2.5px solid var(--m-border);padding:16px;margin-bottom:10px;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.05);}
.prob-card:hover{border-color:var(--m-dark);transform:translateX(3px);}
.prob-card.sci{border-color:var(--sc-border);}
.prob-card.sci:hover{border-color:var(--sc-dark);}
.prob-tag{font-size:10px;font-weight:800;color:var(--m-dark);text-transform:uppercase;letter-spacing:.3px;margin-bottom:5px;}
.prob-card.sci .prob-tag{color:var(--sc-dark);}
.prob-q{font-size:14px;color:#022c22;font-weight:700;line-height:1.5;margin-bottom:6px;}
.prob-card.sci .prob-q{color:#1e0040;}
.prob-xp{font-size:11px;font-weight:800;color:var(--m-dark);}
.prob-card.sci .prob-xp{color:var(--sc-dark);}

@keyframes float1{0%,100%{transform:translateY(0) rotate(-1deg)}50%{transform:translateY(-8px) rotate(1deg)}}
@keyframes float2{0%,100%{transform:translateY(0) rotate(1deg)}50%{transform:translateY(-10px) rotate(-1deg)}}
@keyframes pulseRing{0%{opacity:.7;transform:scale(1)}100%{opacity:0;transform:scale(1.6)}}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(1.3)}}
@keyframes badgeBounce{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes petBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes burstIn{from{transform:scale(0) rotate(-20deg);opacity:0}to{transform:scale(1) rotate(0deg);opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0.3)}}
@keyframes scanAnim{0%,100%{top:5%}50%{top:88%}}
@keyframes spin{to{transform:rotate(360deg)}}
.fade-in{animation:fadeIn .25s ease;}
.grade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.grade-btn{padding:12px 6px;border-radius:16px;border:2.5px solid #e8d8f0;background:#fff;font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;color:#7a5a8a;cursor:pointer;transition:all .15s;text-align:center;}
.grade-btn:hover{border-color:var(--r-dark);background:#fde8f2;color:var(--r-dark);}
.grade-btn.selected{border-color:var(--r-dark);background:linear-gradient(135deg,#fde8f2,#ffd8ec);color:#8a3060;box-shadow:0 3px 0 #e090b0;}
.grade-label{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.3px;color:#b090c0;display:block;margin-top:2px;}
.grade-badge{display:inline-block;font-size:10px;font-weight:800;background:linear-gradient(135deg,#fde8f2,#ffd8ec);color:#8a3060;border:1.5px solid #f0a8c8;border-radius:20px;padding:2px 9px;margin-left:6px;vertical-align:middle;cursor:pointer;}
</style>
</head>
<body>
<div class="app">
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INTRO ONBOARDING OVERLAY (first-time visitors)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="introOverlay" style="display:none;position:fixed;inset:0;z-index:999999;overflow:hidden;">

  <!-- Animated background -->
  <div style="position:absolute;inset:0;background:linear-gradient(160deg,#f0d8ff 0%,#d8eaff 40%,#d8f4f0 75%,#e8f8ec 100%);"></div>
  <!-- Floating blobs -->
  <div style="position:absolute;top:-80px;left:-60px;width:260px;height:260px;border-radius:50%;background:radial-gradient(circle,rgba(240,168,200,.35),transparent 70%);animation:introBlob1 6s ease-in-out infinite;"></div>
  <div style="position:absolute;bottom:-60px;right:-40px;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle,rgba(168,200,240,.35),transparent 70%);animation:introBlob2 7s ease-in-out infinite;"></div>
  <div style="position:absolute;top:40%;left:-50px;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle,rgba(91,204,160,.25),transparent 70%);animation:introBlob1 5s ease-in-out infinite reverse;"></div>

  <style>
    @keyframes introBlob1{0%,100%{transform:translate(0,0) scale(1);}50%{transform:translate(20px,15px) scale(1.08);}}
    @keyframes introBlob2{0%,100%{transform:translate(0,0) scale(1);}50%{transform:translate(-15px,20px) scale(1.06);}}
    @keyframes introPop{0%{opacity:0;transform:scale(.85) translateY(18px);}100%{opacity:1;transform:scale(1) translateY(0);}}
    @keyframes introSlideUp{0%{opacity:0;transform:translateY(24px);}100%{opacity:1;transform:translateY(0);}}
    @keyframes introFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
    @keyframes introStarSpin{0%{transform:rotate(0deg) scale(1);}50%{transform:rotate(180deg) scale(1.2);}100%{transform:rotate(360deg) scale(1);}}
    @keyframes introDotPulse{0%,100%{opacity:.3;transform:scale(.8);}50%{opacity:1;transform:scale(1.1);}}
    .intro-slide{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px 100px;opacity:0;pointer-events:none;transition:opacity .4s,transform .4s;transform:translateX(40px);}
    .intro-slide.active{opacity:1;pointer-events:all;transform:translateX(0);}
    .intro-slide.exit{opacity:0;transform:translateX(-40px);}
    .intro-emoji{font-size:72px;margin-bottom:16px;animation:introFloat 3s ease-in-out infinite;display:block;filter:drop-shadow(0 8px 20px rgba(0,0,0,.12));}
    .intro-title{font-family:'Fredoka',sans-serif;font-size:30px;font-weight:700;color:#3d2050;text-align:center;margin-bottom:10px;line-height:1.2;}
    .intro-title span{background:linear-gradient(135deg,#c060a0,#9060c0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .intro-desc{font-family:'Nunito',sans-serif;font-size:15px;font-weight:700;color:#7a6b80;text-align:center;line-height:1.6;max-width:300px;}
    .intro-features{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px;margin-top:4px;}
    .intro-feat{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.7);border-radius:16px;padding:12px 16px;border:2px solid rgba(220,180,240,.3);backdrop-filter:blur(8px);animation:introSlideUp .4s ease both;}
    .intro-feat-ico{font-size:24px;flex-shrink:0;}
    .intro-feat-text{font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;color:#5a3a6a;}
    .intro-feat-sub{font-size:11px;font-weight:600;color:#9a7aaa;margin-top:1px;}
  </style>

  <!-- SLIDE 1: Welcome -->
  <div class="intro-slide active" id="introSlide0">
    <span class="intro-emoji">üå≥</span>
    <div class="intro-title">Welcome to<br><span>SkillTree!</span></div>
    <div class="intro-desc" style="margin-bottom:20px;">The ultimate learning adventure for curious minds. Level up your skills and unlock new realms! üöÄ</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
      <div style="background:rgba(240,168,200,.25);border:2px solid rgba(240,168,200,.5);border-radius:20px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;color:#c060a0;">üìñ Reading</div>
      <div style="background:rgba(168,200,240,.25);border:2px solid rgba(168,200,240,.5);border-radius:20px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;color:#4a80c0;">‚úçÔ∏è Writing</div>
      <div style="background:rgba(91,204,160,.25);border:2px solid rgba(91,204,160,.5);border-radius:20px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;color:#2a8a60;">üî¢ Math</div>
      <div style="background:rgba(180,142,232,.25);border:2px solid rgba(180,142,232,.5);border-radius:20px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;color:#7040b0;">üî¨ Science</div>
      <div style="background:rgba(232,168,124,.25);border:2px solid rgba(232,168,124,.5);border-radius:20px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;color:#b05020;">üá´üá∑ French</div>
      <div style="background:rgba(124,196,232,.25);border:2px solid rgba(124,196,232,.5);border-radius:20px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;color:#205090;">üá™üá∏ Spanish</div>
    </div>
  </div>

  <!-- SLIDE 2: Earn XP & Level Up -->
  <div class="intro-slide" id="introSlide1">
    <span class="intro-emoji">‚ö°</span>
    <div class="intro-title">Earn <span>XP</span> &<br>Level Up!</div>
    <div class="intro-desc" style="margin-bottom:18px;">Every page you read, word you write, and quiz you ace earns you XP. Watch your levels climb!</div>
    <div class="intro-features">
      <div class="intro-feat" style="animation-delay:.05s">
        <span class="intro-feat-ico">üìñ</span>
        <div><div class="intro-feat-text">Log your reading</div><div class="intro-feat-sub">+10 XP per page ¬∑ +1 üíé per page</div></div>
      </div>
      <div class="intro-feat" style="animation-delay:.1s">
        <span class="intro-feat-ico">‚úçÔ∏è</span>
        <div><div class="intro-feat-text">Write journal entries</div><div class="intro-feat-sub">Up to +500 XP for long entries</div></div>
      </div>
      <div class="intro-feat" style="animation-delay:.15s">
        <span class="intro-feat-ico">üéØ</span>
        <div><div class="intro-feat-text">Complete quizzes</div><div class="intro-feat-sub">+80 XP correct ¬∑ +3 üíé per right answer</div></div>
      </div>
    </div>
  </div>

  <!-- SLIDE 3: Quests & Gems -->
  <div class="intro-slide" id="introSlide2">
    <span class="intro-emoji">‚öîÔ∏è</span>
    <div class="intro-title">Daily <span>Quests</span><br>& Treasures!</div>
    <div class="intro-desc" style="margin-bottom:18px;">Complete daily mini-quests to earn bonus XP and collect shiny gems üíé</div>
    <div class="intro-features">
      <div class="intro-feat" style="animation-delay:.05s">
        <span class="intro-feat-ico">üåÖ</span>
        <div><div class="intro-feat-text">Dawn Warrior</div><div class="intro-feat-sub">Read before 9am ¬∑ +100 XP +3 üíé</div></div>
      </div>
      <div class="intro-feat" style="animation-delay:.1s">
        <span class="intro-feat-ico">‚è±Ô∏è</span>
        <div><div class="intro-feat-text">Speed Reader</div><div class="intro-feat-sub">Read 10 pages in one sitting ¬∑ +200 XP</div></div>
      </div>
      <div class="intro-feat" style="animation-delay:.15s">
        <span class="intro-feat-ico">üî•</span>
        <div><div class="intro-feat-text">Build your streak!</div><div class="intro-feat-sub">Study every day to keep it going</div></div>
      </div>
    </div>
  </div>

  <!-- SLIDE 4: Languages -->
  <div class="intro-slide" id="introSlide3">
    <span class="intro-emoji">üåç</span>
    <div class="intro-title">Learn <span>Languages</span><br>the fun way!</div>
    <div class="intro-desc" style="margin-bottom:18px;">Study French üá´üá∑ and Spanish üá™üá∏ with vocab flashcards and quizzes. Unlock language realms as you level up!</div>
    <div class="intro-features">
      <div class="intro-feat" style="animation-delay:.05s">
        <span class="intro-feat-ico">üìö</span>
        <div><div class="intro-feat-text">11 vocab topics each</div><div class="intro-feat-sub">Greetings, food, sports, weather & more!</div></div>
      </div>
      <div class="intro-feat" style="animation-delay:.1s">
        <span class="intro-feat-ico">üéØ</span>
        <div><div class="intro-feat-text">45 quiz questions each</div><div class="intro-feat-sub">Random new quiz every time you play</div></div>
      </div>
      <div class="intro-feat" style="animation-delay:.15s">
        <span class="intro-feat-ico">üèÜ</span>
        <div><div class="intro-feat-text">Quiz Champion quest</div><div class="intro-feat-sub">Score 80%+ to unlock bonus XP & gems</div></div>
      </div>
    </div>
  </div>

  <!-- SLIDE 5: Ready! -->
  <div class="intro-slide" id="introSlide4">
    <span class="intro-emoji" style="animation-name:introStarSpin;animation-duration:4s;">üåü</span>
    <div class="intro-title">You're all set,<br><span>Scholar!</span></div>
    <div class="intro-desc" style="margin-bottom:24px;">Your adventure starts now. Pick your grade level and dive into your first realm. Good luck! üéâ</div>
    <div style="background:rgba(255,255,255,.7);border-radius:20px;padding:16px 20px;border:2px solid rgba(220,180,240,.3);max-width:300px;width:100%;text-align:center;backdrop-filter:blur(8px);">
      <div style="font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;color:#5a3a6a;margin-bottom:8px;">üí° Pro tip</div>
      <div style="font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#7a6b80;line-height:1.6;">Tap the üå≥ logo on the world map to access the admin panel for special powers!</div>
    </div>
  </div>

  <!-- Bottom nav: dots + buttons -->
  <div style="position:absolute;bottom:0;left:0;right:0;padding:16px 24px 28px;display:flex;flex-direction:column;align-items:center;gap:14px;">
    <!-- Dot indicators -->
    <div style="display:flex;gap:7px;align-items:center;" id="introDots">
      <div class="intro-dot active" id="introDot0"></div>
      <div class="intro-dot" id="introDot1"></div>
      <div class="intro-dot" id="introDot2"></div>
      <div class="intro-dot" id="introDot3"></div>
      <div class="intro-dot" id="introDot4"></div>
    </div>
    <style>
      .intro-dot{width:8px;height:8px;border-radius:50%;background:rgba(180,120,200,.25);transition:all .3s;}
      .intro-dot.active{width:22px;border-radius:6px;background:linear-gradient(90deg,#c060a0,#9060c0);}
    </style>
    <!-- Buttons row -->
    <div style="display:flex;gap:10px;width:100%;max-width:340px;">
      <button id="introPrevBtn" onclick="introNav(-1)" style="display:none;flex:1;padding:14px;background:rgba(255,255,255,.7);color:#9060c0;border:2px solid rgba(220,180,240,.4);border-radius:16px;font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;cursor:pointer;backdrop-filter:blur(8px);">‚Üê Back</button>
      <button id="introNextBtn" onclick="introNav(1)" style="flex:1;padding:14px;background:linear-gradient(135deg,#c060a0,#9060c0);color:#fff;border:none;border-radius:16px;font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 5px 0 #6a3a8a,0 5px 16px rgba(144,96,192,.35);transition:transform .1s,box-shadow .1s;" onmousedown="this.style.transform='translateY(3px)';this.style.boxShadow='0 2px 0 #6a3a8a'" onmouseup="this.style.transform='';this.style.boxShadow='0 5px 0 #6a3a8a,0 5px 16px rgba(144,96,192,.35)'">Next ‚Üí</button>
    </div>
    <button onclick="dismissIntro()" style="background:none;border:none;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#b0a0b8;cursor:pointer;padding:4px 8px;" id="introSkipBtn">Skip intro</button>
  </div>
</div>
<!-- ‚ïê‚ïê END INTRO ‚ïê‚ïê -->


<div id="pwaInstallBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:99999;background:linear-gradient(135deg,#6a4a7a,#9060c0);color:#fff;padding:12px 16px;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(100,40,140,.3);">
  <span style="font-size:26px">üå≥</span>
  <div style="flex:1"><div style="font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700">Install SkillTree!</div><div style="font-size:11px;opacity:.85;font-weight:600">Add to home screen ‚Äî works offline! üì≤</div></div>
  <button id="pwaInstallBtn" style="padding:8px 16px;background:linear-gradient(135deg,#fde68a,#f59e0b);color:#92400e;border:none;border-radius:20px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 3px 0 #b45309;">Install ‚ú®</button>
  <button id="pwaInstallDismiss" style="width:28px;height:28px;background:rgba(255,255,255,.2);border:none;border-radius:50%;color:#fff;font-size:14px;cursor:pointer;">‚úï</button>
</div>

<!-- WORLD MAP -->
<div class="screen active" id="worldMap">
  <div class="map-header">
    <div class="map-logo">Skill<span>Tree</span> <span onclick="openAdminPanel()" style="cursor:pointer;user-select:none;" title="Admin Panel">üå≥</span> <span class="grade-badge" id="mapGradeBadge" onclick="openGradeSheet()" title="Change grade">Gr.6</span></div>
    <div class="player-chip" onclick="showMapPanel('map-profile')">
      <div class="p-avatar" id="mapAvatar">üßô</div>
      <div>
        <div class="p-name" id="mapPlayerName">‚Äî</div>
        <div class="p-level" id="mapPlayerLevel">Level 1</div>
      </div>
    </div>
  </div>
  <div class="xp-strip">
    <div class="xp-strip-lbl">‚ö° XP</div>
    <div class="xp-track"><div class="xp-fill-bar" id="mapXpBar" style="width:0%"></div></div>
    <div class="xp-val" id="mapXpVal">0</div>
    <div class="gem-chip">üíé <span id="mapGemNum">0</span></div>
    <div class="streak-chip" onclick="openStreakSheet()">üî• <span id="mapStreakNum">0</span></div>
  </div>
  <div class="map-path-area">
    <svg style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1;" preserveAspectRatio="none" viewBox="0 0 400 520">
      <path d="M 200 110 C 260 160, 320 220, 310 300" fill="none" stroke="rgba(180,140,220,.4)" stroke-width="3.5" stroke-dasharray="10 7" stroke-linecap="round"/>
      <path d="M 310 300 C 300 380, 200 400, 110 420" fill="none" stroke="rgba(180,140,220,.3)" stroke-width="3" stroke-dasharray="10 7" stroke-linecap="round"/>
      <path d="M 110 420 C 120 460, 260 470, 300 490" fill="none" stroke="rgba(180,140,220,.2)" stroke-width="3" stroke-dasharray="10 7" stroke-linecap="round"/>
    </svg>
    <div class="realm-row" style="margin-top:-10px;position:relative;z-index:2;">
      <div class="realm-node reading" onclick="openRealm('readingScreen')">
        <div class="realm-bubble">üìñ
          <svg style="position:absolute;inset:-6px;width:calc(100%+12px);height:calc(100%+12px)" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="44" fill="none" stroke="rgba(253,230,138,.3)" stroke-width="5"/>
            <circle cx="48" cy="48" r="44" fill="none" stroke="#fde68a" stroke-width="5" stroke-dasharray="276" id="readingRingOffset" stroke-dashoffset="276" stroke-linecap="round" transform="rotate(-90 48 48)"/>
          </svg>
        </div>
        <div><div class="realm-name">Reading Realm</div><div class="realm-sub" id="readingRealmSub">Lv 1‚Äì5 ¬∑ 0 books</div></div>
      </div>
    </div>
    <div class="realm-row" style="justify-content:flex-end;padding-right:30px;margin-top:28px;position:relative;z-index:2;">
      <div class="realm-node writing" id="realmWriting" onclick="openRealm('writingScreen')">
        <div class="realm-bubble">‚úçÔ∏è
          <div class="new-badge" id="writingNewBadge">NEW</div>
          <svg style="position:absolute;inset:-6px;width:calc(100%+12px);height:calc(100%+12px)" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="44" fill="none" stroke="rgba(165,243,252,.3)" stroke-width="5"/>
            <circle cx="48" cy="48" r="44" fill="none" stroke="#a5f3fc" stroke-width="5" stroke-dasharray="276" id="writingRingOffset" stroke-dashoffset="276" stroke-linecap="round" transform="rotate(-90 48 48)"/>
          </svg>
        </div>
        <div><div class="realm-name">Writing Realm</div><div class="realm-sub" id="writingRealmSub">Lv 5‚Äì10 ¬∑ 0 entries</div>
          <div class="realm-req" id="writingRealmReq" style="display:none">üîí Reach Level 5</div></div>
      </div>
    </div>
    <div class="realm-row" style="justify-content:flex-start;padding-left:30px;margin-top:22px;position:relative;z-index:2;">
      <div class="realm-node math" id="realmMath" onclick="openRealm('mathScreen')">
        <div class="realm-bubble">üî¢
          <svg style="position:absolute;inset:-6px;width:calc(100%+12px);height:calc(100%+12px)" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="44" fill="none" stroke="rgba(167,243,208,.3)" stroke-width="5"/>
            <circle cx="48" cy="48" r="44" fill="none" stroke="#a7f3d0" stroke-width="5" stroke-dasharray="276" id="mathRingOffset" stroke-dashoffset="276" stroke-linecap="round" transform="rotate(-90 48 48)"/>
          </svg>
        </div>
        <div>
          <div class="realm-name">Math Realm</div>
          <div class="realm-sub" id="mathRealmSub">Lv 10‚Äì15</div>
          <div class="realm-req" id="mathRealmReq" style="display:none">üîí Reach Level 10</div>
        </div>
      </div>
    </div>
    <div class="realm-row" style="justify-content:flex-end;padding-right:40px;margin-top:18px;position:relative;z-index:2;">
      <div class="realm-node science" id="realmScience" onclick="openRealm('scienceScreen')">
        <div class="realm-bubble">üî¨
          <svg style="position:absolute;inset:-6px;width:calc(100%+12px);height:calc(100%+12px)" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="44" fill="none" stroke="rgba(221,214,254,.3)" stroke-width="5"/>
            <circle cx="48" cy="48" r="44" fill="none" stroke="#ddd6fe" stroke-width="5" stroke-dasharray="276" id="scienceRingOffset" stroke-dashoffset="276" stroke-linecap="round" transform="rotate(-90 48 48)"/>
          </svg>
        </div>
        <div>
          <div class="realm-name">Science Realm</div>
          <div class="realm-sub" id="scienceRealmSub">Lv 15‚Äì20</div>
          <div class="realm-req" id="scienceRealmReq" style="display:none">üîí Reach Level 15</div>
        </div>
      </div>
    </div>
    <div class="realm-row" style="justify-content:flex-start;padding-left:44px;margin-top:16px;position:relative;z-index:2;">
      <div class="realm-node french" id="realmFrench" onclick="openRealm('frenchScreen')">
        <div class="realm-bubble">üá´üá∑
          <svg style="position:absolute;inset:-6px;width:calc(100%+12px);height:calc(100%+12px)" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="44" fill="none" stroke="rgba(247,207,168,.3)" stroke-width="5"/>
            <circle cx="48" cy="48" r="44" fill="none" stroke="#f7cfa8" stroke-width="5" stroke-dasharray="276" id="frenchRingOffset" stroke-dashoffset="276" stroke-linecap="round" transform="rotate(-90 48 48)"/>
          </svg>
        </div>
        <div><div class="realm-name">French Realm</div><div class="realm-sub" id="frenchRealmSub">Lv 6+</div>
          <div class="realm-req" id="frenchRealmReq" style="display:none">üîí Reach Level 6</div></div>
      </div>
    </div>
    <div class="realm-row" style="justify-content:flex-end;padding-right:36px;margin-top:16px;position:relative;z-index:2;">
      <div class="realm-node spanish" id="realmSpanish" onclick="openRealm('spanishScreen')">
        <div class="realm-bubble">üá™üá∏
          <svg style="position:absolute;inset:-6px;width:calc(100%+12px);height:calc(100%+12px)" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="44" fill="none" stroke="rgba(168,216,247,.3)" stroke-width="5"/>
            <circle cx="48" cy="48" r="44" fill="none" stroke="#a8d8f7" stroke-width="5" stroke-dasharray="276" id="spanishRingOffset" stroke-dashoffset="276" stroke-linecap="round" transform="rotate(-90 48 48)"/>
          </svg>
        </div>
        <div><div class="realm-name">Spanish Realm</div><div class="realm-sub" id="spanishRealmSub">Lv 8+</div>
          <div class="realm-req" id="spanishRealmReq" style="display:none">üîí Reach Level 8</div></div>
      </div>
    </div>
    <div class="realm-row" style="justify-content:flex-start;padding-left:44px;margin-top:14px;position:relative;z-index:2;">
      <div class="realm-node locked">
        <div class="realm-bubble">üé≠<div class="lock-icon">üîí</div></div>
        <div><div class="realm-name">Arts Realm</div><div class="realm-sub">Lv 30+ ¬∑ Coming soon</div></div>
      </div>
    </div>
  </div>
  <nav class="map-bottom-nav">
    <button class="map-nav-btn active" onclick="showMapPanel('map-world',this)"><span class="ico">üó∫Ô∏è</span>World</button>
    <button class="map-nav-btn" onclick="showMapPanel('map-pet',this)"><span class="ico">üêæ</span>Pet</button>
    <button class="map-nav-btn" onclick="showMapPanel('map-progress',this)"><span class="ico">üìä</span>Progress</button>
    <button class="map-nav-btn" onclick="showMapPanel('map-badges',this)"><span class="ico">üèÖ</span>Badges</button>
    <button class="map-nav-btn" onclick="showMapPanel('map-profile',this)"><span class="ico">üë§</span>Profile</button>
  </nav>
</div>

<!-- READING SCREEN -->
<div class="screen" id="readingScreen">
  <div class="mod-header">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <div class="mod-title-group"><div class="mod-realm-lbl">SkillTree ‚Üí Realm 1</div><div class="mod-title">Reading Realm üìñ</div></div>
    <div class="mod-icon ri">üìñ</div>
  </div>
  <div class="mod-content">
    <div class="pill-bar">
      <button class="pill active" id="rPill-quests" onclick="switchModTab('r','quests',this)" style="background:var(--r-light);color:var(--r-dark);border-color:var(--r-border)">‚öîÔ∏è Quests</button>
      <button class="pill" id="rPill-library" onclick="switchModTab('r','library',this)" style="background:#f5f5f4;color:#78716c;border-color:#e7e5e4">üìö Library</button>
      <button class="pill" id="rPill-badges" onclick="switchModTab('r','badges',this)" style="background:#f5f5f4;color:#78716c;border-color:#e7e5e4">üèÖ Badges</button>
    </div>
    <div class="mod-sub active" id="r-quests">
      <div class="xp-banner" style="background:linear-gradient(135deg,#e890b8,#f0a8c8,#f8c8dc)">
        <div class="xpb-lbl" id="rXpBannerLbl">READING LEVEL 1</div>
        <div class="xpb-num" id="rXpBannerNum">0 <span>/ 1,000 XP</span></div>
        <div class="xpb-track"><div class="xpb-fill" id="rXpFill" style="width:0%"></div></div>
        <div class="xpb-sub" id="rXpBannerSub">Keep reading to level up! üöÄ</div>
      </div>
      <div class="gem-bar">
        <div class="gem-bar-ico">üíé</div>
        <div class="gem-bar-txt">Gems collected!</div>
        <div class="gem-bar-count" id="rGemCount">0</div>
      </div>
      <div class="sec-lbl">Active Quest</div>
      <div id="activeBookArea"></div>
      <button class="r-btn" onclick="openLogSheet()">üìñ &nbsp;Log Today's Pages</button>
      <div class="sec-lbl">Daily Mini Quests</div>
      <div>
        <div class="mq" data-mqid="r-shadow" onclick="completeMQ(this,'#d97706',150,5)"><div class="mq-ico">üî¶</div><div class="mq-body"><div class="mq-name">Shadow Scout</div><div class="mq-desc">Read 5 pages after dark üåô</div></div><div class="mq-rewards"><div class="mq-xp">+150 XP</div><div class="mq-gem">+5 üíé</div></div><div class="mq-check">‚úÖ</div></div>
        <div class="mq" data-mqid="r-speed" onclick="completeMQ(this,'#d97706',200,8)"><div class="mq-ico">‚è±Ô∏è</div><div class="mq-body"><div class="mq-name">Speed Reader</div><div class="mq-desc">Read 10 pages in one sitting</div></div><div class="mq-rewards"><div class="mq-xp">+200 XP</div><div class="mq-gem">+8 üíé</div></div><div class="mq-check">‚úÖ</div></div>
        <div class="mq" data-mqid="r-dawn" onclick="completeMQ(this,'#d97706',100,3)"><div class="mq-ico">üåÖ</div><div class="mq-body"><div class="mq-name">Dawn Warrior</div><div class="mq-desc">Read before 9am ‚òÄÔ∏è</div></div><div class="mq-rewards"><div class="mq-xp">+100 XP</div><div class="mq-gem">+3 üíé</div></div><div class="mq-check">‚úÖ</div></div>
        <div class="mq" data-mqid="r-genre" onclick="completeMQ(this,'#d97706',300,12)"><div class="mq-ico">üó∫Ô∏è</div><div class="mq-body"><div class="mq-name">Genre Explorer</div><div class="mq-desc">Read a book in a brand new genre</div></div><div class="mq-rewards"><div class="mq-xp">+300 XP</div><div class="mq-gem">+12 üíé</div></div><div class="mq-check">‚úÖ</div></div>
        <div class="mq" data-mqid="r-cozy" onclick="completeMQ(this,'#d97706',250,10)"><div class="mq-ico">üçµ</div><div class="mq-body"><div class="mq-name">Cozy Reader</div><div class="mq-desc">Read for 20 minutes straight</div></div><div class="mq-rewards"><div class="mq-xp">+250 XP</div><div class="mq-gem">+10 üíé</div></div><div class="mq-check">‚úÖ</div></div>
        <div class="mq" data-mqid="r-chapter" onclick="completeMQ(this,'#d97706',180,6)"><div class="mq-ico">üèÜ</div><div class="mq-body"><div class="mq-name">Chapter Champion</div><div class="mq-desc">Finish a whole chapter today</div></div><div class="mq-rewards"><div class="mq-xp">+180 XP</div><div class="mq-gem">+6 üíé</div></div><div class="mq-check">‚úÖ</div></div>
        <div class="mq" data-mqid="r-weekend" onclick="completeMQ(this,'#d97706',400,20)"><div class="mq-ico">üåà</div><div class="mq-body"><div class="mq-name">Weekend Warrior</div><div class="mq-desc">Read on both Sat &amp; Sun</div></div><div class="mq-rewards"><div class="mq-xp">+400 XP</div><div class="mq-gem">+20 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      </div>
    </div>
    <div class="mod-sub" id="r-library">
      <button class="r-btn" onclick="openAddBookSheet()">Ôºã &nbsp;Add a Book to Quest Log</button>
      <div class="sec-lbl">Reading Now</div><div id="libraryReadingNow"></div>
      <div class="sec-lbl" style="margin-top:14px">Completed ‚úÖ</div><div id="libraryCompleted"></div>
      <div class="sec-lbl" style="margin-top:14px">Want to Read üìã</div><div id="libraryWantToRead"></div>
    </div>
    <div class="mod-sub" id="r-badges"><div id="readingBadgesContent"></div></div>
  </div>
</div>

<!-- WRITING SCREEN -->
<div class="screen" id="writingScreen">
  <div class="mod-header">
    <button class="back-btn" onclick="goBack()" style="background:rgba(106,158,220,.1)">‚Üê</button>
    <div class="mod-title-group"><div class="mod-realm-lbl" style="color:var(--w-dark)">SkillTree ‚Üí Realm 2</div><div class="mod-title" style="color:#3a5080">Writing Realm ‚úçÔ∏è <span class="grade-badge" id="writeGradeBadge" onclick="openGradeSheet()">Gr.6</span></div></div>
    <div class="mod-icon wi">‚úçÔ∏è</div>
  </div>
  <div class="mod-content">
    <div class="pill-bar">
      <button class="pill active" id="wPill-journal" onclick="switchModTab('w','journal',this)" style="background:var(--w-light);color:var(--w-dark);border-color:var(--w-border)">üìì Journal</button>
      <button class="pill" id="wPill-prompts" onclick="switchModTab('w','prompts',this)" style="background:#f0f9ff;color:#6fa8b8;border-color:#bae6f7">üí° Prompts</button>
      <button class="pill" id="wPill-quests" onclick="switchModTab('w','quests',this)" style="background:#f0f9ff;color:#6fa8b8;border-color:#bae6f7">‚öîÔ∏è Quests</button>
    </div>
    <div class="mod-sub active" id="w-journal">
      <div class="xp-banner" style="background:linear-gradient(135deg,#6a9edc,#a8c8f0,#c8deff)">
        <div class="xpb-lbl" id="wXpBannerLbl">WRITING LEVEL 1</div>
        <div class="xpb-num" id="wXpBannerNum">0 <span>/ 500 XP</span></div>
        <div class="xpb-track"><div class="xpb-fill" id="wXpFill" style="width:0%"></div></div>
        <div class="xpb-sub" id="wXpBannerSub">Write your first entry! ‚ú®</div>
      </div>
      <button class="w-btn" onclick="openWriteSheet()">‚úçÔ∏è &nbsp;New Entry Today</button>
      <div class="sec-lbl">Recent Entries</div>
      <div id="journalList"></div>
    </div>
    <div class="mod-sub" id="w-prompts">
      <div style="background:var(--w-light);border-radius:14px;padding:12px 14px;margin-bottom:14px;font-size:12px;color:#0e7490;font-weight:800;line-height:1.5;border:2px solid var(--w-border)">üí° Pick a prompt and write 50+ words to earn XP + Gems!</div>
      <div class="sec-lbl">Today's Prompts <span class="grade-badge" id="promptGradeBadge" onclick="openGradeSheet()">Gr.6</span></div>
      <div id="writingPromptsContainer"></div>
</div>
    </div>
    <div class="mod-sub" id="w-quests">
      <div class="sec-lbl" style="margin-top:4px">Daily Writing Quests</div>
      <div class="mq wmq" data-mqid="w-first" onclick="completeMQ(this,'#0891b2',100,3)"><div class="mq-ico" style="background:var(--w-light);border-color:var(--w-border)">üìù</div><div class="mq-body"><div class="mq-name" style="color:#001a1f">First Words</div><div class="mq-desc">Write any entry today</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--w-dark)">+100 XP</div><div class="mq-gem">+3 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq wmq" data-mqid="w-century" onclick="completeMQ(this,'#0891b2',200,8)"><div class="mq-ico" style="background:var(--w-light);border-color:var(--w-border)">üíØ</div><div class="mq-body"><div class="mq-name" style="color:#001a1f">Century Writer</div><div class="mq-desc">Write 100+ words in one entry</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--w-dark)">+200 XP</div><div class="mq-gem">+8 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq wmq" data-mqid="w-prompt" onclick="completeMQ(this,'#0891b2',150,5)"><div class="mq-ico" style="background:var(--w-light);border-color:var(--w-border)">üéØ</div><div class="mq-body"><div class="mq-name" style="color:#001a1f">Prompt Hunter</div><div class="mq-desc">Write using a daily prompt</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--w-dark)">+150 XP</div><div class="mq-gem">+5 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq wmq" data-mqid="w-lore" onclick="completeMQ(this,'#0891b2',350,15)"><div class="mq-ico" style="background:var(--w-light);border-color:var(--w-border)">üåü</div><div class="mq-body"><div class="mq-name" style="color:#001a1f">Lore Keeper</div><div class="mq-desc">Write entries 3 days in a row</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--w-dark)">+350 XP</div><div class="mq-gem">+15 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq wmq" data-mqid="w-world" onclick="completeMQ(this,'#0891b2',280,12)"><div class="mq-ico" style="background:var(--w-light);border-color:var(--w-border)">üé®</div><div class="mq-body"><div class="mq-name" style="color:#001a1f">World Builder</div><div class="mq-desc">Describe an imaginary world</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--w-dark)">+280 XP</div><div class="mq-gem">+12 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq wmq" data-mqid="w-review" onclick="completeMQ(this,'#0891b2',120,4)"><div class="mq-ico" style="background:var(--w-light);border-color:var(--w-border)">üìö</div><div class="mq-body"><div class="mq-name" style="color:#001a1f">Book Reviewer</div><div class="mq-desc">Write a review of your current book</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--w-dark)">+120 XP</div><div class="mq-gem">+4 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    </div>
  </div>
</div>


<!-- MATH SCREEN -->
<div class="screen" id="mathScreen">
  <div class="mod-header">
    <button class="back-btn" onclick="goBack()" style="background:rgba(91,204,160,.1)">‚Üê</button>
    <div class="mod-title-group"><div class="mod-realm-lbl" style="color:var(--m-dark)">SkillTree ‚Üí Realm 3</div><div class="mod-title" style="color:#2a5a3a">Math Realm üî¢ <span class="grade-badge" id="mathGradeBadge" onclick="openGradeSheet()">Gr.6</span></div></div>
    <div class="mod-icon mi">üî¢</div>
  </div>
  <div class="mod-content">
    <div class="pill-bar">
      <button class="pill active" id="mPill-quests" onclick="switchModTab('m','quests',this)" style="background:var(--m-light);color:var(--m-dark);border-color:var(--m-border)">‚öîÔ∏è Quests</button>
      <button class="pill" id="mPill-problems" onclick="switchModTab('m','problems',this)" style="background:#f0fdf4;color:#6b9e8a;border-color:#6ee7b7">üßÆ Problems</button>
      <button class="pill" id="mPill-badges" onclick="switchModTab('m','badges',this)" style="background:#f0fdf4;color:#6b9e8a;border-color:#6ee7b7">üèÖ Badges</button>
    </div>
    <div class="mod-sub active" id="m-quests">
      <div class="xp-banner" style="background:linear-gradient(135deg,#3aaa80,#5bcca0,#8addc0)">
        <div class="xpb-lbl" id="mXpBannerLbl">MATH LEVEL 1</div>
        <div class="xpb-num" id="mXpBannerNum">0 <span>/ 800 XP</span></div>
        <div class="xpb-track"><div class="xpb-fill" id="mXpFill" style="width:0%"></div></div>
        <div class="xpb-sub" id="mXpBannerSub">Solve your first problem! üßÆ</div>
      </div>
      <div class="gem-bar" style="background:#ecfdf5;border-color:#6ee7b7"><div class="gem-bar-ico">üíé</div><div class="gem-bar-txt" style="color:#065f46">Gems collected!</div><div class="gem-bar-count" id="mGemCount">0</div></div>
      <div class="sec-lbl">Daily Math Quests</div>
      <div class="mq mmq" data-mqid="m-crunch" onclick="completeMQ(this,'#059669',120,4)"><div class="mq-ico" style="background:var(--m-light);border-color:var(--m-border)">‚ûï</div><div class="mq-body"><div class="mq-name" style="color:#022c22">Number Cruncher</div><div class="mq-desc">Solve 5 addition/subtraction problems</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--m-dark)">+120 XP</div><div class="mq-gem">+4 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq mmq" data-mqid="m-times" onclick="completeMQ(this,'#059669',200,8)"><div class="mq-ico" style="background:var(--m-light);border-color:var(--m-border)">‚úñÔ∏è</div><div class="mq-body"><div class="mq-name" style="color:#022c22">Times Tables Hero</div><div class="mq-desc">Practice the 6, 7, and 8 times tables</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--m-dark)">+200 XP</div><div class="mq-gem">+8 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq mmq" data-mqid="m-shape" onclick="completeMQ(this,'#059669',180,6)"><div class="mq-ico" style="background:var(--m-light);border-color:var(--m-border)">üìê</div><div class="mq-body"><div class="mq-name" style="color:#022c22">Shape Wizard</div><div class="mq-desc">Calculate the area of 3 shapes</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--m-dark)">+180 XP</div><div class="mq-gem">+6 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq mmq" data-mqid="m-frac" onclick="completeMQ(this,'#059669',300,12)"><div class="mq-ico" style="background:var(--m-light);border-color:var(--m-border)">üß©</div><div class="mq-body"><div class="mq-name" style="color:#022c22">Fraction Fighter</div><div class="mq-desc">Solve 5 fraction problems</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--m-dark)">+300 XP</div><div class="mq-gem">+12 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq mmq" data-mqid="m-word" onclick="completeMQ(this,'#059669',250,10)"><div class="mq-ico" style="background:var(--m-light);border-color:var(--m-border)">üéØ</div><div class="mq-body"><div class="mq-name" style="color:#022c22">Word Problem Warrior</div><div class="mq-desc">Solve 3 word problems today</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--m-dark)">+250 XP</div><div class="mq-gem">+10 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq mmq" data-mqid="m-speed" onclick="completeMQ(this,'#059669',400,18)"><div class="mq-ico" style="background:var(--m-light);border-color:var(--m-border)">üî¢</div><div class="mq-body"><div class="mq-name" style="color:#022c22">Speed Math</div><div class="mq-desc">Complete 10 problems in 5 minutes</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--m-dark)">+400 XP</div><div class="mq-gem">+18 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq mmq" data-mqid="m-meas" onclick="completeMQ(this,'#059669',350,15)"><div class="mq-ico" style="background:var(--m-light);border-color:var(--m-border)">üå°Ô∏è</div><div class="mq-body"><div class="mq-name" style="color:#022c22">Measurement Master</div><div class="mq-desc">Convert between 5 different units</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--m-dark)">+350 XP</div><div class="mq-gem">+15 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    </div>
    <div class="mod-sub" id="m-problems">
      <div style="background:var(--m-light);border-radius:14px;padding:12px 14px;margin-bottom:14px;font-size:12px;color:#2a6a4a;font-weight:800;line-height:1.5;border:2px solid var(--m-border)">üßÆ Answer each equation correctly to earn XP & Gems! New problems every visit.</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div class="sec-lbl" style="margin:0">Practice Problems</div>
        <button onclick="generateMathProblems()" style="padding:6px 14px;background:linear-gradient(135deg,#3aaa80,#5bcca0);color:#fff;border:none;border-radius:20px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;cursor:pointer;box-shadow:0 3px 0 #2a8a60;">üîÑ New Problems</button>
      </div>
      <div id="mathProblemsList"></div>
    </div>
    <div class="mod-sub" id="m-badges"><div id="mathBadgesContent"></div></div>
  </div>
</div>

<!-- SCIENCE SCREEN -->
<div class="screen" id="scienceScreen">
  <div class="mod-header">
    <button class="back-btn" onclick="goBack()" style="background:rgba(124,58,237,.08)">‚Üê</button>
    <div class="mod-title-group"><div class="mod-realm-lbl" style="color:var(--sc-dark)">SkillTree ‚Üí Realm 4</div><div class="mod-title" style="color:#1e0040">Science Realm üî¨ <span class="grade-badge" id="sciGradeBadge" onclick="openGradeSheet()">Gr.6</span></div></div>
    <div class="mod-icon si">üî¨</div>
  </div>
  <div class="mod-content">
    <div class="pill-bar">
      <button class="pill active" id="sPill-quests" onclick="switchModTab('s','quests',this)" style="background:var(--sc-light);color:var(--sc-dark);border-color:var(--sc-border)">‚öîÔ∏è Quests</button>
      <button class="pill" id="sPill-lab" onclick="switchModTab('s','lab',this)" style="background:#f5f3ff;color:#8b6fb8;border-color:#c4b5fd">üß™ Lab</button>
      <button class="pill" id="sPill-badges" onclick="switchModTab('s','badges',this)" style="background:#f5f3ff;color:#8b6fb8;border-color:#c4b5fd">üèÖ Badges</button>
    </div>
    <div class="mod-sub active" id="s-quests">
      <div class="xp-banner" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6,#a78bfa)">
        <div class="xpb-lbl" id="sXpBannerLbl">SCIENCE LEVEL 1</div>
        <div class="xpb-num" id="sXpBannerNum">0 <span>/ 800 XP</span></div>
        <div class="xpb-track"><div class="xpb-fill" id="sXpFill" style="width:0%"></div></div>
        <div class="xpb-sub" id="sXpBannerSub">Conduct your first experiment! üî¨</div>
      </div>
      <div class="gem-bar" style="background:var(--sc-light);border-color:var(--sc-border)"><div class="gem-bar-ico">üíé</div><div class="gem-bar-txt" style="color:#5b21b6">Gems collected!</div><div class="gem-bar-count" id="sGemCount">0</div></div>
      <div class="sec-lbl">Daily Science Quests</div>
      <div class="mq smq" data-mqid="s-plant" onclick="completeMQ(this,'#7c3aed',130,5)"><div class="mq-ico" style="background:var(--sc-light);border-color:var(--sc-border)">üå±</div><div class="mq-body"><div class="mq-name" style="color:#1e0040">Plant Observer</div><div class="mq-desc">Study and draw a plant's parts</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--sc-dark)">+130 XP</div><div class="mq-gem">+5 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq smq" data-mqid="s-circuit" onclick="completeMQ(this,'#7c3aed',200,8)"><div class="mq-ico" style="background:var(--sc-light);border-color:var(--sc-border)">‚ö°</div><div class="mq-body"><div class="mq-name" style="color:#1e0040">Circuit Builder</div><div class="mq-desc">Build a simple electrical circuit</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--sc-dark)">+200 XP</div><div class="mq-gem">+8 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq smq" data-mqid="s-earth" onclick="completeMQ(this,'#7c3aed',160,6)"><div class="mq-ico" style="background:var(--sc-light);border-color:var(--sc-border)">üåç</div><div class="mq-body"><div class="mq-name" style="color:#1e0040">Earth Explorer</div><div class="mq-desc">Learn about 3 types of rock formations</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--sc-dark)">+160 XP</div><div class="mq-gem">+6 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq smq" data-mqid="s-cell" onclick="completeMQ(this,'#7c3aed',280,12)"><div class="mq-ico" style="background:var(--sc-light);border-color:var(--sc-border)">üß¨</div><div class="mq-body"><div class="mq-name" style="color:#1e0040">Cell Scientist</div><div class="mq-desc">Study plant vs animal cell differences</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--sc-dark)">+280 XP</div><div class="mq-gem">+12 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq smq" data-mqid="s-space" onclick="completeMQ(this,'#7c3aed',250,10)"><div class="mq-ico" style="background:var(--sc-light);border-color:var(--sc-border)">üî≠</div><div class="mq-body"><div class="mq-name" style="color:#1e0040">Space Cadet</div><div class="mq-desc">Learn about 5 planets in our solar system</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--sc-dark)">+250 XP</div><div class="mq-gem">+10 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq smq" data-mqid="s-lab1" onclick="completeMQ(this,'#7c3aed',350,15)"><div class="mq-ico" style="background:var(--sc-light);border-color:var(--sc-border)">üß™</div><div class="mq-body"><div class="mq-name" style="color:#1e0040">Lab Assistant</div><div class="mq-desc">Complete a home science experiment</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--sc-dark)">+350 XP</div><div class="mq-gem">+15 üíé</div></div><div class="mq-check">‚úÖ</div></div>
      <div class="mq smq" data-mqid="s-chem" onclick="completeMQ(this,'#7c3aed',400,18)"><div class="mq-ico" style="background:var(--sc-light);border-color:var(--sc-border)">‚öóÔ∏è</div><div class="mq-body"><div class="mq-name" style="color:#1e0040">Chemistry Apprentice</div><div class="mq-desc">Learn about atoms and molecules</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--sc-dark)">+400 XP</div><div class="mq-gem">+18 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    </div>
    <div class="mod-sub" id="s-lab">
      <div style="background:var(--sc-light);border-radius:14px;padding:12px 14px;margin-bottom:14px;font-size:12px;color:#5a3a8a;font-weight:800;line-height:1.5;border:2px solid var(--sc-border)">üî¨ Pick the correct answer to earn XP & Gems! Fresh questions every visit.</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div class="sec-lbl" style="margin:0">Lab Questions</div>
        <button onclick="generateScienceProblems()" style="padding:6px 14px;background:linear-gradient(135deg,#9b6fd4,#b48ee8);color:#fff;border:none;border-radius:20px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;cursor:pointer;box-shadow:0 3px 0 #7a50b0;">üîÑ New Questions</button>
      </div>
      <div id="scienceProblemsList"></div>
    </div>
    <div class="mod-sub" id="s-badges"><div id="scienceBadgesContent"></div></div>
  </div>
</div>


<!-- FRENCH SCREEN -->
<div class="screen lang-screen" id="frenchScreen">
  <div class="mod-header" style="background:linear-gradient(135deg,#e8a87c,#d4703a)">
    <button class="back-btn" onclick="goBack()" style="background:rgba(255,255,255,.15);color:#fff">‚Üê</button>
    <div class="mod-title-group">
      <div class="mod-realm-lbl" style="color:rgba(255,255,255,.75)">SkillTree ‚Üí Realm 5</div>
      <div class="mod-title" style="color:#fff">French Realm üá´üá∑</div>
    </div>
    <div class="mod-icon" style="background:rgba(255,255,255,.2);color:#fff">ü•ê</div>
  </div>
  <div class="pill-bar" style="background:#fff8f2;border-bottom:1.5px solid #f7cfa8;padding:10px 16px 10px;margin-bottom:0;">
    <button class="lang-mode-btn active" id="frPill-vocab" onclick="switchLangTab('fr','vocab',this)" style="background:var(--fr-light);color:var(--fr-dark);border-color:var(--fr-border)">üìö Vocab</button>
    <button class="lang-mode-btn" id="frPill-quiz" onclick="switchLangTab('fr','quiz',this)" style="background:#fff8f2;color:#c4683a;border-color:#f7cfa8">üéØ Quiz</button>
    <button class="lang-mode-btn" id="frPill-quests" onclick="switchLangTab('fr','quests',this)" style="background:#fff8f2;color:#c4683a;border-color:#f7cfa8">‚öîÔ∏è Quests</button>
  </div>
  <div class="mod-content" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
  <!-- VOCAB TAB -->
  <div class="mod-sub active" id="fr-vocab" style="display:block">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div class="sec-lbl" style="margin:0">French Vocabulary</div>
      <button onclick="loadVocab('fr')" style="padding:6px 14px;background:linear-gradient(135deg,#e8a87c,#d4703a);color:#fff;border:none;border-radius:20px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;cursor:pointer;">üîÑ New Set</button>
    </div>
    <div id="frVocabList"></div>
  </div>
  <!-- QUIZ TAB -->
  <div class="mod-sub" id="fr-quiz" style="display:none">
    <div style="background:var(--fr-light);border-radius:14px;padding:12px 14px;margin-bottom:12px;font-size:12px;color:var(--fr-dark);font-weight:800;border:2px solid var(--fr-border)">üéØ New random quiz every time! Test your French skills and earn XP.</div>
    <div id="frQuizContent"></div>
    <button onclick="loadLangQuiz('fr')" style="width:100%;padding:12px;background:linear-gradient(135deg,#e8a87c,#d4703a);color:#fff;border:none;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 0 #a84a1a;margin-top:10px;">‚ú® Generate New Quiz</button>
  </div>
  <!-- QUESTS TAB -->
  <div class="mod-sub" id="fr-quests" style="display:none">
    <div class="xp-banner" style="background:linear-gradient(135deg,#e8a87c,#d4703a,#c45830)">
      <div class="xpb-lbl" id="frXpBannerLbl">FRENCH LEVEL 1</div>
      <div class="xpb-num" id="frXpBannerNum">0 <span>/ 600 XP</span></div>
      <div class="xpb-track"><div class="xpb-fill" id="frXpFill" style="width:0%"></div></div>
      <div class="xpb-sub" id="frXpBannerSub">Bonjour! Start your French journey! ü•ê</div>
    </div>
    <div class="sec-lbl">Daily French Quests</div>
    <div class="mq" data-mqid="fr-bonjour" onclick="completeLangMQ(this,'#d4703a',120,4,'fr')"><div class="mq-ico" style="background:var(--fr-light);border-color:var(--fr-border)">üëã</div><div class="mq-body"><div class="mq-name" style="color:#5a2810">Bonjour!</div><div class="mq-desc">Learn 5 French greetings</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--fr-dark)">+120 XP</div><div class="mq-gem">+4 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="fr-numbers" onclick="completeLangMQ(this,'#d4703a',150,5,'fr')"><div class="mq-ico" style="background:var(--fr-light);border-color:var(--fr-border)">üî¢</div><div class="mq-body"><div class="mq-name" style="color:#5a2810">Les Chiffres</div><div class="mq-desc">Count 1‚Äì20 in French</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--fr-dark)">+150 XP</div><div class="mq-gem">+5 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="fr-colors" onclick="completeLangMQ(this,'#d4703a',130,5,'fr')"><div class="mq-ico" style="background:var(--fr-light);border-color:var(--fr-border)">üé®</div><div class="mq-body"><div class="mq-name" style="color:#5a2810">Les Couleurs</div><div class="mq-desc">Learn 8 colors in French</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--fr-dark)">+130 XP</div><div class="mq-gem">+5 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="fr-food" onclick="completeLangMQ(this,'#d4703a',180,7,'fr')"><div class="mq-ico" style="background:var(--fr-light);border-color:var(--fr-border)">üçΩÔ∏è</div><div class="mq-body"><div class="mq-name" style="color:#5a2810">La Cuisine</div><div class="mq-desc">Learn 10 food words in French</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--fr-dark)">+180 XP</div><div class="mq-gem">+7 üíé</div></div><div class="mq-check">‚úÖ</div></div><div class="mq-body"><div class="mq-name" style="color:#5a2810">AI Conversation</div><div class="mq-desc">Have a 5-message chat with the AI tutor</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--fr-dark)">+300 XP</div><div class="mq-gem">+12 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="fr-quiz-pass" onclick="completeLangMQ(this,'#d4703a',250,10,'fr')"><div class="mq-ico" style="background:var(--fr-light);border-color:var(--fr-border)">üéØ</div><div class="mq-body"><div class="mq-name" style="color:#5a2810">Quiz Champion</div><div class="mq-desc">Score 80%+ on a French quiz</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--fr-dark)">+250 XP</div><div class="mq-gem">+10 üíé</div></div><div class="mq-check">‚úÖ</div></div>
  </div>
  </div><!-- end mod-content -->
</div>

<!-- SPANISH SCREEN -->
<div class="screen lang-screen" id="spanishScreen">
  <div class="mod-header" style="background:linear-gradient(135deg,#7cc4e8,#3a80c4)">
    <button class="back-btn" onclick="goBack()" style="background:rgba(255,255,255,.15);color:#fff">‚Üê</button>
    <div class="mod-title-group">
      <div class="mod-realm-lbl" style="color:rgba(255,255,255,.75)">SkillTree ‚Üí Realm 6</div>
      <div class="mod-title" style="color:#fff">Spanish Realm üá™üá∏</div>
    </div>
    <div class="mod-icon" style="background:rgba(255,255,255,.2);color:#fff">üåÆ</div>
  </div>
  <div class="pill-bar" style="background:#f0f8ff;border-bottom:1.5px solid #a8d8f7;padding:10px 16px 10px;margin-bottom:0;">
    <button class="lang-mode-btn active" id="esPill-vocab" onclick="switchLangTab('es','vocab',this)" style="background:var(--es-light);color:var(--es-dark);border-color:var(--es-border)">üìö Vocab</button>
    <button class="lang-mode-btn" id="esPill-quiz" onclick="switchLangTab('es','quiz',this)" style="background:#f0f8ff;color:#3a80c4;border-color:#a8d8f7">üéØ Quiz</button>
    <button class="lang-mode-btn" id="esPill-quests" onclick="switchLangTab('es','quests',this)" style="background:#f0f8ff;color:#3a80c4;border-color:#a8d8f7">‚öîÔ∏è Quests</button>
  </div>
  <div class="mod-content" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
  <!-- VOCAB TAB -->
  <div class="mod-sub active" id="es-vocab" style="display:block">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div class="sec-lbl" style="margin:0">Spanish Vocabulary</div>
      <button onclick="loadVocab('es')" style="padding:6px 14px;background:linear-gradient(135deg,#7cc4e8,#3a80c4);color:#fff;border:none;border-radius:20px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;cursor:pointer;">üîÑ New Set</button>
    </div>
    <div id="esVocabList"></div>
  </div>
  <!-- QUIZ TAB -->
  <div class="mod-sub" id="es-quiz" style="display:none">
    <div style="background:var(--es-light);border-radius:14px;padding:12px 14px;margin-bottom:12px;font-size:12px;color:var(--es-dark);font-weight:800;border:2px solid var(--es-border)">üéØ New random quiz every time! Test your Spanish skills and earn XP.</div>
    <div id="esQuizContent"></div>
    <button onclick="loadLangQuiz('es')" style="width:100%;padding:12px;background:linear-gradient(135deg,#7cc4e8,#3a80c4);color:#fff;border:none;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 0 #1a5090;margin-top:10px;">‚ú® Generate New Quiz</button>
  </div>
  <!-- QUESTS TAB -->
  <div class="mod-sub" id="es-quests" style="display:none">
    <div class="xp-banner" style="background:linear-gradient(135deg,#7cc4e8,#3a80c4,#1a60a0)">
      <div class="xpb-lbl" id="esXpBannerLbl">SPANISH LEVEL 1</div>
      <div class="xpb-num" id="esXpBannerNum">0 <span>/ 600 XP</span></div>
      <div class="xpb-track"><div class="xpb-fill" id="esXpFill" style="width:0%"></div></div>
      <div class="xpb-sub" id="esXpBannerSub">¬°Hola! Start your Spanish journey! üåÆ</div>
    </div>
    <div class="sec-lbl">Daily Spanish Quests</div>
    <div class="mq" data-mqid="es-hola" onclick="completeLangMQ(this,'#3a80c4',120,4,'es')"><div class="mq-ico" style="background:var(--es-light);border-color:var(--es-border)">üëã</div><div class="mq-body"><div class="mq-name" style="color:#103060">¬°Hola!</div><div class="mq-desc">Learn 5 Spanish greetings</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--es-dark)">+120 XP</div><div class="mq-gem">+4 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="es-numbers" onclick="completeLangMQ(this,'#3a80c4',150,5,'es')"><div class="mq-ico" style="background:var(--es-light);border-color:var(--es-border)">üî¢</div><div class="mq-body"><div class="mq-name" style="color:#103060">Los N√∫meros</div><div class="mq-desc">Count 1‚Äì20 in Spanish</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--es-dark)">+150 XP</div><div class="mq-gem">+5 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="es-family" onclick="completeLangMQ(this,'#3a80c4',140,5,'es')"><div class="mq-ico" style="background:var(--es-light);border-color:var(--es-border)">üë®‚Äçüë©‚Äçüëß</div><div class="mq-body"><div class="mq-name" style="color:#103060">La Familia</div><div class="mq-desc">Learn family member words</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--es-dark)">+140 XP</div><div class="mq-gem">+5 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="es-food" onclick="completeLangMQ(this,'#3a80c4',180,7,'es')"><div class="mq-ico" style="background:var(--es-light);border-color:var(--es-border)">üåÆ</div><div class="mq-body"><div class="mq-name" style="color:#103060">La Comida</div><div class="mq-desc">Learn 10 food words in Spanish</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--es-dark)">+180 XP</div><div class="mq-gem">+7 üíé</div></div><div class="mq-check">‚úÖ</div></div><div class="mq-body"><div class="mq-name" style="color:#103060">AI Conversaci√≥n</div><div class="mq-desc">Have a 5-message chat with the AI tutor</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--es-dark)">+300 XP</div><div class="mq-gem">+12 üíé</div></div><div class="mq-check">‚úÖ</div></div>
    <div class="mq" data-mqid="es-quiz-pass" onclick="completeLangMQ(this,'#3a80c4',250,10,'es')"><div class="mq-ico" style="background:var(--es-light);border-color:var(--es-border)">üéØ</div><div class="mq-body"><div class="mq-name" style="color:#103060">Quiz Campe√≥n</div><div class="mq-desc">Score 80%+ on a Spanish quiz</div></div><div class="mq-rewards"><div class="mq-xp" style="color:var(--es-dark)">+250 XP</div><div class="mq-gem">+10 üíé</div></div><div class="mq-check">‚úÖ</div></div>
  </div>
  </div><!-- end mod-content -->
</div>

<!-- MAP PANELS -->
<div class="map-panel" id="map-pet">
  <div class="map-panel-header"><button class="map-panel-back" onclick="showMapPanel('map-world')">‚Üê</button><div class="map-panel-title">üêæ Your Study Companion</div></div>
  <div id="petPanelContent"></div>
</div>
<div class="map-panel" id="map-progress">
  <div class="map-panel-header"><button class="map-panel-back" onclick="showMapPanel('map-world')">‚Üê</button><div class="map-panel-title">üìä Progress</div></div>
  <div id="progressPanelContent"></div>
</div>
<div class="map-panel" id="map-badges">
  <div class="map-panel-header"><button class="map-panel-back" onclick="showMapPanel('map-world')">‚Üê</button><div class="map-panel-title">üèÖ Badges</div></div>
  <div id="badgesPanelContent"></div>
</div>
<div class="map-panel" id="map-profile">
  <div class="map-panel-header"><button class="map-panel-back" onclick="showMapPanel('map-world')">‚Üê</button><div class="map-panel-title">üë§ Profile</div></div>
  <div id="profilePanelContent"></div>
</div>

<!-- LEVEL UP OVERLAY -->
<div class="lvlup-overlay" id="lvlupOverlay">
  <div class="lvlup-particles" id="lvlupParticles"></div>
  <div class="lvlup-burst" id="lvlupBurst">üìñ</div>
  <div class="lvlup-label">LEVEL UP!</div>
  <div class="lvlup-num" id="lvlupNum">Level 2</div>
  <div class="lvlup-subtitle" id="lvlupTitle">Apprentice</div>
  <div class="lvlup-unlock" id="lvlupUnlock">üéâ New title unlocked!</div>
  <button class="lvlup-btn" onclick="closeLevelUp()">Awesome! Let's go! üöÄ</button>
</div>

<!-- FIX #6: Confirm Delete Dialog -->
<div class="confirm-dialog" id="confirmDialog">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirmIcon">üóëÔ∏è</div>
    <div class="confirm-title" id="confirmTitle">Delete this?</div>
    <div class="confirm-msg" id="confirmMsg">This can't be undone.</div>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-ok" id="confirmOkBtn" onclick="confirmOkAction()">Delete</button>
    </div>
  </div>
</div>

<!-- FIX #7: Network error toast -->
<div class="net-toast" id="netToast">‚ö†Ô∏è Couldn't reach server. Try again.</div>

<div class="overlay" id="overlay" onclick="closeSheets()"></div>

<!-- SHEETS -->
<div class="sheet" id="addBookSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Add a Book üìö</div>
  <div class="sheet-sub">What are you reading, scholar?</div>
  <button onclick="openScanSheet()" style="width:100%;padding:12px;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;border:none;border-radius:14px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 4px 0 #5b21b6;margin-bottom:14px;display:flex;align-items:center;justify-content:center;gap:8px;">üì∑ Scan Book Barcode</button>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px"><div style="flex:1;height:1.5px;background:#e7e5e4"></div><div style="font-size:11px;color:#a8a29e;font-weight:700">OR ENTER MANUALLY</div><div style="flex:1;height:1.5px;background:#e7e5e4"></div></div>
  <div class="form-row"><label class="form-lbl">Book Title *</label><input class="form-input" id="bookTitle" placeholder="e.g. Percy Jackson"/></div>
  <div class="form-row"><label class="form-lbl">Author</label><input class="form-input" id="bookAuthor" placeholder="e.g. Rick Riordan"/></div>
  <div class="form-row-2">
    <div><label class="form-lbl">Genre</label><select class="form-select" id="bookGenre"><option>Fantasy</option><option>Sci-Fi</option><option>Mystery</option><option>Adventure</option><option>Romance</option><option>Horror</option><option>Non-Fiction</option><option>Other</option></select></div>
    <div><label class="form-lbl">Status</label><select class="form-select" id="bookStatus"><option value="reading">Reading</option><option value="completed">Completed</option><option value="want">Want to Read</option></select></div>
  </div>
  <div class="form-row-2">
    <div><label class="form-lbl">Pages Read</label><input class="form-input" id="bookPagesRead" type="number" placeholder="0" min="0"/></div>
    <div><label class="form-lbl">Total Pages</label><input class="form-input" id="bookPagesTotal" type="number" placeholder="300" min="1"/></div>
  </div>
  <button class="r-confirm" onclick="saveBook()">Add to Quest Log ‚ú®</button>
</div>

<!-- SCANNER SHEET -->
<div class="sheet" id="scanSheet" style="padding:0;border-radius:26px 26px 0 0;max-height:95vh;display:flex;flex-direction:column;">
  <div style="padding:16px 22px 12px;flex-shrink:0;">
    <div class="sheet-handle"></div>
    <div class="sheet-title">üì∑ Scan a Book</div>
    <div class="sheet-sub" id="scanStatus">Point your camera at the barcode on the back of the book</div>
  </div>
  <div id="scanViewfinder" style="position:relative;width:100%;background:#000;flex-shrink:0;height:260px;overflow:hidden;">
    <video id="scanVideo" style="width:100%;height:100%;object-fit:cover;" playsinline muted></video>
    <div style="position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;">
      <div style="position:relative;width:72%;height:110px;border:3px solid #fde68a;border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,.5);">
        <div style="position:absolute;top:-3px;left:-3px;width:20px;height:20px;border-top:4px solid #f59e0b;border-left:4px solid #f59e0b;border-radius:3px 0 0 0"></div>
        <div style="position:absolute;top:-3px;right:-3px;width:20px;height:20px;border-top:4px solid #f59e0b;border-right:4px solid #f59e0b;border-radius:0 3px 0 0"></div>
        <div style="position:absolute;bottom:-3px;left:-3px;width:20px;height:20px;border-bottom:4px solid #f59e0b;border-left:4px solid #f59e0b;border-radius:0 0 0 3px"></div>
        <div style="position:absolute;bottom:-3px;right:-3px;width:20px;height:20px;border-bottom:4px solid #f59e0b;border-right:4px solid #f59e0b;border-radius:0 0 3px 0"></div>
        <div style="position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#f59e0b,transparent);animation:scanAnim 1.8s ease-in-out infinite;top:0;"></div>
      </div>
    </div>
    <div id="scanSpinner" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.75);flex-direction:column;align-items:center;justify-content:center;gap:10px;font-size:14px;font-weight:800;color:#fff;">
      <div style="width:38px;height:38px;border:3px solid rgba(255,255,255,.2);border-top-color:#fde68a;border-radius:50%;animation:spin 0.8s linear infinite"></div>
      Looking up book‚Ä¶
    </div>
  </div>
  <div style="padding:14px 22px 30px;overflow-y:auto;flex:1;">
    <div style="background:#fef3c7;border:2px solid #f0e4c0;border-radius:12px;padding:10px 14px;font-size:12px;color:#92400e;font-weight:700;margin-bottom:14px;line-height:1.5" id="scanTip">üí° Tip: Hold the book steady with the barcode inside the yellow box. Works best in good lighting!</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;align-items:flex-end;">
      <div style="flex:1"><label class="form-lbl" style="color:#44403c">Manual ISBN</label><input class="form-input" id="isbnInput" type="text" placeholder="e.g. 9780439023528"/></div>
      <button onclick="lookupISBN(document.getElementById('isbnInput').value)" style="padding:11px 16px;background:linear-gradient(135deg,#d97706,#f59e0b);color:#fff;border:none;border-radius:12px;font-size:13px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;white-space:nowrap;box-shadow:0 3px 0 #b45309;flex-shrink:0;">Look up</button>
    </div>
    <!-- FIX #2: Scan result review form ‚Äî user can inspect/edit before saving -->
    <div id="scanResultArea" style="display:none;background:#f0fdf4;border:2px solid #86efac;border-radius:16px;padding:14px;margin-bottom:12px;">
      <div style="font-size:13px;font-weight:800;color:#166534;margin-bottom:10px;">üìö Book found! Check the details:</div>
      <div class="form-row"><label class="form-lbl">Title</label><input class="form-input" id="scanBookTitle" placeholder="Title"/></div>
      <div class="form-row"><label class="form-lbl">Author</label><input class="form-input" id="scanBookAuthor" placeholder="Author"/></div>
      <div class="form-row-2">
        <div><label class="form-lbl">Genre</label><select class="form-select" id="scanBookGenre"><option>Fantasy</option><option>Sci-Fi</option><option>Mystery</option><option>Adventure</option><option>Romance</option><option>Horror</option><option>Non-Fiction</option><option>Other</option></select></div>
        <div><label class="form-lbl">Total Pages</label><input class="form-input" id="scanBookPages" type="number" placeholder="300" min="1"/></div>
      </div>
      <button onclick="confirmScanResult()" style="width:100%;padding:13px;background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;border:none;border-radius:14px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 4px 0 #15803d;">Add to Library ‚ú®</button>
    </div>
    <button onclick="closeScanSheet()" style="width:100%;padding:13px;background:#f5f5f4;color:#44403c;border:2px solid #e7e5e4;border-radius:14px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;">Cancel</button>
  </div>
</div>

<div class="sheet" id="logSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Log Pages üìñ</div>
  <div class="sheet-sub" id="logSheetSub">How many pages did you read today?</div>
  <!-- FIX #3: Warning shown when no active book -->
  <div id="noBookWarning" style="display:none;background:#fff7ed;border:2px solid #fed7aa;border-radius:12px;padding:10px 14px;font-size:12px;color:#9a3412;font-weight:700;margin-bottom:12px;line-height:1.5">‚ö†Ô∏è No active book! Pages logged won't count toward a book. Add one in the Library tab first.</div>
  <div class="stepper">
    <button class="step-btn" onclick="changePages(-5)">‚àí5</button>
    <button class="step-btn" onclick="changePages(-1)">‚àí</button>
    <div class="page-num" id="pageNum">10</div>
    <button class="step-btn" onclick="changePages(1)">+</button>
    <button class="step-btn" onclick="changePages(5)">+5</button>
  </div>
  <div class="earn-prev" id="earnPrev">You'll earn +100 XP and +10 üíé!</div>
  <button class="r-confirm" onclick="confirmLog()">Claim XP &amp; Gems ‚ú®</button>
</div>

<div class="sheet" id="writeSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">New Entry ‚úçÔ∏è</div>
  <div class="form-row"><label class="form-lbl">Title</label><input class="form-input w-focus" id="entryTitle" placeholder="Give your entry a name‚Ä¶"/></div>
  <div id="promptBubble" style="display:none;background:var(--w-light);border-radius:12px;padding:10px 12px;font-size:12px;color:#0e7490;font-weight:700;line-height:1.5;margin-bottom:12px;border:2px solid var(--w-border)"></div>
  <div class="form-row"><label class="form-lbl">Your Writing</label><textarea class="form-input w-focus" id="entryBody" placeholder="Start writing your story here‚Ä¶" oninput="updateWordCount()"></textarea></div>
  <div class="wc-display" id="wcDisplay">0 words ¬∑ write 50+ for full XP</div>
  <button class="w-confirm" onclick="saveEntry()">Save Entry &amp; Claim XP ‚ú®</button>
</div>

<div class="sheet" id="gradeSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">üéì Set Your Grade</div>
  <div class="sheet-sub">Questions will match your grade level!</div>
  <div class="grade-grid" id="gradeGrid"></div>
  <button class="r-confirm" onclick="saveGrade()">üéì Save Grade</button>
</div>
<div class="sheet" id="streakSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">üî• Daily Streak</div>
  <div class="sheet-sub">Update your study streak</div>
  <div class="streak-stepper">
    <button class="s-btn" onclick="changeStreak(-1)">‚àí</button>
    <div class="streak-num" id="streakNum">0</div>
    <button class="s-btn" onclick="changeStreak(1)">+</button>
  </div>
  <button class="streak-confirm" onclick="saveStreak()">Save Streak üî•</button>
</div>



<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(80,40,100,.6);backdrop-filter:blur(8px);align-items:center;justify-content:center;">

  <!-- LOGIN SCREEN -->
  <div id="adminLogin" style="background:#fff;border-radius:28px;padding:30px 26px 28px;max-width:320px;width:92%;box-shadow:0 24px 80px rgba(100,40,140,.25);">
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:40px;margin-bottom:8px;">üîê</div>
      <div style="font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;color:#5a3a6a">Admin Access</div>
      <div style="font-size:12px;color:#b090c0;font-weight:700;margin-top:2px">Enter credentials to continue</div>
    </div>
    <div id="adminLoginError" style="display:none;background:#fde8f0;border:2px solid #f0a8c8;border-radius:12px;padding:8px 12px;font-size:12px;font-weight:800;color:#c04060;margin-bottom:12px;text-align:center;">‚ùå Wrong username or password</div>
    <div style="margin-bottom:12px;">
      <label style="font-size:11px;font-weight:800;color:#9a7aaa;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Username</label>
      <input id="adminUser" type="text" placeholder="Enter username‚Ä¶" autocomplete="off"
        style="width:100%;padding:11px 14px;border:2px solid rgba(200,180,220,.4);border-radius:12px;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;color:#3d2d45;background:#fdf8ff;outline:none;box-sizing:border-box;"
        onkeydown="if(event.key==='Enter')document.getElementById('adminPass').focus()">
    </div>
    <div style="margin-bottom:20px;">
      <label style="font-size:11px;font-weight:800;color:#9a7aaa;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Password</label>
      <div style="position:relative;">
        <input id="adminPass" type="password" placeholder="Enter password‚Ä¶" autocomplete="off"
          style="width:100%;padding:11px 44px 11px 14px;border:2px solid rgba(200,180,220,.4);border-radius:12px;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;color:#3d2d45;background:#fdf8ff;outline:none;box-sizing:border-box;"
          onkeydown="if(event.key==='Enter')checkAdminLogin()">
        <button onclick="toggleAdminPassVis()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:18px;cursor:pointer;color:#b090c0;" id="adminPassEye">üëÅÔ∏è</button>
      </div>
    </div>
    <button onclick="checkAdminLogin()" style="width:100%;padding:13px;background:linear-gradient(135deg,#9060c0,#c060a0);color:#fff;border:none;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 0 #6a3a8a;margin-bottom:10px;">üîì Login</button>
    <button onclick="closeAdminPanel()" style="width:100%;padding:11px;background:#f5f0ff;color:#9060c0;border:2px solid #d8c4f8;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;cursor:pointer;">Cancel</button>
  </div>

  <!-- ADMIN CONTENT (shown after login) -->
  <div id="adminContent" style="display:none;background:#fff;border-radius:28px;padding:24px 22px 28px;max-width:340px;width:92%;box-shadow:0 24px 80px rgba(100,40,140,.25);max-height:90vh;overflow-y:auto;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
      <div style="font-size:30px">üå≥</div>
      <div>
        <div style="font-family:'Fredoka',sans-serif;font-size:22px;font-weight:700;color:#5a3a6a">Admin Panel</div>
        <div style="font-size:11px;color:#b090c0;font-weight:700">Developer cheat console üõ†Ô∏è</div>
      </div>
      <button onclick="closeAdminPanel()" style="margin-left:auto;width:34px;height:34px;border-radius:50%;border:2px solid #e8d8f0;background:#f5f0ff;color:#9060c0;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
    </div>
    <div style="height:2px;background:linear-gradient(90deg,#f0a8c8,#a8c8f0,#5bcca0,#b48ee8);border-radius:10px;margin-bottom:18px;"></div>
    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#b090c0;margin-bottom:10px;">üîì Realm Unlocks</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px;">
      <button onclick="adminUnlockAll()" style="grid-column:1/-1;padding:12px;background:linear-gradient(135deg,#f0a8c8,#a8c8f0,#5bcca0,#b48ee8);color:#fff;border:none;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,.1);">‚ú® Unlock All Realms</button>
      <button onclick="adminUnlock('writing')" style="padding:10px;background:#f0f6ff;border:2px solid #a8c8f0;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:#3a5080;cursor:pointer;">‚úçÔ∏è Writing</button>
      <button onclick="adminUnlock('math')" style="padding:10px;background:#e8faf2;border:2px solid #5bcca0;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:#2a5a3a;cursor:pointer;">üî¢ Math</button>
      <button onclick="adminUnlock('science')" style="padding:10px;background:#f0e8ff;border:2px solid #b48ee8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:#4a2a6a;cursor:pointer;">üî¨ Science</button>
      <button onclick="adminUnlock('french')" style="padding:10px;background:#fff8f2;border:2px solid #f7cfa8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:#7a3010;cursor:pointer;">üá´üá∑ French</button>
      <button onclick="adminUnlock('spanish')" style="padding:10px;background:#f0f8ff;border:2px solid #a8d8f7;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:#103060;cursor:pointer;">üá™üá∏ Spanish</button>
      <button onclick="adminLockAll()" style="padding:10px;background:#fff0f0;border:2px solid #f0b8b8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:#a04040;cursor:pointer;">üîí Lock All</button>
    </div>
    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#b090c0;margin-bottom:10px;">‚ö° Grant XP</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px;">
      <button onclick="adminAddXP('reading',1000)" style="padding:10px;background:#fde8f2;border:2px solid #f0a8c8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#8a3060;cursor:pointer;">üìñ +1000 Reading</button>
      <button onclick="adminAddXP('writing',1000)" style="padding:10px;background:#f0f6ff;border:2px solid #a8c8f0;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#3a5080;cursor:pointer;">‚úçÔ∏è +1000 Writing</button>
      <button onclick="adminAddXP('math',1000)" style="padding:10px;background:#e8faf2;border:2px solid #5bcca0;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#2a5a3a;cursor:pointer;">üî¢ +1000 Math</button>
      <button onclick="adminAddXP('science',1000)" style="padding:10px;background:#f0e8ff;border:2px solid #b48ee8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#4a2a6a;cursor:pointer;">üî¨ +1000 Science</button>
      <button onclick="adminAddXP('all',5000)" style="grid-column:1/-1;padding:11px;background:linear-gradient(135deg,#fde8f2,#f0f6ff,#e8faf2,#f0e8ff);border:2px solid #d8c4f8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:#6a3a8a;cursor:pointer;">üåü +5000 XP All Realms</button>
    </div>
    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#b090c0;margin-bottom:10px;">üíé Bonus Items</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px;">
      <button onclick="adminAddGems(50)" style="padding:10px;background:#f0eaff;border:2px solid #d8c4f8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#7a50b0;cursor:pointer;">üíé +50 Gems</button>
      <button onclick="adminAddGems(500)" style="padding:10px;background:#f0eaff;border:2px solid #d8c4f8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#7a50b0;cursor:pointer;">üíé +500 Gems</button>
      <button onclick="adminSetStreak(30)" style="padding:10px;background:#fff0f0;border:2px solid #ffd0c8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#d07070;cursor:pointer;">üî• Streak 30</button>
      <button onclick="adminSetStreak(100)" style="padding:10px;background:#fff0f0;border:2px solid #ffd0c8;border-radius:12px;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:#d07070;cursor:pointer;">üî• Streak 100</button>
    </div>
    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#b090c0;margin-bottom:10px;">üéì Grade</div>
    <button id="adminGradeBtn" onclick="closeAdminPanel();openGradeSheet();" style="width:100%;padding:12px;background:linear-gradient(135deg,#fde8f2,#ffd8ec);border:2px solid #f0a8c8;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;color:#8a3060;cursor:pointer;margin-bottom:18px;">üéì Change Grade Level</button>
    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#e09090;margin-bottom:10px;">‚ö†Ô∏è Danger Zone</div>
    <button onclick="adminReset()" style="width:100%;padding:12px;background:#fff0f0;border:2px solid #f0b8b8;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;color:#c04040;cursor:pointer;">üóëÔ∏è Reset All Progress</button>
  </div>
</div>
<script>

// STATE
const DEFAULTS={playerName:'Scholar',gradeLevel:6,readingXP:0,writingXP:0,mathXP:0,scienceXP:0,frenchXP:0,spanishXP:0,gems:0,streak:0,
  lastReadingLevel:1,lastWritingLevel:1,lastMathLevel:1,lastScienceLevel:1,lastFrenchLevel:1,lastSpanishLevel:1,lastGlobalLevel:1,books:[],entries:[],completedMQs:[],frMsgCount:0,esMsgCount:0,frChatHistory:[],esChatHistory:[]};
function loadState(){try{return{...DEFAULTS,...JSON.parse(localStorage.getItem('stState1'))};}catch{return{...DEFAULTS};}}
let S=loadState();
let _saveScheduled=false;
function saveState(){
  if(_saveScheduled)return;_saveScheduled=true;
  Promise.resolve().then(()=>{localStorage.setItem('stState1',JSON.stringify(S));_saveScheduled=false;});
}

const XP_PER_PAGE=10;

// LEVEL SYSTEM ‚Äî global level 1-20, each realm spans 5 global levels
const GLOBAL_XP=[0,500,1200,2200,3500,5200,7200,9600,12400,15600,19200,23200,27600,32400,37600,43200,49200,55600,62400,69600];
const READ_LEVELS =[0,1000,2500,5000,9000,15000];
const WRITE_LEVELS=[0,500, 1200,2500,4500,8000];
const MATH_LEVELS =[0,800, 2000,4000,7000,11000];
const SCI_LEVELS  =[0,800, 2000,4000,7000,11000];
const GLOBAL_TITLES=['Novice','Learner','Seeker','Explorer','Scholar','Apprentice','Student','Analyst','Thinker','Sage','Craftsman','Expert','Mentor','Adept','Master','Luminary','Archmage','Visionary','Lore Master','Grand Scholar'];
const R_TITLES=['Page Turner','Bookworm','Chapter Chaser','Story Seeker','Word Wizard'];
const W_TITLES=['Scribbler','Storyteller','Wordsmith','Scribe','Bard'];
const M_TITLES=['Number Learner','Equation Solver','Formula Crafter','Math Wizard','Theorem Master'];
const SC_TITLES=['Lab Rookie','Hypothesis Hero','Data Scientist','Theory Crafter','Science Sage'];
const REALM_UNLOCK={writingScreen:5,mathScreen:10,scienceScreen:15,frenchScreen:6,spanishScreen:8};

function getLevel(xp,thr){let l=1;for(let i=1;i<thr.length;i++){if(xp>=thr[i])l=i+1;}return Math.min(l,thr.length-1);}
function getLevelProgress(xp,thr){const lv=getLevel(xp,thr),cur=thr[lv-1]||0,next=thr[lv]||thr[thr.length-1]+10000;return{lv,cur,next,pct:Math.min(100,((xp-cur)/(next-cur))*100)};}
function globalLevel(){return getLevel(S.readingXP+S.writingXP+S.mathXP+S.scienceXP+S.frenchXP+S.spanishXP,GLOBAL_XP);}
function globalProg(){return getLevelProgress(S.readingXP+S.writingXP+S.mathXP+S.scienceXP+S.frenchXP+S.spanishXP,GLOBAL_XP);}
function isRealmUnlocked(id){const req=REALM_UNLOCK[id];return!req||globalLevel()>=req;}

// PET SYSTEM
const PET_STAGES=[
  {min:0, emoji:'ü•ö',name:'Mystery Egg',    title:'Unhatched',        desc:'Keep studying to hatch your companion!',bg:'#f3e8ff',border:'#a855f7',tc:'#7e22ce',tb:'#f3e8ff'},
  {min:1, emoji:'üê£',name:'Study Hatchling',title:'Just Hatched! üéâ', desc:'Your companion is alive!',             bg:'#fef9c3',border:'#eab308',tc:'#854d0e',tb:'#fef9c3'},
  {min:3, emoji:'ü¶ä',name:'Curious Fox',    title:'Eager Learner',    desc:'Quick and clever, loves all subjects!', bg:'#ffedd5',border:'#f97316',tc:'#9a3412',tb:'#ffedd5'},
  {min:7, emoji:'ü¶â',name:'Wisdom Owl',     title:'Knowledge Keeper', desc:'Wise and watchful, masters every realm!',bg:'#f0fdf4',border:'#22c55e',tc:'#166534',tb:'#dcfce7'},
  {min:15,emoji:'üêâ',name:'Scholar Dragon', title:'Legendary Student',desc:'Ancient and powerful ‚Äî knowledge IS power!',bg:'#fef2f2',border:'#ef4444',tc:'#991b1b',tb:'#fee2e2'},
  {min:30,emoji:'üåü',name:'Cosmic Scholar', title:'Galaxy Brain ‚ú®',   desc:'You have transcended ‚Äî you ARE the lesson!',bg:'#f0f9ff',border:'#06b6d4',tc:'#164e63',tb:'#cffafe'},
];
const GENRE_TRAITS={
  'Fantasy':{t:'‚ú® Magic Aura',c:'#7e22ce',bg:'#f3e8ff',bc:'#a855f7'},
  'Sci-Fi':{t:'üöÄ Laser Eyes',c:'#164e63',bg:'#cffafe',bc:'#06b6d4'},
  'Mystery':{t:'üîç Detective Nose',c:'#374151',bg:'#f1f5f9',bc:'#64748b'},
  'Adventure':{t:'üó∫Ô∏è Explorer Spirit',c:'#166534',bg:'#f0fdf4',bc:'#22c55e'},
  'Horror':{t:'üëª Spooky Vibes',c:'#1f2937',bg:'#f9fafb',bc:'#4b5563'},
  'Romance':{t:'üíù Heartwarmer',c:'#9f1239',bg:'#fff1f2',bc:'#e11d48'},
  'Non-Fiction':{t:'üß† Big Brain',c:'#1e3a8a',bg:'#eff6ff',bc:'#3b82f6'},
  'Other':{t:'üìó Wild Card',c:'#365314',bg:'#f7fee7',bc:'#84cc16'},
};
function getPetData(){
  const done=S.books.filter(b=>b.status==='completed'),count=done.length;
  let stage=PET_STAGES[0];for(const s of PET_STAGES){if(count>=s.min)stage=s;}
  const gc={};done.forEach(b=>{gc[b.genre]=(gc[b.genre]||0)+1;});
  const topGenres=Object.entries(gc).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]);
  return{stage,topGenres,count,gc};
}
function getAvatarEmoji(){const{stage}=getPetData();return{'ü•ö':'üßô','üê£':'üßí','ü¶ä':'üßù','ü¶â':'üßô','üêâ':'üßô‚Äç‚ôÇÔ∏è','üåü':'üåü'}[stage.emoji]||'üßô';}
function renderPetPanel(){
  const{stage,topGenres,count,gc}=getPetData();
  const nextStage=PET_STAGES.find(s=>s.min>count),booksToNext=nextStage?nextStage.min-count:0;
  const traits=topGenres.map(g=>GENRE_TRAITS[g]).filter(Boolean);
  document.getElementById('petPanelContent').innerHTML=`<div class="pet-card" style="background:linear-gradient(135deg,${stage.bg},white);border-color:${stage.border}"><div class="pet-header"><div class="pet-emoji-wrap">${stage.emoji}</div><div class="pet-info"><div class="pet-title-chip" style="color:${stage.tc};background:${stage.tb};border-color:${stage.border}">${stage.title}</div><div class="pet-name" style="color:${stage.tc}">${stage.name}</div><div class="pet-desc" style="color:${stage.tc}">${stage.desc}</div></div></div>${traits.length?`<div style="font-size:11px;font-weight:800;color:${stage.tc};text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Genre Traits üîì</div><div class="trait-row">${traits.map(t=>`<div class="trait-chip" style="color:${t.c};background:${t.bg};border-color:${t.bc}">${t.t}</div>`).join('')}</div>`:`<div style="font-size:12px;color:#6b7280;font-weight:600;margin-top:6px">Complete books to unlock traits! üåü</div>`}</div>${nextStage?`<div style="background:#fff;border:2.5px solid ${nextStage.border}55;border-radius:18px;padding:16px;margin-bottom:12px"><div style="font-size:12px;font-weight:800;color:#374151;margin-bottom:10px">Next Evolution üîÆ</div><div style="display:flex;align-items:center;gap:12px"><div style="font-size:40px;filter:blur(5px);opacity:.5">${nextStage.emoji}</div><div style="flex:1"><div style="font-size:14px;font-weight:800;color:#374151;margin-bottom:5px">??? (${booksToNext} more book${booksToNext!==1?'s':''} away!)</div><div style="height:9px;background:#f3f4f6;border-radius:10px;overflow:hidden;border:1.5px solid #e5e7eb"><div style="height:100%;width:${Math.min(100,(count/nextStage.min)*100)}%;background:linear-gradient(90deg,${stage.border},${nextStage.border});border-radius:10px"></div></div><div style="font-size:11px;color:#6b7280;font-weight:700;margin-top:4px">${count} / ${nextStage.min} books</div></div></div></div>`:`<div style="background:linear-gradient(135deg,#fef9c3,#fde68a);border:2.5px solid #f59e0b;border-radius:18px;padding:18px;text-align:center;margin-bottom:12px"><div style="font-size:36px;margin-bottom:8px">üåü‚ú®üåü</div><div style="font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:#92400e">MAX EVOLUTION!</div></div>`}`;
}

// LEVEL UP
let lvlupQueue=[],lvlupShowing=false;
function checkLevelUp(){
  const gLv=globalLevel();
  if(gLv>(S.lastGlobalLevel||1)){
    const entry=Object.entries(REALM_UNLOCK).find(([,req])=>req===gLv);
    const msg=entry?`üîì ${entry[0].replace('Screen',' Realm')} UNLOCKED!`:`üéâ Title: "${GLOBAL_TITLES[gLv-1]||'Grand Scholar'}"!`;
    lvlupQueue.push({lv:gLv,title:GLOBAL_TITLES[gLv-1]||'Grand Scholar',burst:'üå≥',unlock:msg});
    S.lastGlobalLevel=gLv;
  }
  const rLv=getLevel(S.readingXP,READ_LEVELS);if(rLv>S.lastReadingLevel){lvlupQueue.push({lv:rLv,title:R_TITLES[rLv-1]||'Word Wizard',burst:'üìñ',unlock:`üìñ Reading: "${R_TITLES[rLv-1]||'Word Wizard'}"!`});S.lastReadingLevel=rLv;}
  const wLv=getLevel(S.writingXP,WRITE_LEVELS);if(wLv>S.lastWritingLevel){lvlupQueue.push({lv:wLv,title:W_TITLES[wLv-1]||'Bard',burst:'‚úçÔ∏è',unlock:`‚úçÔ∏è Writing: "${W_TITLES[wLv-1]||'Bard'}"!`});S.lastWritingLevel=wLv;}
  const mLv=getLevel(S.mathXP,MATH_LEVELS);if(mLv>S.lastMathLevel){lvlupQueue.push({lv:mLv,title:M_TITLES[mLv-1]||'Theorem Master',burst:'üî¢',unlock:`üî¢ Math: "${M_TITLES[mLv-1]||'Theorem Master'}"!`});S.lastMathLevel=mLv;}
  const sLv=getLevel(S.scienceXP,SCI_LEVELS);if(sLv>S.lastScienceLevel){lvlupQueue.push({lv:sLv,title:SC_TITLES[sLv-1]||'Science Sage',burst:'üî¨',unlock:`üî¨ Science: "${SC_TITLES[sLv-1]||'Science Sage'}"!`});S.lastScienceLevel=sLv;}
  const frLv=getLevel(S.frenchXP,LANG_LEVELS);if(frLv>S.lastFrenchLevel){lvlupQueue.push({lv:frLv,title:'French Lvl '+frLv,burst:'üá´üá∑',unlock:'üá´üá∑ French Level '+frLv+'!'});S.lastFrenchLevel=frLv;}
  const esLv=getLevel(S.spanishXP,LANG_LEVELS);if(esLv>S.lastSpanishLevel){lvlupQueue.push({lv:esLv,title:'Spanish Lvl '+esLv,burst:'üá™üá∏',unlock:'üá™üá∏ Spanish Level '+esLv+'!'});S.lastSpanishLevel=esLv;}
  saveState();if(!lvlupShowing&&lvlupQueue.length)showNextLevelUp();
}
function showNextLevelUp(){
  if(!lvlupQueue.length)return;const d=lvlupQueue.shift();lvlupShowing=true;
  document.getElementById('lvlupBurst').textContent=d.burst;document.getElementById('lvlupNum').textContent=`Level ${d.lv}`;
  document.getElementById('lvlupTitle').textContent=d.title;document.getElementById('lvlupUnlock').textContent=d.unlock||'üéâ New title unlocked!';
  const c=document.getElementById('lvlupParticles');c.innerHTML='';
  const em=['‚≠ê','üåü','‚ú®','üí´','üéâ','üéä','üèÜ','üíé','üìö','üî¢','üî¨'];
  for(let i=0;i<24;i++){const p=document.createElement('div');p.className='particle';const sx=(Math.random()*80+10)+'%';p.textContent=em[i%em.length];p.style.cssText=`left:${sx};top:60%;--dx:${(Math.random()*300-150)+'px'};--dy:${(Math.random()*-400-100)+'px'};--dur:${1.5+Math.random()*1.5}s;--del:${Math.random()*0.4}s`;c.appendChild(p);}
  document.getElementById('lvlupOverlay').classList.add('show');
}
function closeLevelUp(){document.getElementById('lvlupOverlay').classList.remove('show');lvlupShowing=false;setTimeout(()=>{if(lvlupQueue.length)showNextLevelUp();},400);}

// REALM LOCKS
function applyRealmLocks(){
  const gLv=globalLevel();
  const setup=(nodeId,reqId,badgeId,lvReq,screenId,entries)=>{
    const node=document.getElementById(nodeId),req=document.getElementById(reqId);
    if(!node||!req)return;
    if(gLv>=lvReq){node.classList.remove('locked');node.onclick=()=>openRealm(screenId);req.style.display='none';if(badgeId&&entries===0)document.getElementById(badgeId).style.display='block';}
    else{node.classList.add('locked');node.onclick=null;req.style.display='inline-block';if(badgeId)document.getElementById(badgeId).style.display='none';}
  };
  setup('realmWriting','writingRealmReq','writingNewBadge',5,'writingScreen',S.entries.length);
  setup('realmMath','mathRealmReq',null,10,'mathScreen',0);
  setup('realmScience','scienceRealmReq',null,15,'scienceScreen',0);
  setup('realmFrench','frenchRealmReq',null,6,'frenchScreen',0);
  setup('realmSpanish','spanishRealmReq',null,8,'spanishScreen',0);
}

// RENDER MAP
function renderMap(){
  const rProg=getLevelProgress(S.readingXP,READ_LEVELS),wProg=getLevelProgress(S.writingXP,WRITE_LEVELS);
  const mProg=getLevelProgress(S.mathXP,MATH_LEVELS),sProg=getLevelProgress(S.scienceXP,SCI_LEVELS);
  const gProg=globalProg(),gLv=globalLevel();
  const totalXP=S.readingXP+S.writingXP+S.mathXP+S.scienceXP;
  document.getElementById('mapPlayerName').textContent=S.playerName;
  document.getElementById('mapPlayerLevel').textContent=`Level ${gLv} ¬∑ ${GLOBAL_TITLES[gLv-1]||'Grand Scholar'}`;
  document.getElementById('mapAvatar').textContent=getAvatarEmoji();
  document.getElementById('mapXpVal').textContent=totalXP.toLocaleString();
  document.getElementById('mapXpBar').style.width=gProg.pct+'%';
  document.getElementById('mapStreakNum').textContent=S.streak;
  document.getElementById('mapGemNum').textContent=S.gems;
  const rBooks=S.books.filter(b=>b.status==='completed').length;
  document.getElementById('readingRealmSub').textContent=`Lv ${rProg.lv}‚Äì5 ¬∑ ${rBooks} book${rBooks!==1?'s':''}`;
  document.getElementById('readingRingOffset').setAttribute('stroke-dashoffset',276-(276*rProg.pct/100));
  const wE=S.entries.length;
  document.getElementById('writingRealmSub').textContent=`Lv ${wProg.lv} ¬∑ ${wE} entr${wE!==1?'ies':'y'}`;
  document.getElementById('writingRingOffset').setAttribute('stroke-dashoffset',276-(276*wProg.pct/100));
  document.getElementById('mathRealmSub').textContent=`Lv ${mProg.lv} ¬∑ Math`;
  document.getElementById('mathRingOffset').setAttribute('stroke-dashoffset',276-(276*mProg.pct/100));
  document.getElementById('scienceRealmSub').textContent=`Lv ${sProg.lv} ¬∑ Science`;
  document.getElementById('scienceRingOffset').setAttribute('stroke-dashoffset',276-(276*sProg.pct/100));
  applyRealmLocks();
  renderProgressPanel(rProg,wProg,mProg,sProg,totalXP,gLv,gProg);
  renderBadgesPanel();renderProfilePanel(gProg,gLv,totalXP);renderPetPanel();
}

function renderProgressPanel(rProg,wProg,mProg,sProg,totalXP,gLv,gProg){
  const rBooks=S.books.filter(b=>b.status==='completed').length;
  const pRow=(ico,lbl,prog,bar)=>`<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><span style="font-size:24px">${ico}</span><div style="flex:1"><div style="font-size:13px;font-weight:800;color:#2d2d2d;margin-bottom:4px">${lbl} ¬∑ Lv ${prog.lv}</div><div style="height:9px;background:rgba(0,0,0,.07);border-radius:10px;overflow:hidden"><div style="height:100%;width:${prog.pct}%;${bar};border-radius:10px"></div></div></div><div style="font-size:12px;font-weight:800;white-space:nowrap">${Math.round(prog.pct)}%</div></div>`;
  document.getElementById('progressPanelContent').innerHTML=`
    <div style="background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);border-radius:16px;padding:14px;margin-bottom:12px">
      <div style="font-size:11px;color:rgba(255,255,255,.6);font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Global Level ${gLv} ‚Äî ${GLOBAL_TITLES[gLv-1]||'Grand Scholar'}</div>
      <div style="height:10px;background:rgba(255,255,255,.2);border-radius:10px;overflow:hidden;margin-bottom:6px"><div style="height:100%;width:${gProg.pct}%;background:linear-gradient(90deg,#fde68a,#f59e0b);border-radius:10px"></div></div>
      <div style="font-size:11px;color:rgba(255,255,255,.55);font-weight:700">‚ö° ${totalXP.toLocaleString()} total XP</div>
    </div>
    <div style="background:#fff;border:2px solid rgba(0,0,0,.06);border-radius:18px;padding:16px;margin-bottom:12px">
      <div style="font-size:11px;color:#9e9e9e;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Realm Progress</div>
      ${pRow('üìñ','Reading',rProg,'background:linear-gradient(90deg,#f59e0b,#fbbf24)')}
      ${pRow('‚úçÔ∏è','Writing',wProg,'background:linear-gradient(90deg,#7c9ef5,#a5b8ff)')}
      ${pRow('üî¢','Math',mProg,'background:linear-gradient(90deg,#059669,#34d399)')}
      ${pRow('üî¨','Science',sProg,'background:linear-gradient(90deg,#7c3aed,#a78bfa)')}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">${sb('üìö',rBooks,'Books','#d97706')}${sb('üìù',S.entries.length,'Entries','#4f6ee8')}${sb('‚ö°',totalXP>999?(totalXP/1000).toFixed(1)+'k':totalXP,'Total XP','#e8913a')}${sb('üíé',S.gems,'Gems','#7c3aed')}</div>`;
}
function sb(ico,val,lbl,color){return`<div style="background:#fff;border:2px solid rgba(0,0,0,.06);border-radius:16px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.05)"><div style="font-size:28px;margin-bottom:4px">${ico}</div><div style="font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;color:${color}">${val}</div><div style="font-size:11px;color:#9e9e9e;font-weight:700">${lbl}</div></div>`;}

function renderBadgesPanel(){
  const rBooks=S.books.filter(b=>b.status==='completed').length,gLv=globalLevel();
  const BADGES=[{ico:'üìö',name:'Bookworm',req:'Read 10 books',earned:rBooks>=10},{ico:'üî•',name:'Flame Keeper',req:'7-day streak',earned:S.streak>=7},{ico:'‚úçÔ∏è',name:'Storyteller',req:'Write 5 entries',earned:S.entries.length>=5},{ico:'üîì',name:'Realm Opener',req:'Reach Level 5',earned:gLv>=5},{ico:'üî¢',name:'Math Initiate',req:'Reach Level 10',earned:gLv>=10},{ico:'üî¨',name:'Science Initiate',req:'Reach Level 15',earned:gLv>=15},{ico:'üêâ',name:'Dragon Tamer',req:'Read 50 books',earned:rBooks>=50},{ico:'üíØ',name:'Century Writer',req:'Write 1,000 words',earned:S.entries.reduce((a,e)=>a+e.words,0)>=1000},{ico:'üåü',name:'Omni Scholar',req:'Read 5 genres',earned:new Set(S.books.filter(b=>b.status==='completed').map(b=>b.genre)).size>=5},{ico:'üíé',name:'Gem Collector',req:'Earn 100 Gems',earned:S.gems>=100}];
  const earned=BADGES.filter(b=>b.earned),locked=BADGES.filter(b=>!b.earned);
  const bc=b=>`<div style="background:${b.earned?'linear-gradient(135deg,#fffbf0,#fef9e7)':'#fff'};border:2.5px solid ${b.earned?'#f59e0b':'rgba(0,0,0,.08)'};border-radius:16px;padding:14px;text-align:center;${b.earned?'':'opacity:.4'}"><div style="font-size:30px;margin-bottom:6px">${b.ico}</div><div style="font-size:12px;font-weight:800;color:#1a0f00;margin-bottom:2px">${b.name}</div><div style="font-size:10px;color:#78716c;font-weight:600">${b.req}</div>${b.earned?'<div style="font-size:11px;color:#d97706;font-weight:800;margin-top:4px">‚≠ê Earned!</div>':''}</div>`;
  document.getElementById('badgesPanelContent').innerHTML=`<div style="font-size:12px;color:var(--dim);font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Earned (${earned.length}/${BADGES.length})</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px">${earned.map(bc).join('')||'<div style="color:var(--muted);font-size:13px;grid-column:1/-1;padding:10px 0">No badges yet ‚Äî keep going! üöÄ</div>'}</div><div style="font-size:12px;color:var(--dim);font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Locked üîí</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">${locked.map(bc).join('')}</div>`;
}

function renderProfilePanel(gProg,gLv,totalXP){
  document.getElementById('profilePanelContent').innerHTML=`
    <div style="text-align:center;padding:20px 0 18px">
      <div style="font-size:72px;animation:petBob 2s ease-in-out infinite;margin-bottom:8px">${getAvatarEmoji()}</div>
      <div style="font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;color:#fff;margin-bottom:4px">${S.playerName}</div>
      <div style="font-size:13px;color:rgba(255,255,255,.65);font-weight:700;margin-bottom:10px">Level ${gLv} ¬∑ ${GLOBAL_TITLES[gLv-1]||'Grand Scholar'}</div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap"><div style="background:rgba(168,85,247,.3);border:2px solid rgba(168,85,247,.5);border-radius:20px;padding:5px 16px;font-size:13px;font-weight:800;color:#e9d5ff">üíé ${S.gems} Gems</div><div style="background:rgba(255,100,80,.3);border:2px solid rgba(255,120,80,.5);border-radius:20px;padding:5px 14px;font-size:12px;font-weight:800;color:#ffd0c0;cursor:pointer" onclick="openStreakSheet()">üî• ${S.streak}-day streak</div></div>
    </div>
    <div style="background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);border-radius:16px;padding:14px;margin-bottom:10px">
      <div style="font-size:11px;color:rgba(255,255,255,.6);font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Edit Name</div>
      <input style="width:100%;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.25);border-radius:12px;padding:9px 12px;font-family:'Nunito',sans-serif;font-size:13px;color:#fff;outline:none" id="profileNameInput" value="${S.playerName}" placeholder="Your name"/>
      <button onclick="saveName()" style="margin-top:10px;width:100%;padding:11px;background:linear-gradient(135deg,#fde68a,#f59e0b);color:#92400e;border:none;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;box-shadow:0 3px 0 #b45309">Save Name ‚ú®</button>
    </div>
    <div style="background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);border-radius:16px;padding:14px;margin-bottom:10px;">
      <div style="font-size:11px;color:rgba(255,255,255,.6);font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">üéì Grade Level</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div id="profileGradeLabel" style="font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:#fde68a;">6th Grade</div>
        <button onclick="openGradeSheet()" style="padding:8px 16px;background:linear-gradient(135deg,#fde68a,#f59e0b);color:#92400e;border:none;border-radius:12px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Fredoka',sans-serif;">Change Grade</button>
      </div>
    </div>
    <div style="display:flex;justify-content:space-around;text-align:center;background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);border-radius:16px;padding:14px">
      <div><div style="font-size:24px">üìö</div><div style="font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:#fde68a">${S.books.filter(b=>b.status==='completed').length}</div><div style="font-size:10px;color:rgba(255,255,255,.6);font-weight:700">Books</div></div>
      <div><div style="font-size:24px">üìù</div><div style="font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:#a5f3fc">${S.entries.length}</div><div style="font-size:10px;color:rgba(255,255,255,.6);font-weight:700">Entries</div></div>
      <div><div style="font-size:24px">‚ö°</div><div style="font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:#fde68a">${totalXP>999?(totalXP/1000).toFixed(1)+'k':totalXP}</div><div style="font-size:10px;color:rgba(255,255,255,.6);font-weight:700">XP</div></div>
      <div><div style="font-size:24px">üî•</div><div style="font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:#fdd0c8">${S.streak}</div><div style="font-size:10px;color:rgba(255,255,255,.6);font-weight:700">Streak</div></div>
    </div>`;
}
function saveName(){const v=document.getElementById('profileNameInput')?.value?.trim();if(v){S.playerName=v;saveState();renderMap();spawnXP('‚ú® Name saved!','#a855f7');}}

// REALM SCREENS
function renderReadingScreen(){
  const prog=getLevelProgress(S.readingXP,READ_LEVELS);
  document.getElementById('rXpBannerLbl').textContent=`READING LEVEL ${prog.lv}`;
  document.getElementById('rXpBannerNum').innerHTML=`${S.readingXP.toLocaleString()} <span>/ ${READ_LEVELS[prog.lv]?READ_LEVELS[prog.lv].toLocaleString():'‚àû'} XP</span>`;
  document.getElementById('rXpFill').style.width=prog.pct+'%';
  document.getElementById('rXpBannerSub').textContent=prog.lv>=5?'Max Reading level! üéâ':`${(READ_LEVELS[prog.lv]-S.readingXP).toLocaleString()} XP to Lv ${prog.lv+1} ¬∑ ${R_TITLES[prog.lv]||''}`;
  document.getElementById('rGemCount').textContent=S.gems;
  const active=S.books.find(b=>b.status==='reading'),area=document.getElementById('activeBookArea');
  if(active){const pct=active.pagesTotal>0?Math.round((active.pagesRead/active.pagesTotal)*100):0;area.innerHTML=`<div class="book-card fade-in" onclick="openLogSheet('${active.id}')"><button class="bc-del" onclick="event.stopPropagation();askDeleteBook('${active.id}')">üóë</button><div class="bc-top"><div class="bc-cover" style="background:${coverGradient(active.genre)}">${bookEmoji(active.genre)}</div><div class="bc-meta"><div class="bc-genre">${active.genre}</div><div class="bc-title">${active.title}</div><div class="bc-author">${active.author||'Unknown author'}</div></div></div><div class="prog-row"><span class="prog-txt">${active.pagesRead} of ${active.pagesTotal||'?'} pages</span><span class="prog-pct">${pct}%</span></div><div class="prog-track"><div class="prog-fill" style="width:${pct}%"></div></div><div class="bc-chips"><div class="bc-chip">‚ö° +${XP_PER_PAGE} XP/page</div><div class="bc-chip gem">üíé +1 Gem/page</div></div></div>`;}
  else{area.innerHTML=`<div class="empty-state"><span class="empty-ico">üìñ</span><div class="empty-title">No active quest!</div><div class="empty-sub">Add a book in the Library tab<br>to start your adventure üó∫Ô∏è</div></div>`;}
  renderLibrary();renderReadingBadges();
  applyMQDoneState(document.getElementById('r-quests'));
}
function renderLibrary(){
  const by={reading:[],completed:[],want:[]};S.books.forEach(b=>(by[b.status]||[]).push(b));
  function row(b){const pct=b.pagesTotal>0?Math.round((b.pagesRead/b.pagesTotal)*100):0,done=b.status==='completed';return`<div class="book-card fade-in"><button class="bc-del" onclick="askDeleteBook('${b.id}')">üóë</button>${done?'<div class="bc-badge">‚úì Done</div>':''}<div class="bc-top"><div class="bc-cover" style="background:${coverGradient(b.genre)}">${bookEmoji(b.genre)}</div><div class="bc-meta"><div class="bc-genre">${b.genre}</div><div class="bc-title">${b.title}</div><div class="bc-author">${b.author||'Unknown author'}</div></div></div>${b.status!=='want'?`<div class="prog-row"><span class="prog-txt">${b.pagesRead}/${b.pagesTotal||'?'} pages</span><span class="prog-pct">${done?100:pct}%</span></div><div class="prog-track"><div class="prog-fill" style="width:${done?100:pct}%;background:${done?'linear-gradient(90deg,#22c55e,#4ade80)':'linear-gradient(90deg,var(--r-dark),#fbbf24)'}"></div></div>`:''}</div>`;}
  document.getElementById('libraryReadingNow').innerHTML=by.reading.length?by.reading.map(row).join(''):`<div style="font-size:13px;color:#a8a29e;font-weight:600;padding:8px 0">No books currently reading</div>`;
  document.getElementById('libraryCompleted').innerHTML=by.completed.length?by.completed.map(row).join(''):`<div style="font-size:13px;color:#a8a29e;font-weight:600;padding:8px 0">No completed books yet</div>`;
  document.getElementById('libraryWantToRead').innerHTML=by.want.length?by.want.map(row).join(''):`<div style="font-size:13px;color:#a8a29e;font-weight:600;padding:8px 0">Nothing in your wishlist yet</div>`;
}
function renderReadingBadges(){
  const rBooks=S.books.filter(b=>b.status==='completed').length;
  const BADGES=[{ico:'üìö',name:'Bookworm',req:'Read 10 books',earned:rBooks>=10},{ico:'üî•',name:'Flame Keeper',req:'7-day streak',earned:S.streak>=7},{ico:'‚ö°',name:'Genre Explorer',req:'5 Fantasy books',earned:S.books.filter(b=>b.genre==='Fantasy'&&b.status==='completed').length>=5},{ico:'üêâ',name:'Dragon Tamer',req:'Read 50 books',earned:rBooks>=50},{ico:'üåü',name:'Omni Scholar',req:'Read 5 genres',earned:new Set(S.books.filter(b=>b.status==='completed').map(b=>b.genre)).size>=5},{ico:'ü¶â',name:'Wise One',req:'Read 7 books',earned:rBooks>=7}];
  const earned=BADGES.filter(b=>b.earned),locked=BADGES.filter(b=>!b.earned);
  const bc=b=>`<div class="badge-card ${b.earned?'earned':'locked'}">${b.earned?'<span class="badge-star">‚≠ê</span>':''}<span class="badge-ico">${b.ico}</span><div class="badge-nm">${b.name}</div><div class="badge-req">${b.req}</div></div>`;
  document.getElementById('readingBadgesContent').innerHTML=`<div class="sec-lbl">Earned (${earned.length})</div><div class="badges-grid">${earned.map(bc).join('')||'<div style="color:#a8a29e;font-size:13px;grid-column:1/-1;padding:6px 0">No badges yet!</div>'}</div><div class="sec-lbl" style="margin-top:8px">Locked üîí</div><div class="badges-grid">${locked.map(bc).join('')}</div>`;
}
function renderWritingScreen(){
  const prog=getLevelProgress(S.writingXP,WRITE_LEVELS),nextXP=WRITE_LEVELS[prog.lv]||WRITE_LEVELS[WRITE_LEVELS.length-1]+5000;
  document.getElementById('wXpBannerLbl').textContent=`WRITING LEVEL ${prog.lv}`;
  document.getElementById('wXpBannerNum').innerHTML=`${S.writingXP.toLocaleString()} <span>/ ${nextXP.toLocaleString()} XP</span>`;
  document.getElementById('wXpFill').style.width=prog.pct+'%';
  document.getElementById('wXpBannerSub').textContent=prog.lv>=5?'Max Writing level! üéâ':`${(nextXP-S.writingXP).toLocaleString()} XP to Lv ${prog.lv+1} ¬∑ ${W_TITLES[prog.lv]||''}`;
  const list=document.getElementById('journalList');
  if(!S.entries.length){list.innerHTML=`<div class="empty-state"><span class="empty-ico">‚úçÔ∏è</span><div class="empty-title">No entries yet!</div><div class="empty-sub">Tap "New Entry Today"<br>to start writing! üöÄ</div></div>`;}else{
  list.innerHTML=[...S.entries].reverse().map(e=>`<div class="je fade-in"><button class="je-del" onclick="askDeleteEntry('${e.id}')">üóë</button><div class="je-top"><div class="je-ico">üìù</div><div class="je-info"><div class="je-title">${e.title||'Untitled Entry'}</div><div class="je-meta">${timeAgo(e.addedAt)} ¬∑ ${fmtDate(e.addedAt)}</div></div><div class="je-words">${e.words} words</div></div>${e.body?`<div class="je-preview">"${e.body.slice(0,80)}${e.body.length>80?'‚Ä¶':''}"</div>`:''}</div>`).join('');
  }
  applyMQDoneState(document.getElementById('w-quests'));
  renderWritingPrompts();
}
function renderMathScreen(){
  const prog=getLevelProgress(S.mathXP,MATH_LEVELS),nextXP=MATH_LEVELS[prog.lv]||MATH_LEVELS[MATH_LEVELS.length-1]+5000;
  document.getElementById('mXpBannerLbl').textContent=`MATH LEVEL ${prog.lv}`;
  document.getElementById('mXpBannerNum').innerHTML=`${S.mathXP.toLocaleString()} <span>/ ${nextXP.toLocaleString()} XP</span>`;
  document.getElementById('mXpFill').style.width=prog.pct+'%';
  document.getElementById('mXpBannerSub').textContent=prog.lv>=5?'Max Math level! üéâ':`${(nextXP-S.mathXP).toLocaleString()} XP to Lv ${prog.lv+1} ¬∑ ${M_TITLES[prog.lv]||''}`;
  document.getElementById('mGemCount').textContent=S.gems;
  const rBooks=S.books.filter(b=>b.status==='completed').length,gLv=globalLevel();
  const BADGES=[{ico:'üî¢',name:'First Equation',req:'Any math quest',earned:S.mathXP>0},{ico:'üßÆ',name:'Calculator',req:'500 Math XP',earned:S.mathXP>=500},{ico:'üìê',name:'Shape Wizard',req:'2,000 Math XP',earned:S.mathXP>=2000},{ico:'üß©',name:'Fraction Fighter',req:'4,000 Math XP',earned:S.mathXP>=4000},{ico:'üèÜ',name:'Math Master',req:'Math Lv 5',earned:getLevel(S.mathXP,MATH_LEVELS)>=5},{ico:'üîì',name:'Realm Opener',req:'Global Lv 10',earned:gLv>=10}];
  const earned=BADGES.filter(b=>b.earned),locked=BADGES.filter(b=>!b.earned);
  const bc=b=>`<div class="badge-card ${b.earned?'earned':'locked'}" style="${b.earned?'border-color:#10b981;background:linear-gradient(135deg,#f0fdf4,#d1fae5)':''}"><span class="badge-ico">${b.ico}</span><div class="badge-nm">${b.name}</div><div class="badge-req">${b.req}</div>${b.earned?'<div style="font-size:11px;color:#059669;font-weight:800;margin-top:4px">‚úÖ Earned!</div>':''}</div>`;
  document.getElementById('mathBadgesContent').innerHTML=`<div class="sec-lbl">Earned (${earned.length})</div><div class="badges-grid">${earned.map(bc).join('')||'<div style="color:#a8a29e;font-size:13px;grid-column:1/-1;padding:6px 0">No badges yet!</div>'}</div><div class="sec-lbl" style="margin-top:8px">Locked üîí</div><div class="badges-grid">${locked.map(bc).join('')}</div>`;
  applyMQDoneState(document.getElementById('m-quests'));
}
function renderScienceScreen(){
  const prog=getLevelProgress(S.scienceXP,SCI_LEVELS),nextXP=SCI_LEVELS[prog.lv]||SCI_LEVELS[SCI_LEVELS.length-1]+5000;
  document.getElementById('sXpBannerLbl').textContent=`SCIENCE LEVEL ${prog.lv}`;
  document.getElementById('sXpBannerNum').innerHTML=`${S.scienceXP.toLocaleString()} <span>/ ${nextXP.toLocaleString()} XP</span>`;
  document.getElementById('sXpFill').style.width=prog.pct+'%';
  document.getElementById('sXpBannerSub').textContent=prog.lv>=5?'Max Science level! üéâ':`${(nextXP-S.scienceXP).toLocaleString()} XP to Lv ${prog.lv+1} ¬∑ ${SC_TITLES[prog.lv]||''}`;
  document.getElementById('sGemCount').textContent=S.gems;
  const gLv=globalLevel();
  const BADGES=[{ico:'üî¨',name:'First Discovery',req:'Any science quest',earned:S.scienceXP>0},{ico:'üå±',name:'Plant Observer',req:'500 Science XP',earned:S.scienceXP>=500},{ico:'üß¨',name:'Cell Scientist',req:'2,000 Science XP',earned:S.scienceXP>=2000},{ico:'üî≠',name:'Star Gazer',req:'4,000 Science XP',earned:S.scienceXP>=4000},{ico:'‚öóÔ∏è',name:'Science Sage',req:'Science Lv 5',earned:getLevel(S.scienceXP,SCI_LEVELS)>=5},{ico:'üîì',name:'Realm Opener',req:'Global Lv 15',earned:gLv>=15}];
  const earned=BADGES.filter(b=>b.earned),locked=BADGES.filter(b=>!b.earned);
  const bc=b=>`<div class="badge-card ${b.earned?'earned':'locked'}" style="${b.earned?'border-color:#8b5cf6;background:linear-gradient(135deg,#f5f3ff,#ede9fe)':''}"><span class="badge-ico">${b.ico}</span><div class="badge-nm">${b.name}</div><div class="badge-req">${b.req}</div>${b.earned?'<div style="font-size:11px;color:#7c3aed;font-weight:800;margin-top:4px">‚úÖ Earned!</div>':''}</div>`;
  document.getElementById('scienceBadgesContent').innerHTML=`<div class="sec-lbl">Earned (${earned.length})</div><div class="badges-grid">${earned.map(bc).join('')||'<div style="color:#a8a29e;font-size:13px;grid-column:1/-1;padding:6px 0">No badges yet!</div>'}</div><div class="sec-lbl" style="margin-top:8px">Locked üîí</div><div class="badges-grid">${locked.map(bc).join('')}</div>`;
}

// NAV
let currentScreen='worldMap';
function openRealm(screenId){if(!isRealmUnlocked(screenId)){const req=REALM_UNLOCK[screenId];spawnXP(`üîí Reach Level ${req} first!`,'#ef4444');return;}openScreen(screenId);}
function openScreen(id){const prev=currentScreen,pe=document.getElementById(prev);if(pe){pe.classList.add('exit');setTimeout(()=>pe.classList.remove('exit'),350);pe.classList.remove('active');}const ne=document.getElementById(id);if(ne)ne.classList.add('active');currentScreen=id;if(id==='readingScreen')renderReadingScreen();if(id==='writingScreen')renderWritingScreen();if(id==='mathScreen')renderMathScreen();if(id==='scienceScreen')renderScienceScreen();if(id==='frenchScreen')renderLangScreen('fr');if(id==='spanishScreen')renderLangScreen('es');}
function goBack(){closeSheets();document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active','exit'));const wm=document.getElementById('worldMap');if(wm)wm.classList.add('active');currentScreen='worldMap';renderMap();}
function showMapPanel(id,btn){document.querySelectorAll('.map-panel').forEach(p=>p.classList.remove('show'));document.querySelectorAll('.map-nav-btn').forEach(b=>b.classList.remove('active'));if(id==='map-world'){const f=document.querySelectorAll('.map-nav-btn')[0];if(f)f.classList.add('active');}else{renderMap();const p=document.getElementById(id);if(p)p.classList.add('show');if(btn)btn.classList.add('active');}}
function switchModTab(prefix,id,btn){
  const screenMap={r:'readingScreen',w:'writingScreen',m:'mathScreen',s:'scienceScreen'};
  const screen=document.getElementById(screenMap[prefix]);
  if(!screen)return;
  screen.querySelectorAll('.mod-sub').forEach(s=>s.classList.remove('active'));
  const tabEl=document.getElementById(prefix+'-'+id);if(tabEl)tabEl.classList.add('active');
  const cm={r:{a:['var(--r-light)','var(--r-dark)','var(--r-border)'],i:['#f5f5f4','#78716c','#e7e5e4']},w:{a:['var(--w-light)','var(--w-dark)','var(--w-border)'],i:['#f0f9ff','#6fa8b8','#bae6f7']},m:{a:['var(--m-light)','var(--m-dark)','var(--m-border)'],i:['#f0fdf4','#6b9e8a','#6ee7b7']},s:{a:['var(--sc-light)','var(--sc-dark)','var(--sc-border)'],i:['#f5f3ff','#8b6fb8','#c4b5fd']}}[prefix];
  if(!cm||!btn)return;
  screen.querySelectorAll('.pill').forEach(p=>{if(p.id?.startsWith(prefix)){[p.style.background,p.style.color,p.style.borderColor]=cm.i;}});
  [btn.style.background,btn.style.color,btn.style.borderColor]=cm.a;
}

// BOOKS
function openAddBookSheet(){['bookTitle','bookAuthor','bookPagesRead','bookPagesTotal'].forEach(id=>{document.getElementById(id).value='';});document.getElementById('bookGenre').value='Fantasy';document.getElementById('bookStatus').value='reading';showSheet('addBookSheet');}
function saveBook(){const title=document.getElementById('bookTitle').value.trim();if(!title){document.getElementById('bookTitle').focus();return;}const status=document.getElementById('bookStatus').value,pagesRead=parseInt(document.getElementById('bookPagesRead').value)||0,pagesTotal=parseInt(document.getElementById('bookPagesTotal').value)||0;let xpGain=0,gemGain=0;if(status==='completed'){xpGain=500+(pagesTotal*XP_PER_PAGE);gemGain=pagesTotal+50;}S.books.push({id:Date.now().toString(),title,author:document.getElementById('bookAuthor').value.trim(),genre:document.getElementById('bookGenre').value,status,pagesRead:status==='completed'?(pagesTotal||pagesRead):pagesRead,pagesTotal,addedAt:Date.now()});if(xpGain)S.readingXP+=xpGain;if(gemGain)S.gems+=gemGain;saveState();closeSheets();renderReadingScreen();renderMap();checkLevelUp();if(xpGain)spawnXP(`+${xpGain} XP`,'#d97706');if(gemGain)setTimeout(()=>spawnXP(`+${gemGain} üíé`,'#a855f7'),600);}

// CONFIRM DELETE
let _pendingDeleteFn=null;
function showConfirm(icon,title,msg,onOk){document.getElementById('confirmIcon').textContent=icon;document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').textContent=msg;_pendingDeleteFn=onOk;document.getElementById('confirmDialog').classList.add('show');}
function closeConfirm(){document.getElementById('confirmDialog').classList.remove('show');_pendingDeleteFn=null;}
function confirmOkAction(){if(_pendingDeleteFn)_pendingDeleteFn();closeConfirm();}
function askDeleteBook(id){const b=S.books.find(x=>x.id===id);if(!b)return;showConfirm('üóëÔ∏è',`Delete "${b.title}"?`,'This book and its progress will be permanently removed.',()=>{S.books=S.books.filter(x=>x.id!==id);saveState();renderReadingScreen();renderMap();spawnXP('üóë Removed','#9e9e9e');});}
function askDeleteEntry(id){const e=S.entries.find(x=>x.id===id);if(!e)return;showConfirm('üóëÔ∏è',`Delete "${e.title||'this entry'}"?`,'This journal entry will be permanently removed.',()=>{S.entries=S.entries.filter(x=>x.id!==id);saveState();renderWritingScreen();renderMap();spawnXP('üóë Removed','#9e9e9e');});}

// LOG PAGES
let logPages=10,logBookId=null;
function openLogSheet(bookId){const active=bookId?S.books.find(b=>b.id===bookId):S.books.find(b=>b.status==='reading');logBookId=active?.id||null;logPages=10;document.getElementById('pageNum').textContent=logPages;document.getElementById('logSheetSub').textContent=active?`Logging for: ${active.title}`:'No active book';document.getElementById('noBookWarning').style.display=logBookId?'none':'block';updateEarnPrev();showSheet('logSheet');}
function updateEarnPrev(){document.getElementById('earnPrev').textContent=`You'll earn +${logPages*XP_PER_PAGE} XP and +${logPages} üíé Gems!`;}
function changePages(d){logPages=Math.max(1,Math.min(9999,logPages+d));document.getElementById('pageNum').textContent=logPages;updateEarnPrev();}
function confirmLog(){const xp=logPages*XP_PER_PAGE,gems=logPages;S.readingXP+=xp;S.gems+=gems;if(logBookId){const book=S.books.find(b=>b.id===logBookId);if(book){book.pagesRead=Math.min((book.pagesRead||0)+logPages,book.pagesTotal||999999);if(book.pagesTotal&&book.pagesRead>=book.pagesTotal){book.status='completed';S.readingXP+=500;S.gems+=50;spawnXP('üìó Book Done! +500 XP','#16a34a');setTimeout(()=>spawnXP('+50 üíé Bonus!','#a855f7'),700);}}}saveState();closeSheets();renderReadingScreen();renderMap();checkLevelUp();spawnXP(`+${xp} XP`,'#d97706');setTimeout(()=>spawnXP(`+${gems} üíé`,'#a855f7'),500);}

// JOURNAL
let currentPrompt='';
function openWriteSheet(){currentPrompt='';_openWriteSheet();}
function openWriteSheetWithPrompt(p){currentPrompt=p;_openWriteSheet();}
function _openWriteSheet(){document.getElementById('entryTitle').value='';document.getElementById('entryBody').value='';document.getElementById('wcDisplay').textContent='0 words ¬∑ write 50+ for full XP';const pb=document.getElementById('promptBubble');if(currentPrompt){pb.style.display='block';pb.textContent='üí° '+currentPrompt;}else{pb.style.display='none';}showSheet('writeSheet');}
function updateWordCount(){const words=countWords(document.getElementById('entryBody').value);const xp=calcWriteXP(words);document.getElementById('wcDisplay').textContent=`${words} words ¬∑ ${xp>0?'+'+xp+' XP':'write 50+ for full XP'}`;}
function countWords(t){return t.replace(/[\u00a0\u1680\u2000-\u200a\u202f\u205f\u3000]/g,' ').trim().split(/\s+/).filter(w=>/\p{L}/u.test(w)).length;}
function calcWriteXP(w){if(w<10)return 0;if(w<50)return 50;return Math.min(500,w*2);}
function saveEntry(){const title=document.getElementById('entryTitle').value.trim()||'Untitled Entry',body=document.getElementById('entryBody').value.trim(),words=countWords(body);if(words<1){document.getElementById('entryBody').focus();return;}const xp=calcWriteXP(words),gems=Math.floor(words/10);S.entries.push({id:Date.now().toString(),title,body,prompt:currentPrompt,words,xp,addedAt:Date.now()});S.writingXP+=xp;S.gems+=gems;saveState();closeSheets();renderWritingScreen();renderMap();checkLevelUp();if(xp>0)spawnXP(`+${xp} XP`,'#0891b2');if(gems>0)setTimeout(()=>spawnXP(`+${gems} üíé`,'#a855f7'),500);}

// MINI QUESTS
function completeMQ(el,color,xpAmt,gemAmt){
  if(el.classList.contains('done'))return;
  const mqId=el.dataset.mqid;
  if(mqId&&S.completedMQs.includes(mqId))return;
  el.classList.add('done');
  if(mqId)S.completedMQs.push(mqId);
  const isW=el.classList.contains('wmq'),isM=el.classList.contains('mmq'),isSc=el.classList.contains('smq');
  if(isW)S.writingXP+=xpAmt;else if(isM)S.mathXP+=xpAmt;else if(isSc)S.scienceXP+=xpAmt;else S.readingXP+=xpAmt;
  S.gems+=(gemAmt||0);saveState();checkLevelUp();
  spawnXP(`+${xpAmt} XP`,color);if(gemAmt)setTimeout(()=>spawnXP(`+${gemAmt} üíé`,'#a855f7'),500);
  renderMap();
  if(isW)renderWritingScreen();else if(isM)renderMathScreen();else if(isSc)renderScienceScreen();else renderReadingScreen();
}
function applyMQDoneState(container){
  if(!container)return;
  container.querySelectorAll('.mq[data-mqid]').forEach(el=>{
    if(S.completedMQs.includes(el.dataset.mqid))el.classList.add('done');
  });
}

// STREAK
let tempStreak=0;
function openStreakSheet(){tempStreak=S.streak;document.getElementById('streakNum').textContent=tempStreak;showSheet('streakSheet');}
function changeStreak(d){tempStreak=Math.max(0,tempStreak+d);document.getElementById('streakNum').textContent=tempStreak;}
function saveStreak(){S.streak=tempStreak;saveState();closeSheets();renderMap();spawnXP('üî• Streak saved!','#f97316');}

// SHEETS
function showSheet(id){const ov=document.getElementById('overlay'),sh=document.getElementById(id);if(ov)ov.classList.add('show');if(sh)sh.classList.add('show');}
function closeSheets(){const ov=document.getElementById('overlay');if(ov)ov.classList.remove('show');['addBookSheet','logSheet','writeSheet','streakSheet','scanSheet','gradeSheet'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('show');});if(_scanActive)stopCamera();}

// FX
function spawnXP(text,color){const el=document.createElement('div');el.className='fx';el.textContent=text;el.style.color=color||'#d97706';el.style.left=(15+Math.random()*60)+'%';el.style.top='35%';document.body.appendChild(el);setTimeout(()=>el.remove(),1600);}
function showNetError(msg){const t=document.getElementById('netToast');t.textContent='‚ö†Ô∏è '+(msg||'Network error.');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3500);}

// HELPERS
function bookEmoji(g){return{Fantasy:'‚ö°','Sci-Fi':'ü§ñ',Mystery:'üîç',Adventure:'üó∫Ô∏è',Romance:'üíù',Horror:'üëª','Non-Fiction':'üì∞',Other:'üìó'}[g]||'üìó';}
function coverGradient(g){return{Fantasy:'linear-gradient(135deg,#fde68a,#d97706)','Sci-Fi':'linear-gradient(135deg,#a5f3fc,#0891b2)',Mystery:'linear-gradient(135deg,#d4d4d4,#525252)',Adventure:'linear-gradient(135deg,#86efac,#16a34a)',Romance:'linear-gradient(135deg,#fda4af,#e11d48)',Horror:'linear-gradient(135deg,#6b7280,#111827)','Non-Fiction':'linear-gradient(135deg,#bfdbfe,#1d4ed8)',Other:'linear-gradient(135deg,#e9d5ff,#7e22ce)'}[g]||'linear-gradient(135deg,#e5e7eb,#6b7280)';}
function timeAgo(ts){const d=Math.floor((Date.now()-ts)/86400000);if(d===0)return'Today';if(d===1)return'Yesterday';return`${d} days ago`;}
function fmtDate(ts){return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric'});}

// ISBN SCANNER
let scanStream=null,scanInterval=null,barcodeDetector=null,_scanActive=false;
async function openScanSheet(){showSheet('scanSheet');document.getElementById('scanStatus').textContent='Point your camera at the barcode on the back of the book';document.getElementById('scanTip').style.display='block';document.getElementById('isbnInput').value='';document.getElementById('scanSpinner').style.display='none';document.getElementById('scanViewfinder').style.display='block';document.getElementById('scanResultArea').style.display='none';await startCamera();}
async function startCamera(){try{scanStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});_scanActive=true;const video=document.getElementById('scanVideo');video.srcObject=scanStream;await video.play();if('BarcodeDetector' in window){barcodeDetector=new BarcodeDetector({formats:['ean_13','ean_8']});scanInterval=setInterval(()=>scanFrame(video),600);document.getElementById('scanStatus').textContent='üì∑ Camera ready ‚Äî hold barcode in the box!';}else{document.getElementById('scanStatus').textContent='üì∑ Camera ready ‚Äî enter ISBN manually below if needed';}}catch(e){document.getElementById('scanStatus').textContent='‚ö†Ô∏è Camera blocked ‚Äî enter ISBN manually below';document.getElementById('scanViewfinder').style.background='#1a1040';}}
async function scanFrame(video){if(!barcodeDetector||video.readyState<2)return;try{const codes=await barcodeDetector.detect(video);for(const code of codes){const val=code.rawValue.replace(/[^0-9X]/gi,'');if(val.length===13||val.length===10){clearInterval(scanInterval);scanInterval=null;await lookupISBN(val);return;}}}catch(e){}}
async function lookupISBN(isbn){isbn=String(isbn).replace(/[^0-9X]/gi,'').trim();if(!isbn){spawnXP('Enter an ISBN first!','#ef4444');return;}const spinner=document.getElementById('scanSpinner');spinner.style.display='flex';document.getElementById('scanStatus').textContent='üîç Looking up ISBN '+isbn+'‚Ä¶';document.getElementById('scanResultArea').style.display='none';let found=false,networkError=false;try{const ctrl=new AbortController();const timer=setTimeout(()=>ctrl.abort(),6000);const res=await fetch('https://www.googleapis.com/books/v1/volumes?q=isbn:'+isbn,{signal:ctrl.signal});clearTimeout(timer);if(!res.ok)throw new Error('HTTP '+res.status);const data=await res.json();if(data.items&&data.items.length>0){const info=data.items[0].volumeInfo;showScanResult(info.title||'',(info.authors||[]).join(', '),info.pageCount||'',guessGenre(((info.categories||[]).join(' ')+(info.description||'')).toLowerCase()));found=true;}}catch(e){if(e.name==='AbortError'||e instanceof TypeError)networkError=true;}if(!found&&!networkError){try{const ctrl=new AbortController();const timer=setTimeout(()=>ctrl.abort(),6000);const res=await fetch('https://openlibrary.org/api/books?bibkeys=ISBN:'+isbn+'&format=json&jscmd=data',{signal:ctrl.signal});clearTimeout(timer);if(!res.ok)throw new Error('HTTP '+res.status);const data=await res.json();const key='ISBN:'+isbn;if(data[key]){const book=data[key];showScanResult(book.title||'',(book.authors||[]).map(a=>a.name).join(', '),book.number_of_pages||'',guessGenre((book.subjects||[]).map(s=>typeof s==='string'?s:(s.name||'')).join(' ').toLowerCase()));found=true;}}catch(e){if(e.name==='AbortError'||e instanceof TypeError)networkError=true;}}spinner.style.display='none';if(networkError&&!found){showNetError('Could not reach book database. Check your connection and try again.');document.getElementById('scanStatus').textContent='‚ö†Ô∏è Network error ‚Äî check your connection or enter ISBN manually.';}else if(!found){document.getElementById('scanStatus').textContent="‚ùå Couldn't find ISBN "+isbn+". Check the number or add manually.";}}
function showScanResult(title,author,pages,genre){document.getElementById('scanBookTitle').value=title;document.getElementById('scanBookAuthor').value=author;document.getElementById('scanBookPages').value=pages;document.getElementById('scanBookGenre').value=genre||'Other';document.getElementById('scanResultArea').style.display='block';document.getElementById('scanStatus').textContent='‚úÖ Found! Review details below, then tap Add.';clearInterval(scanInterval);scanInterval=null;}
function confirmScanResult(){const title=document.getElementById('scanBookTitle').value.trim();if(!title){document.getElementById('scanBookTitle').focus();return;}S.books.push({id:Date.now().toString(),title,author:document.getElementById('scanBookAuthor').value.trim(),genre:document.getElementById('scanBookGenre').value,status:'reading',pagesRead:0,pagesTotal:parseInt(document.getElementById('scanBookPages').value)||0,addedAt:Date.now()});saveState();stopCamera();closeSheets();renderReadingScreen();renderMap();spawnXP('üìö '+title+' added!','#7c3aed');}
function guessGenre(text){text=text.toLowerCase();if(text.includes('fantas')||text.includes('magic')||text.includes('wizard'))return'Fantasy';if(text.includes('science fiction')||text.includes('sci-fi')||text.includes('space')||text.includes('dystop'))return'Sci-Fi';if(text.includes('mystery')||text.includes('detective')||text.includes('thriller')||text.includes('crime'))return'Mystery';if(text.includes('adventure')||text.includes('quest')||text.includes('survival'))return'Adventure';if(text.includes('romance')||text.includes('love story'))return'Romance';if(text.includes('horror')||text.includes('scary')||text.includes('ghost'))return'Horror';if(text.includes('nonfiction')||text.includes('non-fiction')||text.includes('biography')||text.includes('history'))return'Non-Fiction';return'Other';}
function stopCamera(){clearInterval(scanInterval);scanInterval=null;if(scanStream){scanStream.getTracks().forEach(t=>t.stop());scanStream=null;}const v=document.getElementById('scanVideo');if(v)v.srcObject=null;_scanActive=false;}
function closeScanSheet(){stopCamera();document.getElementById('scanSheet').classList.remove('show');if(!document.getElementById('addBookSheet').classList.contains('show')){document.getElementById('overlay').classList.remove('show');}}

// BOOT
renderMap();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MATH PROBLEM ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MATH_PROBLEM_POOL = [
  // Arithmetic
  ()=>{ const a=rnd(10,99),b=rnd(10,99); return {tag:'‚ûï Addition',q:`${a} + ${b} = ?`,ans:a+b,xp:80,gems:3}; },
  ()=>{ const a=rnd(50,200),b=rnd(10,80); return {tag:'‚ûñ Subtraction',q:`${a} ‚àí ${b} = ?`,ans:a-b,xp:80,gems:3}; },
  ()=>{ const a=rnd(2,12),b=rnd(2,12); return {tag:'‚úñÔ∏è Multiplication',q:`${a} √ó ${b} = ?`,ans:a*b,xp:100,gems:4}; },
  ()=>{ const b=rnd(2,12),a=b*rnd(2,12); return {tag:'‚ûó Division',q:`${a} √∑ ${b} = ?`,ans:a/b,xp:100,gems:4}; },
  ()=>{ const a=rnd(10,50),b=rnd(2,9); return {tag:'‚úñÔ∏è Multiplication',q:`${a} √ó ${b} = ?`,ans:a*b,xp:110,gems:4}; },
  ()=>{ const a=rnd(100,500),b=rnd(100,400); return {tag:'‚ûï Addition',q:`${a} + ${b} = ?`,ans:a+b,xp:85,gems:3}; },
  ()=>{ const a=rnd(200,999),b=rnd(100,a); return {tag:'‚ûñ Subtraction',q:`${a} ‚àí ${b} = ?`,ans:a-b,xp:90,gems:3}; },
  // Squares & powers
  ()=>{ const a=rnd(2,15); return {tag:'üî¢ Squares',q:`${a}¬≤ = ?`,ans:a*a,xp:130,gems:5}; },
  ()=>{ const a=rnd(2,6); return {tag:'üî¢ Cubes',q:`${a}¬≥ = ?`,ans:a*a*a,xp:150,gems:6}; },
  ()=>{ const sq=[1,4,9,16,25,36,49,64,81,100,121,144]; const a=sq[rnd(0,sq.length-1)]; return {tag:'‚àö Square Root',q:`‚àö${a} = ?`,ans:Math.sqrt(a),xp:140,gems:5}; },
  // Percentages
  ()=>{ const pct=rnd(1,9)*10,total=rnd(2,10)*10; return {tag:'üìä Percentages',q:`${pct}% of ${total} = ?`,ans:(pct/100)*total,xp:160,gems:6}; },
  ()=>{ const pct=[5,10,15,20,25,50][rnd(0,5)],total=rnd(2,20)*pct; return {tag:'üìä Percentages',q:`What is ${pct}% of ${total}?`,ans:(pct/100)*total,xp:150,gems:6}; },
  // Fractions (display as decimal answer)
  ()=>{ const d=[2,4,5,10][rnd(0,3)],n=rnd(1,d-1); return {tag:'üî¢ Fractions',q:`${n}/${d} as a decimal = ?`,ans:parseFloat((n/d).toFixed(2)),xp:160,gems:6}; },
  // Geometry
  ()=>{ const w=rnd(2,20),h=rnd(2,20); return {tag:'üìê Area',q:`Area of rectangle ${w}cm √ó ${h}cm = ?`,ans:w*h,xp:170,gems:7,unit:'cm¬≤'}; },
  ()=>{ const s=rnd(2,15); return {tag:'üìê Area',q:`Area of square with side ${s}cm = ?`,ans:s*s,xp:160,gems:6,unit:'cm¬≤'}; },
  ()=>{ const b=rnd(4,20),h=rnd(2,15); return {tag:'üìê Area',q:`Area of triangle: base ${b}cm, height ${h}cm = ?`,ans:(b*h)/2,xp:190,gems:7,unit:'cm¬≤'}; },
  ()=>{ const w=rnd(2,15),h=rnd(2,15); return {tag:'üìè Perimeter',q:`Perimeter of rectangle ${w}cm √ó ${h}cm = ?`,ans:2*(w+h),xp:150,gems:6,unit:'cm'}; },
  // Word problems
  ()=>{ const s=rnd(20,120),t=rnd(2,5); return {tag:'üöÇ Speed',q:`A train travels ${s*t}km in ${t} hours. Speed = ?`,ans:s,xp:200,gems:8,unit:'km/h'}; },
  ()=>{ const p=rnd(2,8),n=rnd(3,12); return {tag:'üí∞ Money',q:`${n} items cost $${(p*n).toFixed(2)}. Price each = ?`,ans:p,xp:180,gems:7,unit:'$'}; },
  ()=>{ const apples=rnd(12,30),giveAway=rnd(1,Math.floor(apples/3)),eaten=rnd(1,4); return {tag:'üçé Word Problem',q:`You have ${apples} apples, give away ${giveAway} and eat ${eaten}. How many left?`,ans:apples-giveAway-eaten,xp:170,gems:6}; },
  // Algebra (simple)
  ()=>{ const a=rnd(2,9),b=rnd(1,9),c=a*rnd(2,8)+b; return {tag:'üî§ Algebra',q:`If ${a}x + ${b} = ${c}, what is x?`,ans:(c-b)/a,xp:220,gems:9}; },
  ()=>{ const a=rnd(2,6),c=a*rnd(2,10); return {tag:'üî§ Algebra',q:`Solve: ${a}x = ${c}. x = ?`,ans:c/a,xp:190,gems:8}; },
  // Temperature & conversions
  ()=>{ const c=rnd(0,40)*5; return {tag:'üå°Ô∏è Convert',q:`${c}¬∞C to Fahrenheit = ?`,ans:c*9/5+32,xp:180,gems:7}; },
  ()=>{ const km=rnd(1,20); return {tag:'üìè Convert',q:`${km} km = ? metres`,ans:km*1000,xp:140,gems:5,unit:'m'}; },
  ()=>{ const m=rnd(100,5000); return {tag:'üìè Convert',q:`${m} cm = ? metres`,ans:m/100,xp:130,gems:5,unit:'m'}; },
];

function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function generateMathProblems(){
  const pool = shuffle(MATH_PROBLEM_POOL);
  const selected = pool.slice(0,6).map(fn=>fn());
  const container = document.getElementById('mathProblemsList');
  container.innerHTML = '';
  selected.forEach((prob,i)=>{
    const id = 'mp_'+Date.now()+'_'+i;
    const div = document.createElement('div');
    div.className = 'prob-card';
    div.id = id;
    div.innerHTML = `
      <div class="prob-tag">${prob.tag}</div>
      <div class="prob-q" style="font-size:15px;font-weight:800;color:#2a5a3a;margin-bottom:10px;">${prob.q}</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="number" step="any" placeholder="Your answer‚Ä¶" id="ans_${id}"
          style="flex:1;border:2px solid var(--m-border);border-radius:10px;padding:9px 12px;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;color:#2a5a3a;outline:none;background:#fff;"
          onkeydown="if(event.key==='Enter')checkMathAnswer('${id}',${prob.ans},${prob.xp},${prob.gems})"
        />
        <button onclick="checkMathAnswer('${id}',${prob.ans},${prob.xp},${prob.gems})"
          style="padding:9px 16px;background:linear-gradient(135deg,#3aaa80,#5bcca0);color:#fff;border:none;border-radius:10px;font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 3px 0 #2a8a60;">
          Check ‚úì
        </button>
      </div>
      <div id="fb_${id}" style="margin-top:8px;font-size:12px;font-weight:800;display:none;border-radius:8px;padding:7px 12px;"></div>
      <div class="prob-xp" style="margin-top:6px;">+${prob.xp} XP ¬∑ ${prob.gems} üíé</div>
    `;
    container.appendChild(div);
  });
}

function checkMathAnswer(id, correct, xp, gems){
  const input = document.getElementById('ans_'+id);
  const fb = document.getElementById('fb_'+id);
  const card = document.getElementById(id);
  if(!input || card.dataset.solved) return;
  const val = parseFloat(input.value);
  if(isNaN(val)){ fb.style.display='block'; fb.style.background='#fff0f0'; fb.style.color='#c04040'; fb.textContent='‚ö†Ô∏è Please enter a number!'; return; }
  const correctRounded = parseFloat(parseFloat(correct).toFixed(2));
  const isCorrect = Math.abs(val - correctRounded) < 0.01;
  fb.style.display='block';
  if(isCorrect){
    card.dataset.solved='1';
    card.style.borderColor='#7adda8';
    card.style.background='linear-gradient(135deg,#f0fbf6,#e0f8ec)';
    input.disabled=true;
    input.style.background='#e0f8ec';
    card.querySelector('button').disabled=true;
    card.querySelector('button').style.opacity='0.5';
    fb.style.background='#d8f8e8'; fb.style.color='#1a6a3a';
    fb.textContent='‚úÖ Correct! +'+xp+' XP & '+gems+' üíé earned!';
    S.mathXP+=xp; S.gems+=gems; saveState(); renderMap(); checkLevelUp();
    renderMathScreen();
  } else {
    fb.style.background='#fde8f0'; fb.style.color='#c04060';
    fb.textContent='‚ùå Not quite! Try again. Hint: the answer is '+(Math.abs(correctRounded)>1000?'a big number':'close to '+correctRounded);
    input.style.borderColor='#f0a8c8';
    input.value='';
    input.focus();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCIENCE QUESTION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCIENCE_QUESTION_POOL = [
  // Biology
  {tag:'üå± Biology',q:'How many chambers does the human heart have?',opts:['2','3','4','6'],ans:2,xp:90,gems:3},
  {tag:'üå± Biology',q:'Which gas do plants absorb during photosynthesis?',opts:['Oxygen','Carbon Dioxide','Nitrogen','Hydrogen'],ans:1,xp:90,gems:3},
  {tag:'üå± Biology',q:'What is the powerhouse of the cell?',opts:['Nucleus','Cell Wall','Mitochondria','Ribosome'],ans:2,xp:100,gems:4},
  {tag:'üß¨ Biology',q:'How many bones are in the adult human body?',opts:['186','206','226','246'],ans:1,xp:110,gems:4},
  {tag:'üß¨ Biology',q:'What do you call animals that eat only plants?',opts:['Carnivores','Omnivores','Herbivores','Decomposers'],ans:2,xp:90,gems:3},
  {tag:'üß¨ Biology',q:'Which organ filters blood and makes urine?',opts:['Liver','Lungs','Heart','Kidneys'],ans:3,xp:100,gems:4},
  {tag:'üå± Biology',q:'What is the green pigment in plants called?',opts:['Melanin','Chlorophyll','Carotene','Hemoglobin'],ans:1,xp:110,gems:4},
  {tag:'üß¨ Biology',q:'What carries oxygen in red blood cells?',opts:['Plasma','Platelets','Hemoglobin','White cells'],ans:2,xp:120,gems:5},
  // Chemistry
  {tag:'‚öóÔ∏è Chemistry',q:'What is the chemical symbol for water?',opts:['WO','H‚ÇÇO','HO‚ÇÇ','W‚ÇÇO'],ans:1,xp:90,gems:3},
  {tag:'‚öóÔ∏è Chemistry',q:'What is the chemical symbol for gold?',opts:['Go','Gd','Ag','Au'],ans:3,xp:110,gems:4},
  {tag:'‚öóÔ∏è Chemistry',q:'How many elements are in the periodic table (approx)?',opts:['78','98','118','138'],ans:2,xp:120,gems:5},
  {tag:'‚öóÔ∏è Chemistry',q:'What state of matter has no fixed shape or volume?',opts:['Solid','Liquid','Gas','Plasma'],ans:2,xp:100,gems:4},
  {tag:'‚öóÔ∏è Chemistry',q:'What is H‚ÇÇO‚ÇÇ commonly known as?',opts:['Bleach','Hydrogen Peroxide','Vinegar','Saline'],ans:1,xp:130,gems:5},
  {tag:'‚öóÔ∏è Chemistry',q:'Acids have a pH that is‚Ä¶',opts:['Greater than 7','Equal to 7','Less than 7','Equal to 0'],ans:2,xp:110,gems:4},
  // Physics
  {tag:'‚ö° Physics',q:'What is the unit of electrical current?',opts:['Volt','Watt','Ampere','Ohm'],ans:2,xp:110,gems:4},
  {tag:'‚ö° Physics',q:'What is the speed of light (approx) in km/s?',opts:['3,000','30,000','300,000','3,000,000'],ans:2,xp:130,gems:5},
  {tag:'‚ö° Physics',q:'What force pulls objects toward Earth?',opts:['Friction','Magnetism','Gravity','Tension'],ans:2,xp:90,gems:3},
  {tag:'‚ö° Physics',q:'What is the unit of force?',opts:['Joule','Newton','Pascal','Watt'],ans:1,xp:110,gems:4},
  {tag:'‚ö° Physics',q:'Sound travels fastest through which medium?',opts:['Air','Water','Vacuum','Solid Steel'],ans:3,xp:140,gems:5},
  {tag:'‚ö° Physics',q:'What type of energy does a moving object have?',opts:['Potential','Chemical','Kinetic','Thermal'],ans:2,xp:100,gems:4},
  // Earth Science
  {tag:'üåç Earth Science',q:'What is the outermost layer of the Earth?',opts:['Mantle','Core','Crust','Magma'],ans:2,xp:100,gems:4},
  {tag:'üåç Earth Science',q:'What causes earthquakes?',opts:['Volcanoes','Tectonic plate movement','Heavy rain','Tides'],ans:1,xp:110,gems:4},
  {tag:'üåç Earth Science',q:'What is the most abundant gas in Earth\'s atmosphere?',opts:['Oxygen','Carbon Dioxide','Argon','Nitrogen'],ans:3,xp:120,gems:5},
  {tag:'üåç Earth Science',q:'What type of rock is formed from cooled lava?',opts:['Sedimentary','Metamorphic','Igneous','Fossil'],ans:2,xp:110,gems:4},
  // Astronomy
  {tag:'üî≠ Astronomy',q:'How many planets are in our solar system?',opts:['7','8','9','10'],ans:1,xp:90,gems:3},
  {tag:'üî≠ Astronomy',q:'Which is the largest planet in our solar system?',opts:['Saturn','Neptune','Jupiter','Uranus'],ans:2,xp:100,gems:4},
  {tag:'üî≠ Astronomy',q:'How long does light from the Sun take to reach Earth?',opts:['8 seconds','8 minutes','8 hours','8 days'],ans:1,xp:120,gems:5},
  {tag:'üî≠ Astronomy',q:'What is a light-year?',opts:['A year with more daylight','Distance light travels in a year','Speed of a star','Age of a galaxy'],ans:1,xp:130,gems:5},
  {tag:'üî≠ Astronomy',q:'Which planet has the most moons?',opts:['Jupiter','Saturn','Uranus','Neptune'],ans:1,xp:130,gems:5},
];

function generateScienceProblems(){
  const pool = shuffle([...SCIENCE_QUESTION_POOL]);
  const selected = pool.slice(0,6);
  const container = document.getElementById('scienceProblemsList');
  container.innerHTML = '';
  selected.forEach((prob,i)=>{
    const id = 'sp_'+Date.now()+'_'+i;
    const div = document.createElement('div');
    div.className = 'prob-card sci';
    div.id = id;
    const optsHtml = prob.opts.map((o,oi)=>`
      <button onclick="checkSciAnswer('${id}',${oi},${prob.ans},${prob.xp},${prob.gems})" id="sciopt_${id}_${oi}"
        style="flex:1;min-width:calc(50% - 4px);padding:9px 6px;background:#fff;border:2px solid var(--sc-border);border-radius:10px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#4a2a6a;cursor:pointer;transition:all .15s;text-align:center;">
        ${o}
      </button>`).join('');
    div.innerHTML = `
      <div class="prob-tag">${prob.tag}</div>
      <div class="prob-q" style="font-size:14px;font-weight:800;color:#4a2a6a;margin-bottom:10px;">${prob.q}</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">${optsHtml}</div>
      <div id="sfb_${id}" style="font-size:12px;font-weight:800;display:none;border-radius:8px;padding:7px 12px;"></div>
      <div class="prob-xp" style="margin-top:6px;color:var(--sc-dark);">+${prob.xp} XP ¬∑ ${prob.gems} üíé</div>
    `;
    container.appendChild(div);
  });
}

function checkSciAnswer(id, chosen, correct, xp, gems){
  const card = document.getElementById(id);
  const fb = document.getElementById('sfb_'+id);
  if(!card || card.dataset.solved) return;
  const isCorrect = chosen === correct;
  // Color all buttons
  const _nb=card.querySelectorAll('button[id^="sciopt_'+id+'_"]').length;
  for(let i=0;i<_nb;i++){
    const btn = document.getElementById('sciopt_'+id+'_'+i);
    if(!btn) continue;
    btn.disabled = true;
    if(i === correct){
      btn.style.background='#d8f8e8'; btn.style.borderColor='#7adda8'; btn.style.color='#1a6a3a';
    } else if(i === chosen && !isCorrect){
      btn.style.background='#fde8f0'; btn.style.borderColor='#f0a8c8'; btn.style.color='#c04060';
    } else {
      btn.style.opacity='0.45';
    }
  }
  fb.style.display='block';
  if(isCorrect){
    card.dataset.solved='1';
    card.style.borderColor='#b48ee8';
    card.style.background='linear-gradient(135deg,#f5f0ff,#ede4fb)';
    fb.style.background='#e8d8fc'; fb.style.color='#5a3a8a';
    fb.textContent='‚úÖ Correct! +'+xp+' XP & '+gems+' üíé earned!';
    S.scienceXP+=xp; S.gems+=gems; saveState(); renderMap(); checkLevelUp();
    renderScienceScreen();
  } else {
    fb.style.background='#fde8f0'; fb.style.color='#c04060';
    fb.textContent='‚ùå Not quite! The correct answer is highlighted in green.';
  }
}

// Hook into tab switches to auto-generate problems
const _origSwitchModTab = switchModTab;
switchModTab = function(realm, tab, btn){
  _origSwitchModTab(realm, tab, btn);
  if(realm==='m' && tab==='problems' && document.getElementById('mathProblemsList').children.length===0) generateMathProblems();
  if(realm==='s' && tab==='lab' && document.getElementById('scienceProblemsList').children.length===0) generateScienceProblems();
};

// Also generate when screens open
const _origOpenRealm = openRealm;
openRealm = function(id){
  _origOpenRealm(id);
  if(id==='mathScreen') setTimeout(()=>{ if(document.getElementById('mathProblemsList').children.length===0) generateMathProblems(); },100);
  if(id==='scienceScreen') setTimeout(()=>{ if(document.getElementById('scienceProblemsList').children.length===0) generateScienceProblems(); },100);
};



// ADMIN CREDENTIALS - change these to whatever you like
const ADMIN_CREDENTIALS = { username: 'admin', password: 'skilltree123' };

function openAdminPanel(){
  const panel = document.getElementById('adminPanel');
  panel.style.display='flex';
  document.getElementById('adminLogin').style.display='block';
  document.getElementById('adminContent').style.display='none';
  document.getElementById('adminLoginError').style.display='none';
  document.getElementById('adminUser').value='';
  document.getElementById('adminPass').value='';
  setTimeout(()=>document.getElementById('adminUser').focus(),100);
}
function closeAdminPanel(){
  document.getElementById('adminPanel').style.display='none';
}
function checkAdminLogin(){
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value;
  if(user === ADMIN_CREDENTIALS.username && pass === ADMIN_CREDENTIALS.password){
    document.getElementById('adminLogin').style.display='none';
    document.getElementById('adminContent').style.display='block';
    document.getElementById('adminLoginError').style.display='none';
  } else {
    document.getElementById('adminLoginError').style.display='block';
    document.getElementById('adminPass').value='';
    document.getElementById('adminPass').focus();
  }
}
function toggleAdminPassVis(){
  const inp = document.getElementById('adminPass');
  const eye = document.getElementById('adminPassEye');
  if(inp.type==='password'){inp.type='text';eye.textContent='üôà';}
  else{inp.type='password';eye.textContent='üëÅÔ∏è';}
}
document.getElementById('adminPanel').addEventListener('click',function(e){if(e.target===this)closeAdminPanel();});
function adminUnlock(realm){
  const all=['readingXP','writingXP','mathXP','scienceXP','frenchXP','spanishXP'];
  const set=(keys,each)=>keys.forEach(k=>{S[k]=Math.max(S[k],each);});
  // Global XP needed: Lv5=5200, Lv6=7200, Lv8=12400, Lv10=19200, Lv15=43200
  if(realm==='writing') set(['readingXP'],5300);
  if(realm==='math')    set(['readingXP','writingXP','mathXP','scienceXP'],5000);
  if(realm==='science') set(['readingXP','writingXP','mathXP','scienceXP'],11000);
  if(realm==='french')  set(all,1300);   // 6 √ó 1300 = 7800 > Lv6 threshold 7200
  if(realm==='spanish') set(all,2200);   // 6 √ó 2200 = 13200 > Lv8 threshold 12400
  saveState();renderMap();spawnXP('üîì '+realm+' unlocked!','#9060c0');
}
function adminUnlockAll(){
  // 6 √ó 8000 = 48000 > Lv15; enough for all realms including Spanish Lv8
  ['readingXP','writingXP','mathXP','scienceXP','frenchXP','spanishXP'].forEach(k=>{S[k]=Math.max(S[k],8000);});
  saveState();renderMap();closeAdminPanel();spawnXP('‚ú® All unlocked!','#c060a0');
}
function adminLockAll(){
  S.readingXP=0;S.writingXP=0;S.mathXP=0;S.scienceXP=0;S.frenchXP=0;S.spanishXP=0;
  saveState();renderMap();spawnXP('üîí All locked','#a04040');
}
function adminAddXP(realm,amt){
  if(realm==='all'||realm==='reading')S.readingXP+=amt;
  if(realm==='all'||realm==='writing')S.writingXP+=amt;
  if(realm==='all'||realm==='math')S.mathXP+=amt;
  if(realm==='all'||realm==='science')S.scienceXP+=amt;
  if(realm==='all'||realm==='french')S.frenchXP+=amt;
  if(realm==='all'||realm==='spanish')S.spanishXP+=amt;
  saveState();renderMap();checkLevelUp();
  spawnXP('+'+(realm==='all'?amt*6:amt)+' XP ‚ö°','#c060a0');
}
function adminAddGems(amt){S.gems+=amt;saveState();renderMap();spawnXP('+'+amt+' üíé','#9060c0');}
function adminSetStreak(n){S.streak=n;saveState();renderMap();spawnXP('üî• Streak: '+n,'#d07070');}
function adminReset(){
  if(!confirm('Reset ALL progress? This cannot be undone!'))return;
  localStorage.removeItem('stState1');S=loadState();
  saveState();renderMap();updateGradeBadges();closeAdminPanel();spawnXP('üóëÔ∏è Reset!','#c04040');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GRADE SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GRADES=[
  {val:1,label:'1st Grade',short:'Gr.1',e:'üå±'},{val:2,label:'2nd Grade',short:'Gr.2',e:'üåø'},
  {val:3,label:'3rd Grade',short:'Gr.3',e:'üçÄ'},{val:4,label:'4th Grade',short:'Gr.4',e:'üå∏'},
  {val:5,label:'5th Grade',short:'Gr.5',e:'üåª'},{val:6,label:'6th Grade',short:'Gr.6',e:'‚≠ê'},
  {val:7,label:'7th Grade',short:'Gr.7',e:'üî•'},{val:8,label:'8th Grade',short:'Gr.8',e:'üí•'},
  {val:9,label:'9th Grade',short:'Gr.9',e:'üöÄ'},{val:10,label:'10th Grade',short:'Gr.10',e:'üí°'},
  {val:11,label:'11th Grade',short:'Gr.11',e:'üß†'},{val:12,label:'12th Grade',short:'Gr.12',e:'üéì'},
];
function getGradeLabel(g){return(GRADES.find(x=>x.val===g)||GRADES[5]).label;}
function getGradeShort(g){return(GRADES.find(x=>x.val===g)||GRADES[5]).short;}
function updateGradeBadges(){
  const s=getGradeShort(S.gradeLevel||6);
  ['mapGradeBadge','mathGradeBadge','sciGradeBadge','writeGradeBadge','promptGradeBadge'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=s;});
  const pl=document.getElementById('profileGradeLabel');if(pl)pl.textContent=getGradeLabel(S.gradeLevel||6);
  const ab=document.getElementById('adminGradeBtn');if(ab)ab.textContent='üéì Grade: '+getGradeLabel(S.gradeLevel||6);
}
let _tg=6;
function openGradeSheet(){
  _tg=S.gradeLevel||6;
  const g=document.getElementById('gradeGrid');if(!g)return;
  g.innerHTML=GRADES.map(gr=>'<button class="grade-btn'+(_tg===gr.val?' selected':'')+'" data-val="'+gr.val+'" onclick="selectGrade('+gr.val+')">'
    +'<span style="font-size:22px">'+gr.e+'</span><span class="grade-label">'+gr.short+'</span></button>').join('');
  showSheet('gradeSheet');
}
function selectGrade(v){_tg=v;document.querySelectorAll('#gradeGrid .grade-btn').forEach(b=>b.classList.toggle('selected',+b.dataset.val===v));}
function saveGrade(){
  S.gradeLevel=_tg;saveState();closeSheets();updateGradeBadges();
  const ml=document.getElementById('mathProblemsList');if(ml)ml.innerHTML='';
  const sl=document.getElementById('scienceProblemsList');if(sl)sl.innerHTML='';
  renderWritingPrompts();
  if(typeof spawnXP==='function')spawnXP('üéì '+getGradeLabel(S.gradeLevel),'#9060c0');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GRADE MATH POOLS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MATH_GRADE={
  1:[()=>{const a=rnd(1,9),b=rnd(1,9);return{tag:'‚ûï Add',q:a+' + '+b+' = ?',ans:a+b,xp:60,gems:2};},
     ()=>{const a=rnd(2,10),b=rnd(1,a-1);return{tag:'‚ûñ Subtract',q:a+' - '+b+' = ?',ans:a-b,xp:60,gems:2};},
     ()=>{const n=rnd(1,9);return{tag:'üî¢ Count',q:'What comes after '+n+'?',ans:n+1,xp:55,gems:2};}],
  2:[()=>{const a=rnd(10,50),b=rnd(10,40);return{tag:'‚ûï Add',q:a+' + '+b+' = ?',ans:a+b,xp:70,gems:2};},
     ()=>{const a=rnd(2,5),b=rnd(2,5);return{tag:'‚úñÔ∏è Multiply',q:a+' √ó '+b+' = ?',ans:a*b,xp:75,gems:3};},
     ()=>{const a=rnd(5,15);return{tag:'‚úñÔ∏è Doubles',q:'Double '+a+' = ?',ans:a*2,xp:70,gems:2};}],
  3:[()=>{const a=rnd(2,9),b=rnd(2,9);return{tag:'‚úñÔ∏è Multiply',q:a+' √ó '+b+' = ?',ans:a*b,xp:85,gems:3};},
     ()=>{const b=rnd(2,9),a=b*rnd(2,9);return{tag:'‚ûó Divide',q:a+' √∑ '+b+' = ?',ans:a/b,xp:85,gems:3};},
     ()=>{const n=rnd(2,12);return{tag:'üî¢ Square',q:n+' √ó '+n+' = ?',ans:n*n,xp:90,gems:3};}],
  4:[()=>{const a=rnd(10,50),b=rnd(10,30);return{tag:'‚úñÔ∏è Multiply',q:a+' √ó '+b+' = ?',ans:a*b,xp:95,gems:4};},
     ()=>{const p=[10,25,50][rnd(0,2)],t=rnd(2,10)*10;return{tag:'üìä Percent',q:p+'% of '+t+' = ?',ans:p/100*t,xp:100,gems:4};},
     ()=>{const w=rnd(2,15),h=rnd(2,10);return{tag:'üìê Area',q:'Rectangle '+w+'√ó'+h+' area?',ans:w*h,xp:95,gems:4};}],
  5:[()=>{const a=rnd(10,50),b=rnd(10,50);return{tag:'‚úñÔ∏è Multiply',q:a+' √ó '+b+' = ?',ans:a*b,xp:100,gems:4};},
     ()=>{const d=[2,4,5,10][rnd(0,3)],n=rnd(1,d-1);return{tag:'üî¢ Decimal',q:n+'/'+d+' as decimal?',ans:parseFloat((n/d).toFixed(2)),xp:105,gems:4};},
     ()=>{const a=rnd(2,12);return{tag:'üî¢ Squares',q:a+'¬≤ = ?',ans:a*a,xp:110,gems:4};}],
  6:[()=>{const a=rnd(2,9),b=rnd(1,9),c=a*rnd(2,8)+b;return{tag:'üî§ Algebra',q:a+'x + '+b+' = '+c+', x = ?',ans:(c-b)/a,xp:125,gems:5};},
     ()=>{const p=rnd(1,9)*10,t=rnd(2,10)*10;return{tag:'üìä Percent',q:p+'% of '+t+' = ?',ans:p/100*t,xp:110,gems:4};},
     ()=>{const w=rnd(2,15),h=rnd(2,15);return{tag:'üìê Area',q:'Rectangle '+w+'√ó'+h+' cm¬≤?',ans:w*h,xp:110,gems:4};}],
  7:[()=>{const a=rnd(2,9),b=rnd(1,9),c=a*rnd(2,10)+b;return{tag:'üî§ Algebra',q:'Solve: '+a+'x + '+b+' = '+c,ans:(c-b)/a,xp:135,gems:5};},
     ()=>{const a=rnd(2,6);return{tag:'üî¢ Exponent',q:a+'¬≥ = ?',ans:a*a*a,xp:135,gems:5};},
     ()=>{const sq=[4,9,16,25,36,49,64,81,100,121,144];const s=sq[rnd(0,sq.length-1)];return{tag:'‚àö Root',q:'‚àö'+s+' = ?',ans:Math.sqrt(s),xp:135,gems:5};}],
  8:[()=>{const a=rnd(2,6),b=rnd(1,9),c=rnd(5,30);return{tag:'üî§ Algebra',q:a+'x + '+b+' = '+c+'. x = ?',ans:parseFloat(((c-b)/a).toFixed(2)),xp:150,gems:6};},
     ()=>{const m=rnd(-4,4)||1,yi=rnd(-5,5),x=rnd(1,5);return{tag:'üìà Linear',q:'y = '+m+'x + '+yi+'. When x='+x+', y=?',ans:m*x+yi,xp:155,gems:6};},
     ()=>{const a=rnd(3,12),b=rnd(4,12);return{tag:'üìê Pythagoras',q:'Legs '+a+' and '+b+'. Hyp=? (1dp)',ans:parseFloat(Math.sqrt(a*a+b*b).toFixed(1)),xp:195,gems:8};}],
  9:[()=>{const m=rnd(-4,4)||1,yi=rnd(-5,5),x=rnd(1,5);return{tag:'üìà Linear',q:'y='+m+'x+'+yi+'. At x='+x+', y=?',ans:m*x+yi,xp:155,gems:6};},
     ()=>{const d=[30,45,60][rnd(0,2)],s={30:0.5,45:0.71,60:0.87};return{tag:'üìê Trig',q:'sin('+d+'¬∞) ‚âà ? (2dp)',ans:s[d],xp:200,gems:8};},
     ()=>{const b=rnd(2,6),e=rnd(2,4);return{tag:'üî¢ Powers',q:b+'^'+e+' = ?',ans:Math.pow(b,e),xp:160,gems:6};}],
  10:[()=>{const d=[0,30,45,60,90][rnd(0,4)],s={0:0,30:0.5,45:0.71,60:0.87,90:1};return{tag:'üìê Trig',q:'sin('+d+'¬∞) ‚âà ? (2dp)',ans:s[d],xp:195,gems:8};},
      ()=>{const x=rnd(2,8);return{tag:'üìà Exp',q:'2^'+x+' = ?',ans:Math.pow(2,x),xp:185,gems:7};},
      ()=>{const a=rnd(2,5),b=rnd(2,5);return{tag:'üî¢ Binomial',q:'('+a+'+'+b+')¬≤ = ?',ans:(a+b)*(a+b),xp:195,gems:8};}],
  11:[()=>{const n=rnd(2,5);return{tag:'üî¢ Log',q:'log‚ÇÇ('+Math.pow(2,n)+') = ?',ans:n,xp:215,gems:9};},
      ()=>{const d=[30,45,60][rnd(0,2)],c={30:0.87,45:0.71,60:0.5};return{tag:'üìê Trig',q:'cos('+d+'¬∞) ‚âà ? (2dp)',ans:c[d],xp:205,gems:8};},
      ()=>{const a=rnd(2,5),b=rnd(2,5);return{tag:'üî¢ Factor',q:'('+a+'+'+b+')¬≤ = ?',ans:(a+b)*(a+b),xp:200,gems:8};}],
  12:[()=>{const n=rnd(2,6);return{tag:'üî¢ Log',q:'ln(e^'+n+') = ?',ans:n,xp:225,gems:9};},
      ()=>{const a=rnd(2,5),b=rnd(2,5);return{tag:'‚à´ Calc',q:'‚à´ x^'+a+' dx ‚Üí power is?',ans:a+1,xp:250,gems:10};},
      ()=>{const a=rnd(2,5),b=rnd(2,5);return{tag:'üî¢ Seq',q:'Arith: '+a+', '+(a+b)+', '+(a+2*b)+', next?',ans:a+3*b,xp:225,gems:9};}],
};
function getMathPool(){
  const g=Math.max(1,Math.min(12,S.gradeLevel||6));
  const gp=MATH_GRADE[g]||MATH_GRADE[6];
  return [...gp,...gp,...MATH_PROBLEM_POOL];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GRADE SCIENCE POOLS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCI_GRADE={
  1:[{tag:'üå± Life',q:'What do plants need to grow?',opts:['Sun, water, air','Just water','Only soil','Only sun'],ans:0,xp:60,gems:2},
     {tag:'üêæ Animals',q:'Which animal lays eggs?',opts:['Dog','Cat','Bird','Cow'],ans:2,xp:60,gems:2},
     {tag:'üå°Ô∏è Seasons',q:'Most snow in which season?',opts:['Spring','Summer','Fall','Winter'],ans:3,xp:65,gems:2}],
  2:[{tag:'üå± Plants',q:'What part makes food using sunlight?',opts:['Root','Stem','Leaf','Flower'],ans:2,xp:70,gems:2},
     {tag:'üê∏ Life Cycle',q:'A caterpillar turns into a?',opts:['Moth','Butterfly','Bee','Dragonfly'],ans:1,xp:70,gems:2},
     {tag:'üåç Earth',q:'What shape is the Earth?',opts:['Flat','Square','Sphere','Oval'],ans:2,xp:70,gems:2}],
  3:[{tag:'üß≤ Forces',q:'What pulls objects to the ground?',opts:['Magnetism','Gravity','Friction','Push'],ans:1,xp:80,gems:3},
     {tag:'üíß Water Cycle',q:'Water turning to vapor is called?',opts:['Condensation','Precipitation','Evaporation','Collection'],ans:2,xp:85,gems:3},
     {tag:'‚ö° Energy',q:'Which is a renewable energy source?',opts:['Coal','Oil','Solar','Gas'],ans:2,xp:85,gems:3}],
  4:[{tag:'üåç Earth',q:'What layer do we live on?',opts:['Core','Mantle','Crust','Magma'],ans:2,xp:90,gems:3},
     {tag:'üî≠ Space',q:'What causes day and night?',opts:['Earth orbiting Sun','Moon moving','Earth rotating','Sun moving'],ans:2,xp:90,gems:3},
     {tag:'‚ö° Electric',q:'What flows through a circuit?',opts:['Water','Air','Electricity','Heat'],ans:2,xp:90,gems:3}],
  5:[{tag:'üß¨ Biology',q:'Powerhouse of the cell?',opts:['Nucleus','Cell Wall','Mitochondria','Ribosome'],ans:2,xp:100,gems:4},
     {tag:'‚öóÔ∏è Chemistry',q:'What is H‚ÇÇO?',opts:['Hydrogen','Oxygen','Water','Salt'],ans:2,xp:95,gems:3},
     {tag:'‚ö° Physics',q:'A moving ball has which energy?',opts:['Potential','Chemical','Kinetic','Thermal'],ans:2,xp:100,gems:4}],
  6:[{tag:'üß¨ Biology',q:'What carries oxygen in red blood cells?',opts:['Plasma','Platelets','Hemoglobin','White cells'],ans:2,xp:110,gems:4},
     {tag:'‚öóÔ∏è Chemistry',q:'Acids have a pH that is‚Ä¶',opts:['Greater than 7','Equal to 7','Less than 7','Zero'],ans:2,xp:110,gems:4},
     {tag:'üåç Atmosphere',q:'Most abundant gas in atmosphere?',opts:['Oxygen','CO‚ÇÇ','Argon','Nitrogen'],ans:3,xp:115,gems:4}],
  7:[{tag:'‚öóÔ∏è Chemistry',q:'Symbol for gold?',opts:['Go','Gd','Ag','Au'],ans:3,xp:120,gems:5},
     {tag:'üß¨ Biology',q:'Plants make food by?',opts:['Respiration','Digestion','Photosynthesis','Fermentation'],ans:2,xp:120,gems:5},
     {tag:'‚ö° Physics',q:'Unit of electrical current?',opts:['Volt','Watt','Ampere','Ohm'],ans:2,xp:125,gems:5}],
  8:[{tag:'‚öóÔ∏è Chemistry',q:'Elements in periodic table?',opts:['78','98','118','138'],ans:2,xp:130,gems:5},
     {tag:'‚ö° Physics',q:'Speed of light (km/s approx)?',opts:['3,000','30,000','300,000','3,000,000'],ans:2,xp:135,gems:5},
     {tag:'‚ö° Physics',q:"Newton's 1st law is about?",opts:['F=ma','Inertia','Gravity','Energy'],ans:1,xp:135,gems:5}],
  9:[{tag:'‚öóÔ∏è Chemistry',q:'Atomic number of carbon?',opts:['4','6','8','12'],ans:1,xp:145,gems:6},
     {tag:'‚ö° Physics',q:"Ohm's Law: V = ?",opts:['V=P/I','V=IR','V=I/R','V=I¬≤R'],ans:1,xp:150,gems:6},
     {tag:'üß¨ Biology',q:'DNA stands for?',opts:['Deoxyribonucleic Acid','Deoxyribonicotinic Acid','Diribonucleic Acid','Dynamic Nuclear Acid'],ans:0,xp:145,gems:6}],
  10:[{tag:'‚öóÔ∏è Chemistry',q:'Bond with shared electrons?',opts:['Ionic','Metallic','Covalent','Hydrogen'],ans:2,xp:160,gems:6},
      {tag:'‚ö° Physics',q:'E = mc¬≤ represents?',opts:['Efficiency','Mass-energy equiv.','Electron charge','Elastic PE'],ans:1,xp:165,gems:7},
      {tag:'üß¨ Biology',q:'Copying DNA is called?',opts:['Translation','Transcription','Replication','Mutation'],ans:2,xp:160,gems:6}],
  11:[{tag:'‚öóÔ∏è Chemistry',q:'Molar mass of H‚ÇÇO?',opts:['16 g/mol','18 g/mol','20 g/mol','14 g/mol'],ans:1,xp:175,gems:7},
      {tag:'üß¨ Biology',q:'Meiosis gives humans how many chromosomes?',opts:['46','48','23','44'],ans:2,xp:180,gems:7},
      {tag:'üåç Atmosphere',q:'~78% of atmosphere is?',opts:['Oxygen','CO‚ÇÇ','Argon','Nitrogen'],ans:3,xp:170,gems:7}],
  12:[{tag:'‚öóÔ∏è Chemistry',q:"Avogadro's number (approx)?",opts:['6.02√ó10¬≤¬≥','3.14√ó10¬≤¬≥','1.67√ó10¬≤‚Å∑','9.11√ó10¬≤‚Å∏'],ans:0,xp:200,gems:8},
      {tag:'‚ö° Physics',q:'SI unit of electric charge?',opts:['Ampere','Volt','Coulomb','Farad'],ans:2,xp:200,gems:8},
      {tag:'üß¨ Biology',q:'Role of mRNA?',opts:['Store DNA','Carry amino acids','Carry genetic info to ribosome','Form chromosomes'],ans:2,xp:200,gems:8}],
};
function getSciPool(){
  const g=Math.max(1,Math.min(12,S.gradeLevel||6));
  return [...(SCI_GRADE[g]||SCI_GRADE[6]),...(SCI_GRADE[g]||SCI_GRADE[6]),...SCIENCE_QUESTION_POOL];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GRADE WRITING PROMPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WRITE_PROMPTS={
  1:['Describe your favorite animal!','Write about your best friend.','If you had a superpower, what would it be?','What is your favorite food and why?'],
  2:['Write about a fun thing you did this week.','Describe your favorite place to play.','What would you do if you found a magic wand?','Write about a talking pet.'],
  3:['Write a story about a forest adventure.','Describe your perfect day from start to finish.','If you could visit any country, where and why?','What is your favorite book?'],
  4:['Argue: dogs OR cats make the best pets!','Describe a challenge you overcame.','Imagine you are Principal for a day.','Write a mystery with a surprising ending.'],
  5:['Write about a person in history you admire.','Describe a problem in your school and a solution.','If you could time travel, where would you go?','Write from the perspective of an animal.'],
  6:['Compare two books you have read.','Describe an important historical event.','If you could change one school rule, what and why?','Write a sci-fi story set 100 years ahead.'],
  7:['Argue: social media does more harm than good.','Write about a moment that changed your thinking.','Describe a scientific discovery and why it matters.','Story: "The last train had already left..."'],
  8:["Analyze a theme in a book you've read.",'Should schools have uniforms? Persuasive essay.','How has technology changed communication?','Write a story exploring identity.'],
  9:['Analyze causes and effects of a historical event.','What do you want to achieve in 5 years?','Is economic growth more important than the environment?','Write a story with an unreliable narrator.'],
  10:['Compare two philosophical worldviews.','Research-style essay on a science topic.','What responsibility do we have to society?','Write a story using symbolism to convey deeper meaning.'],
  11:['Literary analysis of a novel you have studied.','Argue your position on an ethical dilemma in tech.','How do cultural biases shape historical narratives?','Write in the style of a writer you admire, then reflect.'],
  12:['College-level essay on a topic you are passionate about.','Reflect: what shaped who you are today?','Argumentative essay on a complex policy issue.','Write a story capturing what it means to be human.'],
};
const WP_TAGS=['üåü Featured','üó∫Ô∏è Adventure','üí≠ Reflective','üé≠ Challenge','üéÅ Creative'];
function getWritingPrompts(){return WRITE_PROMPTS[Math.max(1,Math.min(12,S.gradeLevel||6))]||WRITE_PROMPTS[6];}
function renderWritingPrompts(){
  const c=document.getElementById('writingPromptsContainer');if(!c)return;
  const prompts=getWritingPrompts();
  c.innerHTML=prompts.map((p,i)=>'<div class="wp-card" onclick="openWriteSheetWithPrompt(\''+p.replace(/'/g,"\\'")+'\')">'
    +'<div class="wp-tag">'+WP_TAGS[i%WP_TAGS.length]+'<\/div>'
    +'<div class="wp-text">'+p+'<\/div>'
    +'<div class="wp-xp">+150‚Äì500 XP ¬∑ Write 50+ words<\/div><\/div>').join('');
}

// Override math generator to use grade pool
const _ogm=generateMathProblems;
generateMathProblems=function(){
  const pool=shuffle([...getMathPool()]);
  const sel=pool.slice(0,6).map(fn=>fn());
  const c=document.getElementById('mathProblemsList');if(!c)return;
  c.innerHTML='';
  sel.forEach((prob,idx)=>{
    const id='mp_'+Date.now()+'_'+idx;
    const div=document.createElement('div');
    div.className='prob-card fade-in';div.id=id;
    div.innerHTML='<div class="prob-tag">'+prob.tag+'<\/div>'
      +'<div class="prob-q">'+prob.q+'<\/div>'
      +'<div style="display:flex;gap:8px;margin-top:10px;align-items:center;">'
      +'<input id="mi_'+id+'" type="number" placeholder="Your answer" style="flex:1;border:2px solid var(--m-border);border-radius:10px;padding:8px 10px;font-family:Nunito,sans-serif;font-size:13px;font-weight:700;outline:none;" onkeydown="if(event.key===\'Enter\')checkMathAnswer(\''+id+'\','+prob.ans+','+prob.xp+','+prob.gems+')">'
      +'<button onclick="checkMathAnswer(\''+id+'\','+prob.ans+','+prob.xp+','+prob.gems+')" style="padding:8px 16px;background:linear-gradient(135deg,#3aaa80,#5bcca0);color:#fff;border:none;border-radius:10px;font-family:Fredoka,sans-serif;font-size:13px;font-weight:700;cursor:pointer;">Check<\/button>'
      +'<\/div>'
      +'<div id="mfb_'+id+'" style="display:none;margin-top:6px;font-size:12px;font-weight:800;"><\/div>'
      +'<div class="prob-xp" style="margin-top:6px;">+'+prob.xp+' XP ¬∑ +'+prob.gems+' üíé<\/div>';
    c.appendChild(div);
  });
};

// Override science generator to use grade pool
const _ogs=generateScienceProblems;
generateScienceProblems=function(){
  const pool=shuffle([...getSciPool()]);
  const sel=pool.slice(0,5);
  const c=document.getElementById('scienceProblemsList');if(!c)return;
  c.innerHTML='';
  sel.forEach((prob,idx)=>{
    const id='sp_'+Date.now()+'_'+idx;
    const div=document.createElement('div');
    div.className='prob-card sci fade-in';div.id=id;
    const opts=prob.opts.map((o,i)=>'<button id="sciopt_'+id+'_'+i+'" onclick="checkSciAnswer(\''+id+'\','+i+','+prob.ans+','+prob.xp+','+prob.gems+')" '
      +'style="width:100%;padding:9px 12px;text-align:left;background:#fff;border:2px solid var(--sc-border);border-radius:10px;'
      +'font-family:Nunito,sans-serif;font-size:12px;font-weight:700;color:#1e0040;cursor:pointer;transition:all .15s;margin-bottom:6px;">'
      +String.fromCharCode(65+i)+'. '+o+'<\/button>').join('');
    div.innerHTML='<div class="prob-tag" style="color:var(--sc-dark)">'+prob.tag+'<\/div>'
      +'<div class="prob-q" style="color:#1e0040">'+prob.q+'<\/div>'
      +'<div id="sfb_'+id+'" style="display:none;margin-top:6px;font-size:12px;font-weight:800;"><\/div>'
      +'<div style="margin-top:10px;">'+opts+'<\/div>'
      +'<div class="prob-xp" style="color:var(--sc-dark)">+'+prob.xp+' XP ¬∑ +'+prob.gems+' üíé<\/div>';
    c.appendChild(div);
  });
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PWA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function pwa(){
  function makeIcon(sz){
    const c=document.createElement('canvas');c.width=c.height=sz;
    const ctx=c.getContext('2d');
    const g=ctx.createLinearGradient(0,0,sz,sz);
    g.addColorStop(0,'#e8c8ff');g.addColorStop(1,'#a880d8');
    ctx.fillStyle=g;
    const r=sz*.22;ctx.beginPath();
    ctx.moveTo(r,0);ctx.arcTo(sz,0,sz,sz,r);ctx.arcTo(sz,sz,0,sz,r);
    ctx.arcTo(0,sz,0,0,r);ctx.arcTo(0,0,sz,0,r);ctx.closePath();ctx.fill();
    ctx.font=Math.round(sz*.55)+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('üå≥',sz/2,sz*.5);
    ctx.font='bold '+Math.round(sz*.115)+'px sans-serif';ctx.fillStyle='#4a2a6a';
    ctx.fillText('SkillTree',sz/2,sz*.87);
    return c.toDataURL('image/png');
  }
  const ic192=makeIcon(192),ic512=makeIcon(512),ic180=makeIcon(180);
  const al=document.getElementById('appleTouchIcon');if(al)al.href=ic180;
  const mf={name:'SkillTree',short_name:'SkillTree',description:'Level up your learning!',
    start_url:'.',display:'standalone',orientation:'portrait',
    background_color:'#fdf6ff',theme_color:'#9060c0',categories:['education'],
    icons:[{src:ic192,sizes:'192x192',type:'image/png',purpose:'any maskable'},
           {src:ic512,sizes:'512x512',type:'image/png',purpose:'any maskable'}]};
  const ml=document.getElementById('pwaManifest');
  if(ml)ml.href=URL.createObjectURL(new Blob([JSON.stringify(mf)],{type:'application/manifest+json'}));
  if('serviceWorker' in navigator){
    const sw=[
      "const C='st-v1';",
      "const F=['fonts.googleapis.com','fonts.gstatic.com'];",
      "self.addEventListener('install',e=>{self.skipWaiting();});",
      "self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k)))).then(()=>self.clients.claim()));});",
      "self.addEventListener('fetch',e=>{",
      "  if(e.request.method!=='GET')return;",
      "  const u=e.request.url;",
      "  if(F.some(f=>u.includes(f))){",
      "    e.respondWith(caches.match(e.request).then(r=>{",
      "      if(r)return r;",
      "      return fetch(e.request).then(r2=>{caches.open(C).then(c=>c.put(e.request,r2.clone()));return r2;}).catch(()=>new Response('',{status:408}));",
      "    }));return;",
      "  }",
      "  e.respondWith(fetch(e.request).then(r=>{caches.open(C).then(c=>c.put(e.request,r.clone()));return r;}).catch(()=>caches.match(e.request).then(r=>r||new Response('Offline',{status:503}))));",
      "});"
    ].join('\n');
    try{
      navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'text/javascript'})),{scope:'./'})
        .then(reg=>{
          reg.addEventListener('updatefound',()=>{
            const nw=reg.installing;
            nw.addEventListener('statechange',()=>{
              if(nw.state==='installed'&&navigator.serviceWorker.controller){
                const t=document.createElement('div');
                t.style.cssText='position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#5a3a6a;color:#fff;border-radius:14px;padding:10px 18px;font-size:12px;font-weight:800;z-index:99999;cursor:pointer;font-family:Nunito,sans-serif;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.25);';
                t.textContent='‚ú® Update ready ‚Äî tap to refresh!';
                t.onclick=()=>location.reload();
                document.body.appendChild(t);setTimeout(()=>t.remove(),8000);
              }
            });
          });
        }).catch(err=>console.warn('SW:',err));
    }catch(e){}
  }
  let _dp=null;
  const banner=document.getElementById('pwaInstallBanner');
  const ib=document.getElementById('pwaInstallBtn');
  const db=document.getElementById('pwaInstallDismiss');
  window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();_dp=e;
    if(banner&&!localStorage.getItem('pwaDismissed')&&localStorage.getItem('stIntroSeen'))banner.style.display='flex';
  });
  if(ib)ib.addEventListener('click',async()=>{
    if(!_dp)return;
    if(banner)banner.style.display='none';
    _dp.prompt();
    const{outcome}=await _dp.userChoice;_dp=null;
    if(outcome==='accepted'&&typeof spawnXP==='function')spawnXP('üì≤ Installed!','#9060c0');
  });
  if(db)db.addEventListener('click',()=>{if(banner)banner.style.display='none';localStorage.setItem('pwaDismissed','1');});
  window.addEventListener('appinstalled',()=>{if(banner)banner.style.display='none';_dp=null;});
  const isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent)&&!window.navigator.standalone;
  if(isIOS&&!localStorage.getItem('iosHint')&&localStorage.getItem('stIntroSeen')){
    setTimeout(()=>{
      const d=document.createElement('div');
      d.style.cssText='position:fixed;bottom:0;left:0;right:0;z-index:99999;background:linear-gradient(135deg,#5a3a7a,#9060c0);color:#fff;padding:16px 18px 32px;border-radius:22px 22px 0 0;font-family:Nunito,sans-serif;box-shadow:0 -4px 30px rgba(90,40,130,.4);';
      d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">'
        +'<div style="font-family:Fredoka,sans-serif;font-size:17px;font-weight:700;">üå≥ Install SkillTree<\/div>'
        +'<button onclick="this.closest(\'div\').parentElement.remove();localStorage.setItem(\'iosHint\',1)" style="width:28px;height:28px;background:rgba(255,255,255,.2);border:none;border-radius:50%;color:#fff;font-size:14px;cursor:pointer;">‚úï<\/button>'
        +'<\/div>'
        +'<div style="font-size:13px;line-height:1.7;opacity:.92;">Add to your Home Screen for offline use:<br>'
        +'<strong>Tap üì§ Share ‚Üí "Add to Home Screen" ‚Üí ‚ûï<\/strong><\/div>';
      document.body.appendChild(d);
      setTimeout(()=>{if(d.isConnected){d.remove();localStorage.setItem('iosHint',1);}},12000);
    },2500);
  }
})();


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LANGUAGE REALM ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LANG_LEVELS=[0,600,1400,2500,4000,6000,8500,11500,15000,19500,25000];
const FR_TITLES=['Touriste','Voyageur','Habitant','Citoyen','Parisien','Acad√©micien','Ma√Ætre','Expert','√âlite','L√©gende','Immortel'];
const ES_TITLES=['Turista','Viajero','Residente','Ciudadano','Madrile√±o','Acad√©mico','Maestro','Experto','√âlite','Leyenda','Inmortal'];

// Language mode state per language
const _langState={
  fr:{mode:'beginner',history:[],msgCount:0},
  es:{mode:'beginner',history:[],msgCount:0},
};

const LANG_CONFIG={
  fr:{
    name:'French',flag:'üá´üá∑',accent:'#d4703a',light:'#fff8f2',border:'#f7cfa8',dark:'#c4683a',
    systemPrompt:`You are Am√©lie, a warm and encouraging French language tutor for students. Your personality is friendly, patient, and enthusiastic.

MODES:
- beginner: Use simple vocabulary, lots of English, teach basics (greetings, numbers, colors). Always translate. Give short phrases with pronunciation hints.
- conversation: Mix French and English 50/50. Correct mistakes gently. Ask follow-up questions. Keep it natural.
- grammar: Explain French grammar rules clearly with examples. Use tables if helpful. Correct errors explicitly.
- culture: Share interesting facts about French culture, food, art, history. Weave in vocabulary naturally.

ALWAYS:
- Keep responses concise (2-4 short paragraphs max)
- Include at least 1-3 French words/phrases per message, always with translation in parentheses
- Use encouraging emoji occasionally ü•êüóº‚ú®
- End with a question or prompt to keep the conversation going
- If the user writes French, praise them and gently correct any errors`,
    vocabTopics:['Greetings & Politeness','Numbers & Counting','Colors & Shapes','Food & Drinks','Family & Friends','Days & Months','Weather & Seasons','School & Work','Travel & Places','Body & Health'],
    quizStyle:'French'
  },
  es:{
    name:'Spanish',flag:'üá™üá∏',accent:'#3a80c4',light:'#f0f8ff',border:'#a8d8f7',dark:'#1a60a4',
    systemPrompt:`You are Carlos, a warm and encouraging Spanish language tutor for students. Your personality is upbeat, patient, and fun.

MODES:
- beginner: Use simple vocabulary, lots of English, teach basics (greetings, numbers, colors). Always translate. Give short phrases with pronunciation hints.
- conversation: Mix Spanish and English 50/50. Correct mistakes gently. Ask follow-up questions. Keep it natural.
- grammar: Explain Spanish grammar rules clearly with examples. Use tables if helpful. Correct errors explicitly.
- culture: Share interesting facts about Spanish/Latin culture, food, music, history. Weave in vocabulary naturally.

ALWAYS:
- Keep responses concise (2-4 short paragraphs max)
- Include at least 1-3 Spanish words/phrases per message, always with translation in parentheses
- Use encouraging emoji occasionally üåÆüíÉ‚ú®
- End with a question or prompt to keep the conversation going
- If the user writes Spanish, praise them and gently correct any errors`,
    vocabTopics:['Saludos y cortes√≠a','N√∫meros','Colores','Comida y bebidas','Familia','D√≠as y meses','El tiempo','Escuela','Viajes','Cuerpo'],
    quizStyle:'Spanish'
  }
};

function renderLangScreen(lang){
  const cfg=LANG_CONFIG[lang];
  const ls=_langState[lang];
  const xp=lang==='fr'?S.frenchXP:S.spanishXP;
  const levels=LANG_LEVELS;
  const lv=getLevel(xp,levels);
  const prog=getLevelProgress(xp,levels);
  const nextXP=levels[lv]||levels[levels.length-1]+5000;
  const titles=lang==='fr'?FR_TITLES:ES_TITLES;
  document.getElementById(lang+'XpBannerLbl').textContent=cfg.name.toUpperCase()+' LEVEL '+lv;
  document.getElementById(lang+'XpBannerNum').innerHTML=xp.toLocaleString()+' <span>/ '+nextXP.toLocaleString()+' XP</span>';
  document.getElementById(lang+'XpFill').style.width=prog.pct+'%';
  document.getElementById(lang+'XpBannerSub').textContent=lv>=10?'Max '+cfg.name+' level! üéâ':((nextXP-xp).toLocaleString()+' XP to Lv '+(lv+1)+' ¬∑ '+(titles[lv-1]||''));
  // Restore quest done states
  applyMQDoneState(document.getElementById(lang+'-quests'));
  // Open to vocab tab
  switchLangTab(lang,'vocab',null);
}

function initLangChat(lang){
  const cfg=LANG_CONFIG[lang];
  const greetings={
    fr:"Bonjour! Je m'appelle Am√©lie, your French tutor! ü•ê\n\nI'm here to help you learn French in a fun way. We can chat, practice pronunciation, explore vocabulary, or dive into French culture!\n\nWhat would you like to start with? You can type in English or try some French ‚Äî don't be shy! üòä",
    es:"¬°Hola! Me llamo Carlos, your Spanish tutor! üåÆ\n\nI'm here to help you learn Spanish in a fun and friendly way. We can chat, practice phrases, explore vocabulary, or talk about Latin culture!\n\n¬øQu√© quieres aprender hoy? (What do you want to learn today?) You can type in English or try some Spanish ‚Äî no worries! üòä"
  };
  addChatBubble(lang,'ai',greetings[lang]);
}

function setLangMode(lang,mode){
  _langState[lang].mode=mode;
  // Update mode button styles
  const cfg=LANG_CONFIG[lang];
  ['beginner','conversation','grammar','culture'].forEach(m=>{
    const btn=document.getElementById(lang+'Mode-'+m);
    if(!btn)return;
    const active=m===mode;
    btn.style.background=active?cfg.light:'';
    btn.style.color=active?cfg.dark:'';
    btn.style.borderColor=active?cfg.border:'';
  });
  addChatBubble(lang,'ai',{
    beginner:'Switching to Beginner mode! üå± I\'ll use simple words and always translate. Let\'s start with the basics!',
    conversation:'Switching to Conversation mode! üí¨ Let\'s chat naturally ‚Äî I\'ll mix both languages.',
    grammar:'Switching to Grammar mode! üìù I\'ll explain rules clearly with examples. Ask me anything!',
    culture:'Switching to Culture mode! üåç Let\'s explore the fascinating culture, food, and history!'
  }[mode]);
}

function addChatBubble(lang,role,text){
  const box=document.getElementById(lang+'ChatMessages');
  if(!box)return;
  const div=document.createElement('div');
  div.className='chat-bubble '+role+(role==='ai'?' '+lang:'');
  div.style.cssText=role==='ai'?'align-self:flex-start;':'align-self:flex-end;';
  // Format newlines
  div.innerHTML=text.replace(/\n/g,'<br>');
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

function showLangTyping(lang){
  const box=document.getElementById(lang+'ChatMessages');
  if(!box)return null;
  const div=document.createElement('div');
  div.className='chat-bubble ai '+lang;
  div.style.cssText='align-self:flex-start;';
  div.innerHTML='<div class="lang-typing"><div class="lang-dot" style="background:var(--'+lang+'-dark)"></div><div class="lang-dot" style="background:var(--'+lang+'-dark)"></div><div class="lang-dot" style="background:var(--'+lang+'-dark)"></div></div>';
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
  return div;
}

async function sendLangMessage(lang){
  const input=document.getElementById(lang+'ChatInput');
  const sendBtn=document.getElementById(lang+'ChatSend');
  const text=input.value.trim();
  if(!text)return;
  input.value='';
  sendBtn.disabled=true;

  addChatBubble(lang,'user',text);
  const ls=_langState[lang];
  ls.history.push({role:'user',content:text});
  // Track message count for quest
  ls.msgCount++;
  if(ls.msgCount===5){
    // Auto-complete AI chat quest
    const qid=lang===('fr')?'fr-chat-ai':'es-chat-ai';
    const qEl=document.querySelector('[data-mqid="'+qid+'"]');
    if(qEl&&!qEl.classList.contains('done'))qEl.click();
  }

  const typingEl=showLangTyping(lang);
  try{
    const cfg=LANG_CONFIG[lang];
    const messages=[{role:'user',content:cfg.systemPrompt+'\n\nMode: '+ls.mode+'\n\n---\n\nUser message: '+text}];
    // Include recent history (last 8 messages for context)
    const recent=ls.history.slice(-8);
    const finalMsgs=recent.length>1?recent:messages;

    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:600,
        system:cfg.systemPrompt+'\n\nCurrent mode: '+ls.mode,
        messages:finalMsgs
      })
    });
    const data=await resp.json();
    if(typingEl)typingEl.remove();
    if(data.content&&data.content[0]){
      const reply=data.content[0].text;
      ls.history.push({role:'assistant',content:reply});
      addChatBubble(lang,'ai',reply);
      // Award XP for chatting
      const xpGain=25;
      if(lang==='fr')S.frenchXP+=xpGain;else S.spanishXP+=xpGain;
      S.gems+=1;saveState();checkLevelUp();
      spawnXP('+'+xpGain+' XP üí¨','#9060c0');
    }else{
      addChatBubble(lang,'ai','Oops! Something went wrong. Please try again. üòÖ');
    }
  }catch(e){
    if(typingEl)typingEl.remove();
    addChatBubble(lang,'ai','Network error ‚Äî please check your connection and try again! üåê');
  }
  sendBtn.disabled=false;
  input.focus();
}

function switchLangTab(lang,tab,btn){
  // Hide all tabs explicitly
  ['vocab','quiz','quests'].forEach(t=>{
    const s=document.getElementById(lang+'-'+t);
    if(s){s.classList.remove('active');s.style.display='none';}
  });
  // Show selected tab
  const el=document.getElementById(lang+'-'+tab);
  if(el){el.classList.add('active');el.style.display='block';}
  // Pill active state
  const cfg=LANG_CONFIG[lang];
  ['vocab','quiz','quests'].forEach(t=>{
    const p=document.getElementById(lang+'Pill-'+t);if(!p)return;
    const active=t===tab;
    p.style.background=active?cfg.light:(lang==='fr'?'#fff8f2':'#f0f8ff');
    p.style.color=active?cfg.dark:cfg.accent;
    p.style.borderColor=active?cfg.border:(lang==='fr'?'#f7cfa8':'#a8d8f7');
  });
  // Lazy-load vocab on open
  if(tab==='vocab'){const vl=document.getElementById(lang+'VocabList');if(vl&&!vl.children.length)loadVocab(lang);}
  if(tab==='quests')applyMQDoneState(document.getElementById(lang+'-quests'));
}

// ‚îÄ‚îÄ HARDCODED VOCAB BANKS (no API needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VOCAB_BANK = {
  fr: [
    { topic:'Greetings üá´üá∑', words:[
      {word:'Bonjour',translation:'Hello / Good morning',example:'Bonjour, comment √ßa va?',emoji:'üëã'},
      {word:'Bonsoir',translation:'Good evening',example:'Bonsoir, madame!',emoji:'üåô'},
      {word:'Au revoir',translation:'Goodbye',example:'Au revoir, √† demain!',emoji:'üëã'},
      {word:'Merci',translation:'Thank you',example:'Merci beaucoup!',emoji:'üôè'},
      {word:"S'il vous pla√Æt",translation:'Please',example:"Un caf√©, s'il vous pla√Æt.",emoji:'‚òï'},
      {word:'Excusez-moi',translation:'Excuse me',example:'Excusez-moi, o√π est la gare?',emoji:'üöâ'},
      {word:'De rien',translation:"You're welcome",example:'Merci! ‚Äî De rien!',emoji:'üòä'},
      {word:'Enchant√©(e)',translation:'Nice to meet you',example:'Enchant√© de vous rencontrer.',emoji:'ü§ù'},
    ]},
    { topic:'Numbers üî¢', words:[
      {word:'Un / Une',translation:'One',example:"J'ai un chat.",emoji:'1Ô∏è‚É£'},
      {word:'Deux',translation:'Two',example:"Deux baguettes, s'il vous pla√Æt.",emoji:'2Ô∏è‚É£'},
      {word:'Cinq',translation:'Five',example:'Il est cinq heures.',emoji:'5Ô∏è‚É£'},
      {word:'Dix',translation:'Ten',example:"J'ai dix ans.",emoji:'üîü'},
      {word:'Vingt',translation:'Twenty',example:'Vingt √©l√®ves dans la classe.',emoji:'‚úåÔ∏è'},
      {word:'Cent',translation:'One hundred',example:'Cent euros.',emoji:'üíØ'},
      {word:'Mille',translation:'One thousand',example:'Mille mercis!',emoji:'üéä'},
      {word:'Premier / Premi√®re',translation:'First',example:"Le premier jour de l'√©cole.",emoji:'ü•á'},
    ]},
    { topic:'Colors üé®', words:[
      {word:'Rouge',translation:'Red',example:'Une pomme rouge.',emoji:'üî¥'},
      {word:'Bleu(e)',translation:'Blue',example:'Le ciel est bleu.',emoji:'üîµ'},
      {word:'Vert(e)',translation:'Green',example:"L'herbe est verte.",emoji:'üü¢'},
      {word:'Jaune',translation:'Yellow',example:'Un tournesol jaune.',emoji:'üü°'},
      {word:'Blanc / Blanche',translation:'White',example:'La neige est blanche.',emoji:'‚¨ú'},
      {word:'Noir(e)',translation:'Black',example:'Un chat noir.',emoji:'‚¨õ'},
      {word:'Rose',translation:'Pink',example:'Une fleur rose.',emoji:'üå∏'},
      {word:'Violet(te)',translation:'Purple',example:'Un stylo violet.',emoji:'üíú'},
    ]},
    { topic:'Food üçΩÔ∏è', words:[
      {word:'Le pain',translation:'Bread',example:"J'aime le pain frais.",emoji:'üçû'},
      {word:'Le fromage',translation:'Cheese',example:'Le fromage fran√ßais est d√©licieux.',emoji:'üßÄ'},
      {word:'La pomme',translation:'Apple',example:'Je mange une pomme.',emoji:'üçé'},
      {word:'Le poulet',translation:'Chicken',example:'Le poulet r√¥ti est bon.',emoji:'üçó'},
      {word:'La soupe',translation:'Soup',example:'La soupe est chaude.',emoji:'üç≤'},
      {word:'Le g√¢teau',translation:'Cake',example:'Un g√¢teau au chocolat.',emoji:'üéÇ'},
      {word:"L'eau",translation:'Water',example:"Un verre d'eau, s'il vous pla√Æt.",emoji:'üíß'},
      {word:'Le lait',translation:'Milk',example:'Je bois du lait chaque matin.',emoji:'ü•õ'},
    ]},
    { topic:'Animals üêæ', words:[
      {word:'Le chien',translation:'Dog',example:"Mon chien s'appelle Rex.",emoji:'üêï'},
      {word:'Le chat',translation:'Cat',example:'Le chat dort sur le canap√©.',emoji:'üêà'},
      {word:"L'oiseau",translation:'Bird',example:"Un oiseau chante dans l'arbre.",emoji:'üê¶'},
      {word:'Le lapin',translation:'Rabbit',example:'Un lapin blanc et doux.',emoji:'üêá'},
      {word:'Le cheval',translation:'Horse',example:'Le cheval court vite.',emoji:'üê¥'},
      {word:'Le lion',translation:'Lion',example:'Le lion est le roi des animaux.',emoji:'ü¶Å'},
      {word:"L'√©l√©phant",translation:'Elephant',example:"L'√©l√©phant a une longue trompe.",emoji:'üêò'},
      {word:'Le poisson',translation:'Fish',example:'Un poisson rouge dans un bocal.',emoji:'üêü'},
    ]},
    { topic:'Family üë®‚Äçüë©‚Äçüëß', words:[
      {word:'La m√®re',translation:'Mother',example:'Ma m√®re est gentille.',emoji:'üë©'},
      {word:'Le p√®re',translation:'Father',example:'Mon p√®re travaille beaucoup.',emoji:'üë®'},
      {word:'Le fr√®re',translation:'Brother',example:'Mon fr√®re aime le foot.',emoji:'üë¶'},
      {word:'La s≈ìur',translation:'Sister',example:'Ma s≈ìur lit un livre.',emoji:'üëß'},
      {word:'Les parents',translation:'Parents',example:'Mes parents sont formidables.',emoji:'üë®‚Äçüë©‚Äçüëß'},
      {word:'Grand-m√®re',translation:'Grandmother',example:'Ma grand-m√®re fait de bons g√¢teaux.',emoji:'üëµ'},
      {word:'Grand-p√®re',translation:'Grandfather',example:'Mon grand-p√®re raconte des histoires.',emoji:'üë¥'},
      {word:'Le b√©b√©',translation:'Baby',example:'Le b√©b√© dort paisiblement.',emoji:'üë∂'},
    ]},
    { topic:'School üè´', words:[
      {word:'Le livre',translation:'Book',example:"J'ai oubli√© mon livre √† la maison.",emoji:'üìö'},
      {word:'Le cahier',translation:'Notebook',example:"J'√©cris dans mon cahier.",emoji:'üìì'},
      {word:'Le stylo',translation:'Pen',example:"Passe-moi le stylo, s'il te pla√Æt.",emoji:'üñäÔ∏è'},
      {word:'Le crayon',translation:'Pencil',example:'Je dessine avec un crayon.',emoji:'‚úèÔ∏è'},
      {word:'La classe',translation:'Classroom',example:'La classe est grande.',emoji:'üè´'},
      {word:'Le professeur',translation:'Teacher',example:'Le professeur explique bien.',emoji:'üë©‚Äçüè´'},
      {word:"L'√©l√®ve",translation:'Student',example:"L'√©l√®ve l√®ve la main.",emoji:'üôã'},
      {word:'Le devoir',translation:'Homework',example:'Je fais mes devoirs.',emoji:'üìù'},
    ]},
    { topic:'Weather ‚õÖ', words:[
      {word:'Il fait chaud',translation:"It's hot",example:"Il fait chaud en √©t√©.",emoji:'‚òÄÔ∏è'},
      {word:'Il fait froid',translation:"It's cold",example:'Il fait froid en hiver.',emoji:'ü•∂'},
      {word:'Il pleut',translation:"It's raining",example:'Il pleut beaucoup en avril.',emoji:'üåßÔ∏è'},
      {word:'Il neige',translation:"It's snowing",example:'Il neige en d√©cembre.',emoji:'‚ùÑÔ∏è'},
      {word:'Le soleil',translation:'Sun',example:"Le soleil brille aujourd'hui.",emoji:'‚òÄÔ∏è'},
      {word:'Le nuage',translation:'Cloud',example:'Il y a des nuages dans le ciel.',emoji:'‚òÅÔ∏è'},
      {word:'Le vent',translation:'Wind',example:'Le vent est fort.',emoji:'üí®'},
      {word:"L'orage",translation:'Storm',example:'Il y a un orage ce soir.',emoji:'‚õàÔ∏è'},
    ]},
    { topic:'Body üßç', words:[
      {word:'La t√™te',translation:'Head',example:"J'ai mal √† la t√™te.",emoji:'ü§ï'},
      {word:'Les yeux',translation:'Eyes',example:"J'ai les yeux bleus.",emoji:'üëÄ'},
      {word:'La bouche',translation:'Mouth',example:'Ferme la bouche!',emoji:'üëÑ'},
      {word:'Le nez',translation:'Nose',example:"J'ai un grand nez.",emoji:'üëÉ'},
      {word:'Les mains',translation:'Hands',example:'Lave tes mains!',emoji:'üôå'},
      {word:'Les pieds',translation:'Feet',example:'Mes pieds sont fatigu√©s.',emoji:'ü¶∂'},
      {word:'Le dos',translation:'Back',example:"J'ai mal au dos.",emoji:'ü¶¥'},
      {word:'Le ventre',translation:'Belly',example:"J'ai faim, j'ai mal au ventre.",emoji:'ü´É'},
    ]},
    { topic:'Sports ‚öΩ', words:[
      {word:'Le football',translation:'Soccer',example:'Je joue au football le samedi.',emoji:'‚öΩ'},
      {word:'La natation',translation:'Swimming',example:'La natation est bon pour la sant√©.',emoji:'üèä'},
      {word:'Le v√©lo',translation:'Bicycle',example:'Je fais du v√©lo le dimanche.',emoji:'üö¥'},
      {word:'La course',translation:'Running',example:"J'aime faire de la course √† pied.",emoji:'üèÉ'},
      {word:'Le basket',translation:'Basketball',example:'Mon √©quipe joue au basket.',emoji:'üèÄ'},
      {word:'Le tennis',translation:'Tennis',example:'Je prends des cours de tennis.',emoji:'üéæ'},
      {word:'La gym',translation:'Gym',example:'Je vais √† la gym trois fois par semaine.',emoji:'ü§∏'},
      {word:'Le ski',translation:'Skiing',example:'On fait du ski en montagne.',emoji:'‚õ∑Ô∏è'},
    ]},
    { topic:'House üè†', words:[
      {word:'La maison',translation:'House',example:'Ma maison est grande.',emoji:'üè†'},
      {word:'La chambre',translation:'Bedroom',example:'Ma chambre est bleue.',emoji:'üõèÔ∏è'},
      {word:'La cuisine',translation:'Kitchen',example:'Ma m√®re cuisine dans la cuisine.',emoji:'üç≥'},
      {word:'La salle de bain',translation:'Bathroom',example:'Je me douche dans la salle de bain.',emoji:'üöø'},
      {word:'Le salon',translation:'Living room',example:'On regarde la t√©l√© au salon.',emoji:'üõãÔ∏è'},
      {word:'Le jardin',translation:'Garden',example:'Le jardin est fleuri.',emoji:'üåª'},
      {word:'La porte',translation:'Door',example:'Ferme la porte!',emoji:'üö™'},
      {word:'La fen√™tre',translation:'Window',example:'Ouvre la fen√™tre, il fait chaud.',emoji:'ü™ü'},
    ]},
    { topic:'Clothing üëó', words:[
      {word:'Le t-shirt',translation:'T-shirt',example:'Je porte un t-shirt blanc.',emoji:'üëï'},
      {word:'Le pantalon',translation:'Trousers/Pants',example:'Mon pantalon est trop grand.',emoji:'üëñ'},
      {word:'La robe',translation:'Dress',example:'Elle porte une belle robe.',emoji:'üëó'},
      {word:'Les chaussures',translation:'Shoes',example:'Mes chaussures sont neuves.',emoji:'üëü'},
      {word:'Le manteau',translation:'Coat',example:'Il fait froid, mets ton manteau!',emoji:'üß•'},
      {word:'Le chapeau',translation:'Hat',example:'Il porte un chapeau rouge.',emoji:'üé©'},
      {word:'Le pull',translation:'Sweater/Jumper',example:'Je mets un pull en hiver.',emoji:'üß∂'},
      {word:'Les lunettes',translation:'Glasses',example:'J\'ai besoin de mes lunettes pour lire.',emoji:'üëì'},
    ]},
    { topic:'Transport üöó', words:[
      {word:'La voiture',translation:'Car',example:'Je vais au travail en voiture.',emoji:'üöó'},
      {word:'Le bus',translation:'Bus',example:'Je prends le bus chaque matin.',emoji:'üöå'},
      {word:'Le train',translation:'Train',example:'Le train part √† neuf heures.',emoji:'üöÜ'},
      {word:'Le v√©lo',translation:'Bicycle',example:'Je fais du v√©lo le week-end.',emoji:'üö≤'},
      {word:'L\'avion',translation:'Aeroplane',example:'Nous voyageons en avion.',emoji:'‚úàÔ∏è'},
      {word:'Le m√©tro',translation:'Subway/Metro',example:'Je prends le m√©tro √† Paris.',emoji:'üöá'},
      {word:'√Ä pied',translation:'On foot',example:'Je vais √† l\'√©cole √† pied.',emoji:'üö∂'},
      {word:'La gare',translation:'Train station',example:'La gare est en centre-ville.',emoji:'üèõÔ∏è'},
    ]},
    { topic:'Verbs üèÉ', words:[
      {word:'Manger',translation:'To eat',example:'Je mange une pomme.',emoji:'üçΩÔ∏è'},
      {word:'Boire',translation:'To drink',example:'Je bois de l\'eau.',emoji:'üíß'},
      {word:'Dormir',translation:'To sleep',example:'Je dors huit heures par nuit.',emoji:'üò¥'},
      {word:'Lire',translation:'To read',example:'J\'aime lire des livres.',emoji:'üìñ'},
      {word:'√âcrire',translation:'To write',example:'J\'√©cris une lettre.',emoji:'‚úçÔ∏è'},
      {word:'Parler',translation:'To speak',example:'Je parle fran√ßais.',emoji:'üí¨'},
      {word:'Jouer',translation:'To play',example:'Je joue au foot.',emoji:'‚öΩ'},
      {word:'Aller',translation:'To go',example:'Je vais √† l\'√©cole.',emoji:'üö∂'},
    ]},
    { topic:'Emotions üòä', words:[
      {word:'Heureux / Heureuse',translation:'Happy',example:'Je suis tr√®s heureux aujourd\'hui!',emoji:'üòä'},
      {word:'Triste',translation:'Sad',example:'Elle est triste parce qu\'il pleut.',emoji:'üò¢'},
      {word:'En col√®re',translation:'Angry',example:'Il est en col√®re contre moi.',emoji:'üò†'},
      {word:'Fatigu√©(e)',translation:'Tired',example:'Je suis fatigu√© apr√®s l\'√©cole.',emoji:'üò¥'},
      {word:'Effray√©(e)',translation:'Scared',example:'Elle est effray√©e par les araign√©es.',emoji:'üò±'},
      {word:'Surpris(e)',translation:'Surprised',example:'Je suis surpris par ce cadeau!',emoji:'üò≤'},
      {word:'Amoureux / Amoureuse',translation:'In love',example:'Il est amoureux de Marie.',emoji:'‚ù§Ô∏è'},
      {word:'Ennuy√©(e)',translation:'Bored',example:'Je suis ennuy√© sans activit√©.',emoji:'üòë'},
    ]},
    { topic:'Days & Months üìÖ', words:[
      {word:'Lundi',translation:'Monday',example:'Lundi, j\'ai cours de maths.',emoji:'üìÖ'},
      {word:'Vendredi',translation:'Friday',example:'Vendredi soir, je sors avec des amis.',emoji:'üéâ'},
      {word:'Samedi',translation:'Saturday',example:'Le samedi, je dors jusqu\'√† midi.',emoji:'üò¥'},
      {word:'Janvier',translation:'January',example:'Mon anniversaire est en janvier.',emoji:'‚ùÑÔ∏è'},
      {word:'Juillet',translation:'July',example:'En juillet, il fait tr√®s chaud.',emoji:'‚òÄÔ∏è'},
      {word:'D√©cembre',translation:'December',example:'No√´l est en d√©cembre.',emoji:'üéÑ'},
      {word:'Aujourd\'hui',translation:'Today',example:'Aujourd\'hui, il fait beau.',emoji:'üìÜ'},
      {word:'Demain',translation:'Tomorrow',example:'Demain, j\'ai un examen.',emoji:'‚è∞'},
    ]},
    { topic:'Town üèôÔ∏è', words:[
      {word:'La boulangerie',translation:'Bakery',example:'Je vais √† la boulangerie chaque matin.',emoji:'ü•ñ'},
      {word:'La pharmacie',translation:'Pharmacy',example:'La pharmacie est ouverte 24h.',emoji:'üíä'},
      {word:'La biblioth√®que',translation:'Library',example:'J\'emprunte des livres √† la biblioth√®que.',emoji:'üìö'},
      {word:'Le march√©',translation:'Market',example:'Le march√© est ouvert le samedi.',emoji:'üõí'},
      {word:'Le parc',translation:'Park',example:'Je prom√®ne mon chien au parc.',emoji:'üå≥'},
      {word:'L\'√©cole',translation:'School',example:'Mon √©cole est pr√®s de chez moi.',emoji:'üè´'},
      {word:'L\'h√¥pital',translation:'Hospital',example:'L\'h√¥pital est grand.',emoji:'üè•'},
      {word:'La poste',translation:'Post office',example:'J\'envoie une lettre √† la poste.',emoji:'üì¨'},
    ]},
    { topic:'Adjectives ‚ú®', words:[
      {word:'Grand(e)',translation:'Big/Tall',example:'La tour Eiffel est grande.',emoji:'‚¨ÜÔ∏è'},
      {word:'Petit(e)',translation:'Small/Short',example:'Mon chat est petit et mignon.',emoji:'‚¨áÔ∏è'},
      {word:'Beau / Belle',translation:'Beautiful',example:'C\'est une belle journ√©e!',emoji:'üòç'},
      {word:'Nouveau / Nouvelle',translation:'New',example:'J\'ai un nouveau t√©l√©phone.',emoji:'‚ú®'},
      {word:'Bon(ne)',translation:'Good',example:'Ce g√¢teau est tr√®s bon.',emoji:'üëç'},
      {word:'Mauvais(e)',translation:'Bad',example:'Le temps est mauvais aujourd\'hui.',emoji:'üëé'},
      {word:'Rapide',translation:'Fast',example:'Le train est tr√®s rapide.',emoji:'‚ö°'},
      {word:'Lent(e)',translation:'Slow',example:'La tortue est lente.',emoji:'üê¢'},
    ]},
    { topic:'Time ‚è∞', words:[
      {word:'Le matin',translation:'Morning',example:'Je me l√®ve le matin √† sept heures.',emoji:'üåÖ'},
      {word:"L'apr√®s-midi",translation:'Afternoon',example:"L'apr√®s-midi, je fais mes devoirs.",emoji:'üå§Ô∏è'},
      {word:'Le soir',translation:'Evening',example:'Le soir, je regarde la t√©l√©.',emoji:'üåô'},
      {word:'La nuit',translation:'Night',example:'La nuit, je dors profond√©ment.',emoji:'üåÉ'},
      {word:"Maintenant",translation:'Now',example:"Viens ici maintenant!",emoji:'‚è±Ô∏è'},
      {word:'Hier',translation:'Yesterday',example:"Hier, j'ai vu un film.",emoji:'‚è™'},
      {word:'T√¥t',translation:'Early',example:'Je me l√®ve t√¥t chaque matin.',emoji:'üåÑ'},
      {word:'Tard',translation:'Late',example:"Je suis rentr√© tard hier soir.",emoji:'ü¶â'},
    ]},
  ],
  es: [
    { topic:'Greetings üá™üá∏', words:[
      {word:'Hola',translation:'Hello',example:'¬°Hola, c√≥mo est√°s?',emoji:'üëã'},
      {word:'Buenos d√≠as',translation:'Good morning',example:'¬°Buenos d√≠as, se√±ora!',emoji:'üåÖ'},
      {word:'Buenas noches',translation:'Good night',example:'¬°Buenas noches, hasta ma√±ana!',emoji:'üåô'},
      {word:'Gracias',translation:'Thank you',example:'¬°Muchas gracias!',emoji:'üôè'},
      {word:'Por favor',translation:'Please',example:'Un vaso de agua, por favor.',emoji:'üíß'},
      {word:'De nada',translation:"You're welcome",example:'Gracias. ‚Äî ¬°De nada!',emoji:'üòä'},
      {word:'Mucho gusto',translation:'Nice to meet you',example:'Mucho gusto, me llamo Ana.',emoji:'ü§ù'},
      {word:'Adi√≥s',translation:'Goodbye',example:'¬°Adi√≥s, hasta luego!',emoji:'üëã'},
    ]},
    { topic:'Numbers üî¢', words:[
      {word:'Uno / Una',translation:'One',example:'Tengo un perro.',emoji:'1Ô∏è‚É£'},
      {word:'Dos',translation:'Two',example:'Dos tacos, por favor.',emoji:'2Ô∏è‚É£'},
      {word:'Cinco',translation:'Five',example:'Son las cinco de la tarde.',emoji:'5Ô∏è‚É£'},
      {word:'Diez',translation:'Ten',example:'Tengo diez a√±os.',emoji:'üîü'},
      {word:'Veinte',translation:'Twenty',example:'Veinte estudiantes en clase.',emoji:'‚úåÔ∏è'},
      {word:'Cien',translation:'One hundred',example:'Cien pesos.',emoji:'üíØ'},
      {word:'Mil',translation:'One thousand',example:'Mil gracias.',emoji:'üéä'},
      {word:'Primero / Primera',translation:'First',example:'El primer d√≠a de escuela.',emoji:'ü•á'},
    ]},
    { topic:'Colors üé®', words:[
      {word:'Rojo',translation:'Red',example:'Una manzana roja.',emoji:'üî¥'},
      {word:'Azul',translation:'Blue',example:'El cielo es azul.',emoji:'üîµ'},
      {word:'Verde',translation:'Green',example:'La hierba es verde.',emoji:'üü¢'},
      {word:'Amarillo',translation:'Yellow',example:'Un girasol amarillo.',emoji:'üü°'},
      {word:'Blanco',translation:'White',example:'La nieve es blanca.',emoji:'‚¨ú'},
      {word:'Negro',translation:'Black',example:'Un gato negro.',emoji:'‚¨õ'},
      {word:'Rosa',translation:'Pink',example:'Una flor rosa.',emoji:'üå∏'},
      {word:'Morado',translation:'Purple',example:'Un bol√≠grafo morado.',emoji:'üíú'},
    ]},
    { topic:'Food üåÆ', words:[
      {word:'El pan',translation:'Bread',example:'Me gusta el pan fresco.',emoji:'üçû'},
      {word:'El queso',translation:'Cheese',example:'El queso mexicano es delicioso.',emoji:'üßÄ'},
      {word:'La manzana',translation:'Apple',example:'Como una manzana cada d√≠a.',emoji:'üçé'},
      {word:'El pollo',translation:'Chicken',example:'El pollo asado est√° rico.',emoji:'üçó'},
      {word:'La sopa',translation:'Soup',example:'La sopa est√° caliente.',emoji:'üç≤'},
      {word:'El pastel',translation:'Cake',example:'Un pastel de chocolate.',emoji:'üéÇ'},
      {word:'El agua',translation:'Water',example:'Un vaso de agua, por favor.',emoji:'üíß'},
      {word:'La leche',translation:'Milk',example:'Bebo leche cada ma√±ana.',emoji:'ü•õ'},
    ]},
    { topic:'Animals üêæ', words:[
      {word:'El perro',translation:'Dog',example:'Mi perro se llama Max.',emoji:'üêï'},
      {word:'El gato',translation:'Cat',example:'El gato duerme en el sof√°.',emoji:'üêà'},
      {word:'El p√°jaro',translation:'Bird',example:'Un p√°jaro canta en el √°rbol.',emoji:'üê¶'},
      {word:'El conejo',translation:'Rabbit',example:'Un conejo blanco y suave.',emoji:'üêá'},
      {word:'El caballo',translation:'Horse',example:'El caballo corre r√°pido.',emoji:'üê¥'},
      {word:'El le√≥n',translation:'Lion',example:'El le√≥n es el rey de los animales.',emoji:'ü¶Å'},
      {word:'El elefante',translation:'Elephant',example:'El elefante tiene una trompa larga.',emoji:'üêò'},
      {word:'El pez',translation:'Fish',example:'Un pez rojo en una pecera.',emoji:'üêü'},
    ]},
    { topic:'Family üë®‚Äçüë©‚Äçüëß', words:[
      {word:'La madre',translation:'Mother',example:'Mi madre es muy amable.',emoji:'üë©'},
      {word:'El padre',translation:'Father',example:'Mi padre trabaja mucho.',emoji:'üë®'},
      {word:'El hermano',translation:'Brother',example:'Mi hermano ama el f√∫tbol.',emoji:'üë¶'},
      {word:'La hermana',translation:'Sister',example:'Mi hermana lee un libro.',emoji:'üëß'},
      {word:'Los padres',translation:'Parents',example:'Mis padres son incre√≠bles.',emoji:'üë®‚Äçüë©‚Äçüëß'},
      {word:'La abuela',translation:'Grandmother',example:'Mi abuela hace buenos pasteles.',emoji:'üëµ'},
      {word:'El abuelo',translation:'Grandfather',example:'Mi abuelo cuenta historias.',emoji:'üë¥'},
      {word:'El beb√©',translation:'Baby',example:'El beb√© duerme tranquilamente.',emoji:'üë∂'},
    ]},
    { topic:'School üè´', words:[
      {word:'El libro',translation:'Book',example:'Olvid√© mi libro en casa.',emoji:'üìö'},
      {word:'El cuaderno',translation:'Notebook',example:'Escribo en mi cuaderno.',emoji:'üìì'},
      {word:'El bol√≠grafo',translation:'Pen',example:'P√°same el bol√≠grafo, por favor.',emoji:'üñäÔ∏è'},
      {word:'El l√°piz',translation:'Pencil',example:'Dibujo con un l√°piz.',emoji:'‚úèÔ∏è'},
      {word:'La clase',translation:'Classroom',example:'La clase es grande.',emoji:'üè´'},
      {word:'El profesor',translation:'Teacher',example:'El profesor explica bien.',emoji:'üë®‚Äçüè´'},
      {word:'El estudiante',translation:'Student',example:'El estudiante levanta la mano.',emoji:'üôã'},
      {word:'La tarea',translation:'Homework',example:'Hago mi tarea por la tarde.',emoji:'üìù'},
    ]},
    { topic:'Weather ‚õÖ', words:[
      {word:'Hace calor',translation:"It's hot",example:'Hace mucho calor en verano.',emoji:'‚òÄÔ∏è'},
      {word:'Hace fr√≠o',translation:"It's cold",example:'Hace fr√≠o en invierno.',emoji:'ü•∂'},
      {word:'Est√° lloviendo',translation:"It's raining",example:'Est√° lloviendo mucho hoy.',emoji:'üåßÔ∏è'},
      {word:'Est√° nevando',translation:"It's snowing",example:'Est√° nevando en las monta√±as.',emoji:'‚ùÑÔ∏è'},
      {word:'El sol',translation:'Sun',example:'El sol brilla hoy.',emoji:'‚òÄÔ∏è'},
      {word:'La nube',translation:'Cloud',example:'Hay muchas nubes en el cielo.',emoji:'‚òÅÔ∏è'},
      {word:'El viento',translation:'Wind',example:'El viento es muy fuerte.',emoji:'üí®'},
      {word:'La tormenta',translation:'Storm',example:'Hay una tormenta esta noche.',emoji:'‚õàÔ∏è'},
    ]},
    { topic:'Body üßç', words:[
      {word:'La cabeza',translation:'Head',example:'Me duele la cabeza.',emoji:'ü§ï'},
      {word:'Los ojos',translation:'Eyes',example:'Tengo los ojos marrones.',emoji:'üëÄ'},
      {word:'La boca',translation:'Mouth',example:'¬°Cierra la boca!',emoji:'üëÑ'},
      {word:'La nariz',translation:'Nose',example:'Tengo la nariz grande.',emoji:'üëÉ'},
      {word:'Las manos',translation:'Hands',example:'¬°L√°vate las manos!',emoji:'üôå'},
      {word:'Los pies',translation:'Feet',example:'Me duelen los pies.',emoji:'ü¶∂'},
      {word:'La espalda',translation:'Back',example:'Me duele la espalda.',emoji:'ü¶¥'},
      {word:'El est√≥mago',translation:'Stomach',example:'Tengo hambre, me duele el est√≥mago.',emoji:'ü´É'},
    ]},
    { topic:'Sports ‚öΩ', words:[
      {word:'El f√∫tbol',translation:'Soccer',example:'Juego al f√∫tbol los s√°bados.',emoji:'‚öΩ'},
      {word:'La nataci√≥n',translation:'Swimming',example:'La nataci√≥n es buena para la salud.',emoji:'üèä'},
      {word:'La bicicleta',translation:'Bicycle',example:'Monto en bicicleta los domingos.',emoji:'üö¥'},
      {word:'Correr',translation:'Running',example:'Me gusta correr por el parque.',emoji:'üèÉ'},
      {word:'El baloncesto',translation:'Basketball',example:'Mi equipo juega al baloncesto.',emoji:'üèÄ'},
      {word:'El tenis',translation:'Tennis',example:'Tomo clases de tenis.',emoji:'üéæ'},
      {word:'El gimnasio',translation:'Gym',example:'Voy al gimnasio tres veces por semana.',emoji:'ü§∏'},
      {word:'El esqu√≠',translation:'Skiing',example:'Hacemos esqu√≠ en las monta√±as.',emoji:'‚õ∑Ô∏è'},
    ]},
    { topic:'House üè†', words:[
      {word:'La casa',translation:'House',example:'Mi casa es grande.',emoji:'üè†'},
      {word:'La habitaci√≥n',translation:'Bedroom',example:'Mi habitaci√≥n es azul.',emoji:'üõèÔ∏è'},
      {word:'La cocina',translation:'Kitchen',example:'Mi mam√° cocina en la cocina.',emoji:'üç≥'},
      {word:'El ba√±o',translation:'Bathroom',example:'Me ducho en el ba√±o.',emoji:'üöø'},
      {word:'La sala',translation:'Living room',example:'Vemos la tele en la sala.',emoji:'üõãÔ∏è'},
      {word:'El jard√≠n',translation:'Garden',example:'El jard√≠n tiene flores.',emoji:'üåª'},
      {word:'La puerta',translation:'Door',example:'¬°Cierra la puerta!',emoji:'üö™'},
      {word:'La ventana',translation:'Window',example:'Abre la ventana, hace calor.',emoji:'ü™ü'},
    ]},
    { topic:'Clothing üëó', words:[
      {word:'La camiseta',translation:'T-shirt',example:'Llevo una camiseta blanca.',emoji:'üëï'},
      {word:'El pantal√≥n',translation:'Trousers/Pants',example:'Mi pantal√≥n es demasiado grande.',emoji:'üëñ'},
      {word:'El vestido',translation:'Dress',example:'Ella lleva un vestido bonito.',emoji:'üëó'},
      {word:'Los zapatos',translation:'Shoes',example:'Mis zapatos son nuevos.',emoji:'üëü'},
      {word:'El abrigo',translation:'Coat',example:'¬°Hace fr√≠o, ponte el abrigo!',emoji:'üß•'},
      {word:'El sombrero',translation:'Hat',example:'Lleva un sombrero rojo.',emoji:'üé©'},
      {word:'El su√©ter',translation:'Sweater',example:'Me pongo un su√©ter en invierno.',emoji:'üß∂'},
      {word:'Las gafas',translation:'Glasses',example:'Necesito mis gafas para leer.',emoji:'üëì'},
    ]},
    { topic:'Transport üöó', words:[
      {word:'El coche',translation:'Car',example:'Voy al trabajo en coche.',emoji:'üöó'},
      {word:'El autob√∫s',translation:'Bus',example:'Tomo el autob√∫s cada ma√±ana.',emoji:'üöå'},
      {word:'El tren',translation:'Train',example:'El tren sale a las nueve.',emoji:'üöÜ'},
      {word:'La bicicleta',translation:'Bicycle',example:'Monto en bicicleta el fin de semana.',emoji:'üö≤'},
      {word:'El avi√≥n',translation:'Aeroplane',example:'Viajamos en avi√≥n.',emoji:'‚úàÔ∏è'},
      {word:'El metro',translation:'Subway/Metro',example:'Tomo el metro en Madrid.',emoji:'üöá'},
      {word:'A pie',translation:'On foot',example:'Voy al colegio a pie.',emoji:'üö∂'},
      {word:'La estaci√≥n',translation:'Station',example:'La estaci√≥n est√° en el centro.',emoji:'üèõÔ∏è'},
    ]},
    { topic:'Verbs üèÉ', words:[
      {word:'Comer',translation:'To eat',example:'Como una manzana.',emoji:'üçΩÔ∏è'},
      {word:'Beber',translation:'To drink',example:'Bebo agua.',emoji:'üíß'},
      {word:'Dormir',translation:'To sleep',example:'Duermo ocho horas por noche.',emoji:'üò¥'},
      {word:'Leer',translation:'To read',example:'Me gusta leer libros.',emoji:'üìñ'},
      {word:'Escribir',translation:'To write',example:'Escribo una carta.',emoji:'‚úçÔ∏è'},
      {word:'Hablar',translation:'To speak',example:'Hablo espa√±ol.',emoji:'üí¨'},
      {word:'Jugar',translation:'To play',example:'Juego al f√∫tbol.',emoji:'‚öΩ'},
      {word:'Ir',translation:'To go',example:'Voy al colegio.',emoji:'üö∂'},
    ]},
    { topic:'Emotions üòä', words:[
      {word:'Feliz',translation:'Happy',example:'¬°Estoy muy feliz hoy!',emoji:'üòä'},
      {word:'Triste',translation:'Sad',example:'Ella est√° triste porque llueve.',emoji:'üò¢'},
      {word:'Enojado/a',translation:'Angry',example:'√âl est√° enojado conmigo.',emoji:'üò†'},
      {word:'Cansado/a',translation:'Tired',example:'Estoy cansado despu√©s del colegio.',emoji:'üò¥'},
      {word:'Asustado/a',translation:'Scared',example:'Ella est√° asustada de las ara√±as.',emoji:'üò±'},
      {word:'Sorprendido/a',translation:'Surprised',example:'¬°Estoy sorprendido por este regalo!',emoji:'üò≤'},
      {word:'Enamorado/a',translation:'In love',example:'√âl est√° enamorado de Mar√≠a.',emoji:'‚ù§Ô∏è'},
      {word:'Aburrido/a',translation:'Bored',example:'Estoy aburrido sin actividades.',emoji:'üòë'},
    ]},
    { topic:'Days & Months üìÖ', words:[
      {word:'Lunes',translation:'Monday',example:'El lunes tengo clase de matem√°ticas.',emoji:'üìÖ'},
      {word:'Viernes',translation:'Friday',example:'El viernes salgo con amigos.',emoji:'üéâ'},
      {word:'S√°bado',translation:'Saturday',example:'El s√°bado duermo hasta tarde.',emoji:'üò¥'},
      {word:'Enero',translation:'January',example:'Mi cumplea√±os es en enero.',emoji:'‚ùÑÔ∏è'},
      {word:'Julio',translation:'July',example:'En julio hace mucho calor.',emoji:'‚òÄÔ∏è'},
      {word:'Diciembre',translation:'December',example:'La Navidad es en diciembre.',emoji:'üéÑ'},
      {word:'Hoy',translation:'Today',example:'Hoy hace buen tiempo.',emoji:'üìÜ'},
      {word:'Ma√±ana',translation:'Tomorrow',example:'Ma√±ana tengo un examen.',emoji:'‚è∞'},
    ]},
    { topic:'Town üèôÔ∏è', words:[
      {word:'La panader√≠a',translation:'Bakery',example:'Voy a la panader√≠a cada ma√±ana.',emoji:'ü•ñ'},
      {word:'La farmacia',translation:'Pharmacy',example:'La farmacia est√° abierta las 24h.',emoji:'üíä'},
      {word:'La biblioteca',translation:'Library',example:'Saco libros de la biblioteca.',emoji:'üìö'},
      {word:'El mercado',translation:'Market',example:'El mercado abre los s√°bados.',emoji:'üõí'},
      {word:'El parque',translation:'Park',example:'Paseo a mi perro en el parque.',emoji:'üå≥'},
      {word:'El colegio',translation:'School',example:'Mi colegio est√° cerca de casa.',emoji:'üè´'},
      {word:'El hospital',translation:'Hospital',example:'El hospital es muy grande.',emoji:'üè•'},
      {word:'Correos',translation:'Post office',example:'Env√≠o una carta en correos.',emoji:'üì¨'},
    ]},
    { topic:'Adjectives ‚ú®', words:[
      {word:'Grande',translation:'Big/Tall',example:'La Torre Eiffel es grande.',emoji:'‚¨ÜÔ∏è'},
      {word:'Peque√±o/a',translation:'Small/Short',example:'Mi gato es peque√±o y lindo.',emoji:'‚¨áÔ∏è'},
      {word:'Hermoso/a',translation:'Beautiful',example:'¬°Es un d√≠a hermoso!',emoji:'üòç'},
      {word:'Nuevo/a',translation:'New',example:'Tengo un tel√©fono nuevo.',emoji:'‚ú®'},
      {word:'Bueno/a',translation:'Good',example:'Este pastel est√° muy bueno.',emoji:'üëç'},
      {word:'Malo/a',translation:'Bad',example:'El tiempo est√° malo hoy.',emoji:'üëé'},
      {word:'R√°pido/a',translation:'Fast',example:'El tren es muy r√°pido.',emoji:'‚ö°'},
      {word:'Lento/a',translation:'Slow',example:'La tortuga es lenta.',emoji:'üê¢'},
    ]},
    { topic:'Time ‚è∞', words:[
      {word:'La ma√±ana',translation:'Morning',example:'Me levanto por la ma√±ana a las siete.',emoji:'üåÖ'},
      {word:'La tarde',translation:'Afternoon',example:'Por la tarde hago mis tareas.',emoji:'üå§Ô∏è'},
      {word:'La noche',translation:'Evening/Night',example:'Por la noche veo la tele.',emoji:'üåô'},
      {word:'Ahora',translation:'Now',example:'¬°Ven aqu√≠ ahora!',emoji:'‚è±Ô∏è'},
      {word:'Ayer',translation:'Yesterday',example:'Ayer vi una pel√≠cula.',emoji:'‚è™'},
      {word:'Temprano',translation:'Early',example:'Me levanto temprano cada ma√±ana.',emoji:'üåÑ'},
      {word:'Tarde',translation:'Late',example:'Llegu√© tarde ayer por la noche.',emoji:'ü¶â'},
      {word:'Siempre',translation:'Always',example:'Siempre como fruta.',emoji:'üîÑ'},
    ]},
  ]
};

// ‚îÄ‚îÄ HARDCODED QUIZ BANKS (no API needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const QUIZ_BANK = {
  fr: [
    {q:"What does 'Bonjour' mean?",opts:['Goodbye','Hello','Thank you','Please'],ans:1},
    {q:"How do you say 'cat' in French?",opts:['Chien','Oiseau','Chat','Cheval'],ans:2},
    {q:"What is 'rouge' in English?",opts:['Blue','Green','Yellow','Red'],ans:3},
    {q:"How do you say 'bread' in French?",opts:['Lait','Pain','Fromage','Eau'],ans:1},
    {q:"Which word means 'mother' in French?",opts:['Soeur','P√®re','M√®re','Fr√®re'],ans:2},
    {q:"'Merci' means‚Ä¶",opts:['Sorry','Please','Thank you','Hello'],ans:2},
    {q:"How do you say 'dog' in French?",opts:['Chat','Cheval','Lapin','Chien'],ans:3},
    {q:"What does 'bleu' mean?",opts:['Green','Red','Blue','White'],ans:2},
    {q:"'Au revoir' means‚Ä¶",opts:['Good morning','Goodbye','See you soon','Good night'],ans:1},
    {q:"How do you say 'water' in French?",opts:['Lait','Pain','Jus','Eau'],ans:3},
    {q:"What is 'vert' in English?",opts:['Yellow','Blue','Green','Purple'],ans:2},
    {q:"How do you say 'ten' in French?",opts:['Deux','Cinq','Huit','Dix'],ans:3},
    {q:"What does 'fr√®re' mean?",opts:['Sister','Father','Brother','Son'],ans:2},
    {q:"How do you say 'milk' in French?",opts:['Eau','Pain','Lait','Fromage'],ans:2},
    {q:"'Bonsoir' is used to say‚Ä¶",opts:['Good morning','Good afternoon','Good evening','Goodbye'],ans:2},
    {q:"What does 'jaune' mean?",opts:['Yellow','Blue','Pink','Orange'],ans:0},
    {q:"How do you say 'horse' in French?",opts:['Chien','Lion','Cheval','Chat'],ans:2},
    {q:"What is 'vingt' in English?",opts:['Ten','Fifteen','Twenty','Thirty'],ans:2},
    {q:"'Enchant√©' means‚Ä¶",opts:['Excuse me','Nice to meet you','Thank you','Goodbye'],ans:1},
    {q:"What does 'le livre' mean?",opts:['The pen','The notebook','The book','The desk'],ans:2},
    {q:"How do you say 'it is hot' in French?",opts:['Il fait froid','Il pleut','Il neige','Il fait chaud'],ans:3},
    {q:"What does 'la t√™te' mean?",opts:['Hand','Foot','Head','Back'],ans:2},
    {q:"How do you say 'soccer' in French?",opts:['Le basket','Le v√©lo','Le tennis','Le football'],ans:3},
    {q:"What is 'la maison' in English?",opts:['School','Garden','Kitchen','House'],ans:3},
    {q:"'Il pleut' means‚Ä¶",opts:["It's snowing","It's windy","It's raining","It's sunny"],ans:2},
    {q:"How do you say 'teacher' in French?",opts:["L'√©l√®ve",'Le stylo','Le professeur','Le cahier'],ans:2},
    {q:"What does 'les yeux' mean?",opts:['Ears','Eyes','Hands','Feet'],ans:1},
    {q:"How do you say 'bedroom' in French?",opts:['La cuisine','Le salon','La chambre','La salle de bain'],ans:2},
    {q:"What does 'il neige' mean?",opts:["It's raining","It's hot","It's windy","It's snowing"],ans:3},
    {q:"How do you say 'homework' in French?",opts:['Le livre','Le crayon','Le stylo','Le devoir'],ans:3},
    {q:"How do you say 'car' in French?",opts:['Le bus','Le train','La voiture','Le v√©lo'],ans:2},
    {q:"What does 'les chaussures' mean?",opts:['Glasses','Hat','Coat','Shoes'],ans:3},
    {q:"How do you say 'to eat' in French?",opts:['Boire','Dormir','Lire','Manger'],ans:3},
    {q:"What does 'heureux' mean?",opts:['Tired','Sad','Happy','Angry'],ans:2},
    {q:"How do you say 'Monday' in French?",opts:['Vendredi','Mercredi','Samedi','Lundi'],ans:3},
    {q:"What is 'la boulangerie' in English?",opts:['Library','Pharmacy','Bakery','Market'],ans:2},
    {q:"How do you say 'big' in French?",opts:['Petit','Rapide','Bon','Grand'],ans:3},
    {q:"What does 'demain' mean?",opts:['Yesterday','Now','Today','Tomorrow'],ans:3},
    {q:"How do you say 'dress' in French?",opts:['Le pull','Le chapeau','La robe','Le pantalon'],ans:2},
    {q:"What is 'triste' in English?",opts:['Happy','Angry','Surprised','Sad'],ans:3},
    {q:"How do you say 'to read' in French?",opts:['√âcrire','Parler','Manger','Lire'],ans:3},
    {q:"What does 'le soir' mean?",opts:['Morning','Afternoon','Night','Evening'],ans:3},
    {q:"How do you say 'today' in French?",opts:['Hier','Demain','Maintenant','Aujourd\'hui'],ans:3},
    {q:"What is 'rapide' in English?",opts:['Slow','Small','Beautiful','Fast'],ans:0},
    {q:"How do you say 'subway' in French?",opts:['Le train','La voiture','Le bus','Le m√©tro'],ans:3},
  ],
  es: [
    {q:"What does '¬°Hola!' mean?",opts:['Goodbye','Good night','Hello','Thank you'],ans:2},
    {q:"How do you say 'cat' in Spanish?",opts:['Perro','P√°jaro','Gato','Caballo'],ans:2},
    {q:"What is 'rojo' in English?",opts:['Blue','Green','Red','Yellow'],ans:2},
    {q:"How do you say 'bread' in Spanish?",opts:['Leche','Pan','Queso','Agua'],ans:1},
    {q:"Which word means 'mother' in Spanish?",opts:['Hermana','Padre','Madre','Hermano'],ans:2},
    {q:"'Gracias' means‚Ä¶",opts:['Sorry','Please','Hello','Thank you'],ans:3},
    {q:"How do you say 'dog' in Spanish?",opts:['Gato','Caballo','Conejo','Perro'],ans:3},
    {q:"What does 'azul' mean?",opts:['Green','Red','Yellow','Blue'],ans:3},
    {q:"'Adi√≥s' means‚Ä¶",opts:['Good morning','Hello','Goodbye','Please'],ans:2},
    {q:"How do you say 'water' in Spanish?",opts:['Leche','Pan','Jugo','Agua'],ans:3},
    {q:"What is 'verde' in English?",opts:['Yellow','Green','Blue','Purple'],ans:1},
    {q:"How do you say 'ten' in Spanish?",opts:['Dos','Cinco','Ocho','Diez'],ans:3},
    {q:"What does 'hermano' mean?",opts:['Sister','Father','Son','Brother'],ans:3},
    {q:"How do you say 'milk' in Spanish?",opts:['Agua','Pan','Leche','Queso'],ans:2},
    {q:"'Buenos d√≠as' is used to say‚Ä¶",opts:['Good evening','Good night','Goodbye','Good morning'],ans:3},
    {q:"What does 'amarillo' mean?",opts:['Blue','Pink','Yellow','Orange'],ans:2},
    {q:"How do you say 'horse' in Spanish?",opts:['Perro','Le√≥n','Gato','Caballo'],ans:3},
    {q:"What is 'veinte' in English?",opts:['Ten','Fifteen','Thirty','Twenty'],ans:3},
    {q:"'Mucho gusto' means‚Ä¶",opts:['Excuse me','Thank you','Nice to meet you','Goodbye'],ans:2},
    {q:"What does 'el libro' mean?",opts:['The pen','The book','The notebook','The desk'],ans:1},
    {q:"How do you say 'it is hot' in Spanish?",opts:['Hace fr√≠o','Est√° lloviendo','Est√° nevando','Hace calor'],ans:3},
    {q:"What does 'la cabeza' mean?",opts:['Hand','Foot','Back','Head'],ans:3},
    {q:"How do you say 'soccer' in Spanish?",opts:['El baloncesto','La bicicleta','El tenis','El f√∫tbol'],ans:3},
    {q:"What is 'la casa' in English?",opts:['School','Garden','Kitchen','House'],ans:3},
    {q:"'Est√° lloviendo' means‚Ä¶",opts:["It's snowing","It's windy","It's sunny","It's raining"],ans:3},
    {q:"How do you say 'teacher' in Spanish?",opts:['El estudiante','El l√°piz','La tarea','El profesor'],ans:3},
    {q:"What does 'los ojos' mean?",opts:['Ears','Hands','Eyes','Feet'],ans:2},
    {q:"How do you say 'bedroom' in Spanish?",opts:['La cocina','La sala','El ba√±o','La habitaci√≥n'],ans:3},
    {q:"What does 'est√° nevando' mean?",opts:["It's raining","It's hot","It's windy","It's snowing"],ans:3},
    {q:"How do you say 'homework' in Spanish?",opts:['El libro','El l√°piz','El bol√≠grafo','La tarea'],ans:3},,
    {q:"How do you say 'car' in Spanish?",opts:['El autob√∫s','El tren','El coche','La bicicleta'],ans:2},
    {q:"What does 'los zapatos' mean?",opts:['Glasses','Hat','Coat','Shoes'],ans:3},
    {q:"How do you say 'to eat' in Spanish?",opts:['Beber','Dormir','Leer','Comer'],ans:3},
    {q:"What does 'feliz' mean?",opts:['Tired','Sad','Angry','Happy'],ans:3},
    {q:"How do you say 'Monday' in Spanish?",opts:['Viernes','Mi√©rcoles','S√°bado','Lunes'],ans:3},
    {q:"What is 'la panader√≠a' in English?",opts:['Library','Pharmacy','Market','Bakery'],ans:3},
    {q:"How do you say 'big' in Spanish?",opts:['Peque√±o','R√°pido','Bueno','Grande'],ans:3},
    {q:"What does 'ma√±ana' mean?",opts:['Yesterday','Now','Today','Tomorrow'],ans:3},
    {q:"How do you say 'dress' in Spanish?",opts:['El su√©ter','El sombrero','El pantal√≥n','El vestido'],ans:3},
    {q:"What is 'triste' in English?",opts:['Happy','Angry','Surprised','Sad'],ans:3},
    {q:"How do you say 'to read' in Spanish?",opts:['Escribir','Hablar','Comer','Leer'],ans:3},
    {q:"What does 'la noche' mean?",opts:['Morning','Afternoon','Evening/Night','Today'],ans:2},
    {q:"How do you say 'today' in Spanish?",opts:['Ayer','Ma√±ana','Ahora','Hoy'],ans:3},
    {q:"What is 'r√°pido' in English?",opts:['Slow','Small','Beautiful','Fast'],ans:3},
    {q:"How do you say 'subway' in Spanish?",opts:['El tren','El coche','El autob√∫s','El metro'],ans:3},
  ]
};

function loadVocab(lang){
  const list=document.getElementById(lang+'VocabList');
  if(!list)return;
  const bank=VOCAB_BANK[lang];
  const set=bank[Math.floor(Math.random()*bank.length)];
  const color=lang==='fr'?'fr':'es';
  list.innerHTML='<div class="sec-lbl" style="margin-bottom:8px;">'+set.topic+'</div>'
    +set.words.map(w=>'<div class="vocab-card '+(lang==='es'?'es':'')+'"><div style="font-size:26px">'+w.emoji+'</div><div style="flex:1"><div class="vocab-word" style="color:var(--'+color+'-dark)">'+w.word+'</div><div class="vocab-trans">'+w.translation+'</div><div style="font-size:11px;color:var(--text-mid);margin-top:2px;font-style:italic">'+w.example+'</div></div></div>').join('')
    +'<div style="text-align:center;margin-top:10px;font-size:11px;color:var(--text-mid);font-weight:700">Studied this set? Tap the Quests tab to log it! ‚öîÔ∏è</div>';
  if(lang==='fr')S.frenchXP+=30;else S.spanishXP+=30;
  S.gems+=1;saveState();checkLevelUp();spawnXP('+30 XP üìö',lang==='fr'?'#d4703a':'#3a80c4');
}

function loadLangQuiz(lang){
  const cfg=LANG_CONFIG[lang];
  const box=document.getElementById(lang+'QuizContent');
  if(!box)return;
  // Pick 5 random questions from the bank
  const pool=shuffle([...QUIZ_BANK[lang]]);
  const questions=pool.slice(0,5);
  renderLangQuiz(lang,questions,cfg);
}

function renderLangQuiz(lang,questions,cfg){
  const box=document.getElementById(lang+'QuizContent');
  if(!box)return;
  let score=0,answered=0;
  box.innerHTML='';
  questions.forEach((q,qi)=>{
    const card=document.createElement('div');
    card.style.cssText='background:#fff;border-radius:16px;border:2px solid var(--'+lang+'-border);padding:14px;margin-bottom:12px;';
    const optsHtml=q.opts.map((o,oi)=>'<button onclick="checkLangQuizAnswer(this,'+oi+','+q.ans+',\''+lang+'\',\'card_'+qi+'\')" '
      +'style="display:block;width:100%;padding:9px 12px;text-align:left;background:#fff;border:2px solid var(--'+lang+'-border);border-radius:10px;'
      +'font-family:Nunito,sans-serif;font-size:12px;font-weight:700;color:var(--text-dark);cursor:pointer;margin-bottom:6px;transition:all .15s;">'
      +String.fromCharCode(65+oi)+'. '+o+'</button>').join('');
    card.id='card_'+qi;
    card.innerHTML='<div style="font-size:13px;font-weight:800;color:var(--'+lang+'-dark);margin-bottom:10px;">Q'+(qi+1)+'. '+q.q+'</div>'
      +optsHtml
      +'<div id="qfb_'+qi+'" style="display:none;margin-top:8px;font-size:12px;font-weight:700;padding:8px;border-radius:10px;"></div>';
    box.appendChild(card);
  });
  // Score tracker div
  const scoreDiv=document.createElement('div');
  scoreDiv.id=lang+'QuizScore';
  scoreDiv.style.cssText='display:none;text-align:center;padding:16px;background:var(--'+lang+'-light);border-radius:16px;border:2px solid var(--'+lang+'-border);margin-top:8px;';
  box.appendChild(scoreDiv);
}

function checkLangQuizAnswer(btn,chosen,correct,lang,cardId){
  const card=document.getElementById(cardId);
  if(!card||card.dataset.answered)return;
  card.dataset.answered='1';
  const cfg=LANG_CONFIG[lang];
  const qi=parseInt(cardId.split('_')[1]);
  const isRight=chosen===correct;
  // Color buttons
  card.querySelectorAll('button').forEach((b,i)=>{
    b.disabled=true;
    if(i===correct){b.style.background='#d8f8e8';b.style.borderColor='#7adda8';b.style.color='#1a6a3a';}
    else if(i===chosen&&!isRight){b.style.background='#fde8f0';b.style.borderColor='#f0a8c8';b.style.color='#c04060';}
    else{b.style.opacity='.4';}
  });
  // Track score in window obj
  if(!window._langQuizTrack)window._langQuizTrack={};
  if(!window._langQuizTrack[lang])window._langQuizTrack[lang]={score:0,total:0};
  window._langQuizTrack[lang].total++;
  if(isRight)window._langQuizTrack[lang].score++;
  // XP
  const xpGain=isRight?80:20;
  if(lang==='fr')S.frenchXP+=xpGain;else S.spanishXP+=xpGain;
  S.gems+=isRight?3:0;saveState();checkLevelUp();
  spawnXP((isRight?'‚úÖ ':'')+'+'+ xpGain+' XP',isRight?'#22c55e':'#9060c0');
  // Check if all questions answered
  const track=window._langQuizTrack[lang];
  const allCards=document.getElementById(lang+'QuizContent').querySelectorAll('[id^="card_"]');
  const allAnswered=Array.from(allCards).every(c=>c.dataset.answered);
  if(allAnswered){
    const pct=Math.round(track.score/track.total*100);
    const scoreDiv=document.getElementById(lang+'QuizScore');
    if(scoreDiv){
      scoreDiv.style.display='block';
      scoreDiv.innerHTML='<div style="font-family:Fredoka,sans-serif;font-size:24px;font-weight:700;color:var(--'+lang+'-dark)">'
        +(pct>=80?'üåü':'‚≠ê')+' '+pct+'%</div>'
        +'<div style="font-size:13px;font-weight:800;color:var(--text-mid);margin-top:4px">'
        +track.score+'/'+track.total+' correct ‚Äî '+(pct>=80?'Excellent!':pct>=60?'Good job!':'Keep practicing!')+'</div>';
    }
    // Auto-complete quiz quest if 80%+
    if(pct>=80){
      const qid=lang+'quiz-pass';
      // note: data-mqid is fr-quiz-pass or es-quiz-pass
      const realQid=lang+'-quiz-pass';
      const qEl=document.querySelector('[data-mqid="'+realQid+'"]');
      if(qEl&&!qEl.classList.contains('done'))qEl.click();
    }
    window._langQuizTrack[lang]={score:0,total:0};
  }
}

function completeLangMQ(el,color,xpAmt,gemAmt,lang){
  if(el.classList.contains('done'))return;
  const mqId=el.dataset.mqid;
  if(mqId&&S.completedMQs.includes(mqId))return;
  el.classList.add('done');
  if(mqId)S.completedMQs.push(mqId);
  if(lang==='fr')S.frenchXP+=xpAmt;else S.spanishXP+=xpAmt;
  S.gems+=(gemAmt||0);saveState();checkLevelUp();
  spawnXP('+'+xpAmt+' XP',color);
  if(gemAmt)setTimeout(()=>spawnXP('+'+gemAmt+' üíé','#a855f7'),500);
  renderMap();renderLangScreen(lang);
}


// ‚îÄ‚îÄ INTRO ONBOARDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _introSlide = 0;
const INTRO_TOTAL = 5;

function showIntroIfNeeded(){
  if(!localStorage.getItem('stIntroSeen')){
    const el = document.getElementById('introOverlay');
    if(el){ el.style.display='block'; _introSlide=0; updateIntroSlide(); }
  }
}

function introNav(dir){
  const next = _introSlide + dir;
  if(next >= INTRO_TOTAL){ dismissIntro(); return; }
  if(next < 0) return;
  const cur = document.getElementById('introSlide'+_introSlide);
  if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); setTimeout(()=>cur.classList.remove('exit'),400); }
  _introSlide = next;
  updateIntroSlide();
}

function updateIntroSlide(){
  // Show current slide
  for(let i=0;i<INTRO_TOTAL;i++){
    const s=document.getElementById('introSlide'+i);
    const d=document.getElementById('introDot'+i);
    if(s){ if(i===_introSlide){s.classList.add('active');}else{s.classList.remove('active');} }
    if(d){ if(i===_introSlide){d.classList.add('active');}else{d.classList.remove('active');} }
  }
  // Update buttons
  const prev=document.getElementById('introPrevBtn');
  const next=document.getElementById('introNextBtn');
  const skip=document.getElementById('introSkipBtn');
  if(prev) prev.style.display = _introSlide>0 ? 'block' : 'none';
  if(next) next.textContent = _introSlide===INTRO_TOTAL-1 ? "Let's Go! üöÄ" : 'Next ‚Üí';
  if(skip) skip.style.display = _introSlide===INTRO_TOTAL-1 ? 'none' : 'block';
}

function dismissIntro(){
  localStorage.setItem('stIntroSeen','1');
  const el=document.getElementById('introOverlay');
  if(el){ el.style.opacity='0'; el.style.transition='opacity .5s'; setTimeout(()=>{el.style.display='none';el.style.opacity='';el.style.transition='';},500); }
}

// Run on load
showIntroIfNeeded();

// GRADE BOOT (runs after all functions defined)
updateGradeBadges();
if(!localStorage.getItem('stState1'))setTimeout(()=>openGradeSheet(),900);


</script>
</body>
</html>
